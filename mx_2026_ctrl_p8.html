<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="description" content="Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…ØªØ·ÙˆØ±Ø© - Mona Academy">
    <title>Mona Academy | Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    
    <!-- Preconnect and Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* ================ CSS RESET & VARIABLES ================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6c5ce7;
            --primary-light: #8b7cf0;
            --primary-dark: #4a3bb5;
            --primary-gradient: linear-gradient(135deg, #6c5ce7, #4834d4);
            --secondary: #00b894;
            --secondary-light: #00d68f;
            --danger: #ff7675;
            --danger-dark: #e74c3c;
            --warning: #f1c40f;
            --gold: #ffd700;
            
            --bg-primary: #f8f9fc;
            --bg-secondary: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-muted: #b2bec3;
            --border-color: #e9ecef;
            --border-dark: #dfe6e9;
            
            --sidebar-bg: #ffffff;
            --sidebar-width: 280px;
            --header-height: 70px;
            --mobile-header-height: 70px;
            
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            --card-shadow-hover: 0 15px 40px rgba(108, 92, 231, 0.15);
            --modal-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius-sm: 10px;
            --border-radius-md: 15px;
            --border-radius-lg: 20px;
            --border-radius-xl: 30px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ================ SCROLLBAR ================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ================ PROGRESS INDICATOR ================ */
        .progress-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            z-index: 10001;
            transform: scaleX(0);
            transform-origin: 0 0;
            transition: transform 0.3s ease;
        }

        .progress-indicator.loading {
            transform: scaleX(1);
        }

        /* ================ OFFLINE INDICATOR ================ */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--danger);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            z-index: 10000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-indicator.show {
            transform: translateY(0);
        }

        /* ================ TOAST ================ */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            pointer-events: none;
        }

        .toast-message {
            background: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s;
            border-right: 4px solid var(--secondary);
            font-weight: 500;
            pointer-events: auto;
            max-width: 350px;
        }

        .toast-message.error {
            border-right-color: var(--danger);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ================ LOADING ================ */
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(108, 92, 231, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        /* ================ SKELETON ================ */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 10px;
            min-height: 100px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ================ TOUCH FEEDBACK ================ */
        .touch-feedback {
            position: relative;
            overflow: hidden;
        }
        
        .touch-feedback::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .touch-feedback:active::after {
            animation: ripple 0.3s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        /* ================ MOBILE HEADER ================ */
        .mobile-header {
            display: none;
            background: rgba(17, 20, 23, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1001;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            flex-shrink: 0;
            height: var(--mobile-header-height);
        }
        
        .mobile-header span {
            font-size: 1.3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #fff, #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .mobile-header i {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 12px;
            transition: 0.3s;
            background: rgba(255,255,255,0.1);
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-header i:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* ================ WRAPPER ================ */
        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* ================ SIDEBAR ================ */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1a1f2b, #0f1219);
            color: white;
            padding: 30px 15px;
            position: fixed;
            height: 100vh;
            right: 0;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: -10px 0 30px rgba(0,0,0,0.3);
            border-left: 1px solid rgba(255,255,255,0.05);
        }

        .sidebar::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #2d3436;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .sidebar-header {
            font-size: 26px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #fff, var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-bottom: 2px solid rgba(108, 92, 231, 0.3);
            padding-bottom: 20px;
            letter-spacing: 1px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 8px;
            color: #a4b0be;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            min-height: 44px;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: rgba(108, 92, 231, 0.2);
            transition: 0.3s;
            z-index: -1;
        }

        .nav-link:hover::before,
        .nav-link.active::before {
            width: 100%;
        }

        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            transform: translateX(-5px);
            box-shadow: 0 10px 25px rgba(108, 92, 231, 0.4);
        }

        .nav-link i {
            width: 25px;
            text-align: center;
        }

        .badge-count {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 22px;
            text-align: center;
            margin-right: auto;
        }

        .sidebar-footer {
            margin-top: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 20px;
        }

        .logout-link {
            color: var(--danger) !important;
        }

        .logout-link:hover {
            background: linear-gradient(135deg, var(--danger), var(--danger-dark)) !important;
            color: white !important;
        }

        /* ================ MAIN CONTENT ================ */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            height: 100vh;
            overflow-y: auto;
            padding: 30px;
            transition: margin-right 0.4s ease;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }

        @media (max-width: 992px) {
            .mobile-header {
                display: flex;
            }
            
            .sidebar {
                right: -300px;
            }
            
            .sidebar.open {
                right: 0;
                box-shadow: -5px 0 30px rgba(0,0,0,0.5);
            }
            
            .main-content {
                margin-right: 0;
                height: calc(100vh - var(--mobile-header-height));
                padding: 20px;
            }
            
            .overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(5px);
            }
            
            .overlay.active {
                display: block;
            }
        }

        /* ================ ADMIN SECTIONS ================ */
        .admin-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .admin-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ================ CARDS ================ */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 60px rgba(108, 92, 231, 0.2);
        }
        
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light), #a29bfe);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            font-size: 1.6rem;
            font-weight: 800;
            position: relative;
        }

        .section-header h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 0;
            width: 50px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        /* ================ GRID SYSTEM ================ */
        .grid-system {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        /* ================ STATS CARDS ================ */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .analytics-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
        }
        
        .analytics-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 60px rgba(108, 92, 231, 0.2);
        }
        
        .analytics-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.2rem;
            box-shadow: 0 10px 20px rgba(108,92,231,0.3);
        }
        
        .analytics-info h4 {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .analytics-info .number {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ================ CHARTS ================ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .chart-container {
            height: 250px;
            position: relative;
        }

        /* ================ TABLES ================ */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            border-radius: 20px;
            border: 1px solid rgba(108, 92, 231, 0.1);
            margin-top: 20px;
            background: white;
            max-height: 500px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        @media (max-width: 768px) {
            table {
                min-width: 600px;
            }
            
            th, td {
                padding: 12px 8px;
                font-size: 0.85rem;
            }
            
            .student-id-display {
                font-size: 0.75rem;
                padding: 4px 10px;
            }
        }

        @media (max-width: 480px) {
            table {
                min-width: 500px;
            }
            
            th, td {
                padding: 10px 6px;
                font-size: 0.8rem;
            }
            
            .student-id-display {
                font-size: 0.7rem;
                padding: 3px 8px;
            }
            
            .badge-grade, .progress-badge {
                font-size: 0.7rem;
                padding: 3px 8px;
            }
            
            .btn-icon {
                min-width: 36px;
                min-height: 36px;
            }
        }

        th {
            text-align: right;
            padding: 18px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-size: 0.9rem;
            font-weight: 700;
            color: #2d3436;
            border-bottom: 3px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(108, 92, 231, 0.1);
            transition: 0.2s;
        }

        tr {
            transition: 0.3s;
        }

        tr:hover td {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.05), rgba(108, 92, 231, 0.02));
        }

        /* ================ BADGES ================ */
        .badge-grade {
            background: var(--primary-gradient);
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .badge-success {
            background: linear-gradient(135deg, var(--secondary), #00b894);
            color: white;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .student-id-display {
            background: linear-gradient(135deg, #f0eeff, #e5e2ff);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
            border: 2px solid var(--primary);
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(108,92,231,0.2);
            white-space: nowrap;
        }

        .progress-badge {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
            display: inline-block;
            white-space: nowrap;
        }

        /* ================ BUTTONS ================ */
        .btn {
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Cairo';
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
            min-height: 44px;
            min-width: 44px;
        }

        .btn-main {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #00b894);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f39c12);
            color: #2d3436;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            min-height: 38px;
            min-width: 38px;
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            padding: 0;
            border-radius: 8px;
        }

        .btn-view { background: var(--primary); color: white; }
        .btn-edit { background: var(--warning); color: #2d3436; }
        .btn-delete { background: var(--danger); color: white; }

        /* ================ FORMS ================ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            border-radius: 15px;
            border: 2px solid rgba(108, 92, 231, 0.1);
            margin-top: 8px;
            font-family: 'Cairo';
            outline: none;
            background: rgba(255,255,255,0.9);
            color: #2d3436;
            transition: 0.3s;
            font-size: 0.95rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.15);
            background: white;
        }

        select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236c5ce7' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 18px center;
            padding-left: 45px;
        }

        /* ================ LIST ITEMS ================ */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-radius: 20px;
            margin-bottom: 10px;
            border-right: 6px solid var(--primary);
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }

        .list-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 10px 25px rgba(108,92,231,0.1);
        }

        .list-item .item-actions {
            display: flex;
            gap: 8px;
        }

        /* ================ MODAL ================ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            width: 100%;
            max-width: 1000px;
            border-radius: 40px;
            padding: 35px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 40px 80px rgba(0,0,0,0.3);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .close-modal-btn {
            position: absolute;
            left: 25px;
            top: 25px;
            background: var(--danger);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            border: none;
            font-size: 1.2rem;
            z-index: 10;
        }

        .close-modal-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--danger-dark);
        }

        /* ================ IMAGE UPLOAD ================ */
        .image-preview {
            display: none;
            margin: 15px 0;
            text-align: center;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 15px;
            border: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(108,92,231,0.3);
        }

        .file-input {
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 2px dashed var(--primary);
            cursor: pointer;
            margin: 10px 0;
        }

        .file-input:hover {
            background: #f0eeff;
        }

        .imgbb-info {
            background: linear-gradient(135deg, #f0eeff, #e5e2ff);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--primary);
            border-right: 3px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ================ QUESTION CARD ================ */
        .edit-question-card {
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(108,92,231,0.1);
            position: relative;
            transition: 0.3s;
        }

        .edit-question-card:hover {
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(108,92,231,0.1);
        }

        .edit-question-card .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed rgba(108,92,231,0.2);
        }

        .edit-question-card .question-number {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .edit-question-card .question-actions {
            display: flex;
            gap: 10px;
        }

        .edit-question-card .question-actions i {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: 0.3s;
            font-size: 1rem;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-question-card .question-actions .fa-copy {
            background: rgba(108,92,231,0.1);
            color: var(--primary);
        }

        .edit-question-card .question-actions .fa-trash {
            background: rgba(255,118,117,0.1);
            color: var(--danger);
        }

        .edit-question-card .question-actions i:hover {
            transform: scale(1.2);
        }

        .edit-question-card .question-actions .fa-copy:hover {
            background: var(--primary);
            color: white;
        }

        .edit-question-card .question-actions .fa-trash:hover {
            background: var(--danger);
            color: white;
        }

        .mcq-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .mcq-options > div {
            background: rgba(108,92,231,0.03);
            padding: 15px;
            border-radius: 15px;
        }

        .mcq-options label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
            font-weight: bold;
        }

        /* ================ PREVIEW EXAM ================ */
        .preview-exam {
            background: white;
            border-radius: 30px;
            padding: 30px;
            direction: rtl;
        }

        .preview-exam h2 {
            color: var(--primary);
            margin-bottom: 30px;
            text-align: center;
            font-weight: 900;
        }

        .preview-question {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border-right: 6px solid var(--primary);
        }

        .preview-question h4 {
            color: #2d3436;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .preview-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-option {
            padding: 15px 20px;
            background: white;
            border-radius: 15px;
            border: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.3s;
        }

        .preview-option.correct {
            background: #d4edda;
            border-color: var(--secondary);
        }

        .preview-option .correct-badge {
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            margin-right: auto;
        }

        .preview-tf {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .preview-tf-option {
            flex: 1;
            padding: 20px;
            text-align: center;
            border-radius: 15px;
            background: white;
            border: 2px solid #eee;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .preview-tf-option.correct {
            background: #d4edda;
            border-color: var(--secondary);
        }

        /* ================ LOADER ================ */
        #guard-loader {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        #guard-loader i {
            animation: spin 1.5s linear infinite, pulse 2s ease-in-out infinite;
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* ================ LEADERBOARD ================ */
        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 25px;
            border-bottom: 1px solid rgba(108,92,231,0.1);
            transition: 0.3s;
            font-weight: 600;
        }
        
        .leaderboard-row:hover {
            background: linear-gradient(135deg, rgba(108,92,231,0.05), rgba(108,92,231,0.02));
            transform: translateX(-5px);
        }
        
        .leaderboard-row:first-child {
            background: linear-gradient(135deg, var(--gold), #f39c12);
            color: #2d3436;
            border-radius: 15px 15px 0 0;
            font-weight: 900;
        }
        
        .leaderboard-rank {
            font-weight: 900;
            color: var(--primary);
            margin-left: 15px;
        }

        /* ================ EMPTY STATE ================ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-lg);
            background: white;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary-light);
        }

        /* ================ UTILITY CLASSES ================ */
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-1 { gap: 10px; }
        .gap-2 { gap: 20px; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-100 { width: 100%; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .text-center { text-align: center; }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--secondary); }
        .text-danger { color: var(--danger); }

        /* ================ MOBILE RESPONSIVE ================ */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
                margin: 10px;
            }
            
            .mcq-options {
                grid-template-columns: 1fr;
            }
            
            .grid-system {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .section-header h2 {
                font-size: 1.4rem;
            }
            
            .section-header button {
                width: 100%;
            }
            
            .btn {
                width: 100%;
            }
            
            .analytics-card {
                flex-direction: column;
                text-align: center;
            }
            
            .list-item {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .list-item .item-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .student-id-display {
                font-size: 0.75rem;
                padding: 4px 10px;
            }
            
            .badge-grade, .progress-badge {
                font-size: 0.7rem;
                padding: 3px 8px;
            }
        }
        
        @media (max-width: 480px) {
            .analytics-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .analytics-info .number {
                font-size: 1.8rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .search-box {
                margin-bottom: 12px;
            }
        }

        /* ================ PRINT STYLES ================ */
        @media print {
            .sidebar, .mobile-header, .overlay, .btn, .modal, .toast-container, .offline-indicator, .progress-indicator {
                display: none !important;
            }
            
            .main-content {
                margin-right: 0;
                padding: 0;
                height: auto;
                overflow: visible;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .table-container {
                max-height: none;
                overflow: visible;
            }
        }
    </style>
</head>
<body>
    <!-- Progress Indicator -->
    <div id="progressIndicator" class="progress-indicator"></div>
    
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        <i class="fas fa-wifi-slash"></i>
        Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <span>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ù€Ù†Ù‰</span>
        <div style="display: flex; gap: 10px;">
            <i class="fas fa-bars fa-lg" onclick="toggleSidebar()"></i>
        </div>
    </div>
    
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Loading Guard -->
    <div id="guard-loader">
        <i class="fas fa-user-shield"></i>
        <h3 style="margin-top: 20px; font-size: 1.5rem;">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©...</h3>
        <p style="opacity: 0.8;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>
    </div>

    <!-- Main App -->
    <div class="wrapper" id="adminApp" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">Mona Academy</div>
            
            <div class="nav-link touch-feedback" onclick="showSection('coursesSection', this)">
                <i class="fas fa-th-large"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('examsSection', this)">
                <i class="fas fa-edit"></i> Ù…ØµÙ†Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('studentSearchSection', this)">
                <i class="fas fa-search"></i> Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('studentsSection', this)">
                <i class="fas fa-user-graduate"></i> Ø§Ù„Ø·Ù„Ø§Ø¨
                <span class="badge-count" id="studentCount">0</span>
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('resultsSection', this)">
                <i class="fas fa-poll-h"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                <span class="badge-count" id="resultsCount">0</span>
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('accessLogsSection', this)">
                <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                <span class="badge-count" id="logsCount">0</span>
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('notificationsSection', this)">
                <i class="fas fa-bell"></i> Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                <span class="badge-count" id="notificationsCount">0</span>
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('reviewsSection', this)">
                <i class="fas fa-star"></i> Ø§Ù„Ø¢Ø±Ø§Ø¡
                <span class="badge-count" id="reviewsCount">0</span>
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('perfectScoresSection', this)">
                <i class="fas fa-trophy"></i> Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                <span class="badge-count" id="perfectScoresCount">0</span>
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('adminsSection', this)">
                <i class="fas fa-user-shield"></i> Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡
            </div>
            <div class="nav-link touch-feedback" onclick="showSection('analyticsSection', this)">
                <i class="fas fa-chart-line"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
            </div>
            
            <div class="sidebar-footer">
                <a href="index.html" class="nav-link touch-feedback" style="color: var(--secondary);">
                    <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹
                </a>
                <div class="nav-link touch-feedback logout-link" onclick="logout()">
                    <i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Courses Section -->
            <section id="coursesSection" class="admin-section active">
                <div class="card">
                    <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <i class="fas fa-plus-circle" style="color: var(--primary);"></i>
                        Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯
                    </h3>
                    
                    <div class="grid-system">
                        <input type="text" id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³" inputmode="text">
                        <input type="url" id="cImgUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" dir="ltr" inputmode="url">
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
                        <select id="cGrade">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
                            <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ:</label>
                        <input type="file" id="cImageFile" accept="image/*" class="file-input">
                        <div id="imagePreview" class="image-preview">
                            <img id="previewImg" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
                        </div>
                    </div>
                    
                    <button class="btn btn-main touch-feedback" style="margin-top:20px;" onclick="addCourse()">
                        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ±Ø³
                    </button>
                </div>
                
                <div id="coursesGrid" class="grid-system">
                    <div class="skeleton"></div>
                    <div class="skeleton"></div>
                    <div class="skeleton"></div>
                </div>
            </section>

            <!-- Students Section -->
            <section id="studentsSection" class="admin-section">
                <div class="card">
                    <div class="section-header">
                        <h2><i class="fas fa-users"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                        <input type="text" id="studentSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." style="max-width: 300px;">
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                                    <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
                                    <th>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</th>
                                    <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="studentList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Exams Section -->
            <section id="examsSection" class="admin-section">
                <div class="card">
                    <h3><i class="fas fa-pen"></i> Ø¨Ù†Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
                    <select id="exFolderSelect" class="mt-1"></select>
                    <input type="text" id="exTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±" class="mt-1">
                    
                    <div id="questionsArea" style="margin-top: 20px;"></div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn btn-secondary touch-feedback" onclick="addNewQuestion('mcq')" style="flex:1; min-width: 150px;">
                            <i class="fas fa-list"></i> Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
                        </button>
                        <button class="btn btn-warning touch-feedback" onclick="addNewQuestion('tf')" style="flex:1; min-width: 150px;">
                            <i class="fas fa-check-circle"></i> ØµØ­/Ø®Ø·Ø£
                        </button>
                    </div>
                    
                    <button class="btn btn-main touch-feedback" style="margin-top: 25px;" onclick="saveFinalExam()">
                        <i class="fas fa-cloud-upload-alt"></i> Ù†Ø´Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
                    </button>
                </div>
            </section>

            <!-- Student Search Section -->
            <section id="studentSearchSection" class="admin-section">
                <div class="card">
                    <h3><i class="fas fa-search"></i> Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù… Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <p style="color: #666; margin-bottom: 20px;">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</p>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="advancedSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨..." style="flex: 3; min-width: 200px;">
                        <button class="btn btn-main touch-feedback" onclick="performAdvancedSearch()">
                            <i class="fas fa-search"></i> Ø¨Ø­Ø«
                        </button>
                        <button class="btn btn-danger touch-feedback" onclick="clearAdvancedSearch()">
                            <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </div>
                
                <div id="searchResults" style="display: none;">
                    <div class="card">
                        <div class="flex justify-between align-center">
                            <h3><i class="fas fa-user-graduate"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                        </div>
                        <div id="studentInfo" class="grid-system" style="margin-top: 20px;"></div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-book"></i> Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h3>
                        <div id="studentSubscriptions"></div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-video"></i> Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</h3>
                        <div id="studentWatchedVideos"></div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-poll"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h3>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th></tr></thead>
                                <tbody id="studentExamResults"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-clock"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª</h3>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Ø§Ù„ÙƒÙˆØ±Ø³</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th></tr></thead>
                                <tbody id="studentAccessLog"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section id="resultsSection" class="admin-section">
                <div class="card">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-bar"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
                        <input type="text" id="resultSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." style="max-width: 300px;">
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                    <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                    <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                    <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="resultsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Access Logs Section -->
            <section id="accessLogsSection" class="admin-section">
                <div class="card">
                    <div class="section-header">
                        <h2><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                        <input type="text" id="logSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." style="max-width: 300px;">
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„ÙƒÙˆØ±Ø³</th>
                                    <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="logsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Notifications Section -->
            <section id="notificationsSection" class="admin-section">
                <div class="card">
                    <div class="section-header">
                        <h2><i class="fas fa-bell"></i> Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                        <input type="text" id="notificationSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." style="max-width: 300px;">
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„ÙƒÙˆØ±Ø³</th>
                                    <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="notificationsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Reviews Section -->
            <section id="reviewsSection" class="admin-section">
                <div class="card">
                    <h2><i class="fas fa-star"></i> Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„Ø±Ø£ÙŠ</th>
                                    <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="reviewsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Perfect Scores Section -->
            <section id="perfectScoresSection" class="admin-section">
                <div class="card">
                    <div class="section-header">
                        <h2><i class="fas fa-trophy" style="color: var(--gold);"></i> Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
                        <input type="text" id="perfectScoreSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." style="max-width: 300px;">
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th>
                                    <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="perfectScoresList"></tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 15px; border-right: 5px solid var(--gold);">
                        <i class="fas fa-info-circle" style="color: var(--gold); margin-left: 8px;"></i>
                        <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø­Ø°Ù Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø³ÙŠØ³Ù…Ø­ Ù„Ù‡ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
                    </div>
                </div>
            </section>

            <!-- Admins Section -->
            <section id="adminsSection" class="admin-section">
                <div class="card">
                    <h3><i class="fas fa-user-shield"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ± Ø¬Ø¯ÙŠØ¯</h3>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="email" id="newAdminEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="flex: 2; min-width: 200px;">
                        <input type="text" id="newAdminName" placeholder="Ø§Ù„Ø§Ø³Ù…" style="flex: 1; min-width: 150px;">
                        <button class="btn btn-secondary touch-feedback" onclick="addAdmin()">
                            <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ©
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</h3>
                    <div id="adminsList"></div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analyticsSection" class="admin-section">
                <div class="card">
                    <h2><i class="fas fa-chart-line"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                    <div class="analytics-grid" id="analyticsSummary"></div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-bar" style="color: var(--primary);"></i> Ø£ÙƒØ«Ø± Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ù…Ø´Ø§Ù‡Ø¯Ø©</h3>
                        <div class="chart-container">
                            <canvas id="topCoursesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-pie" style="color: var(--secondary);"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                        <div class="chart-container">
                            <canvas id="examScoresChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3><i class="fas fa-calendar-alt" style="color: var(--warning);"></i> Ù†Ø´Ø§Ø· Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <div class="chart-container">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-crown" style="color: var(--gold);"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
                    <div id="adminLeaderboard" class="leaderboard-table"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Course Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn touch-feedback" onclick="closeModal()"><i class="fas fa-times"></i></button>
            
            <h3 style="color: var(--primary); margin-bottom: 25px;">
                <i class="fas fa-edit"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³
            </h3>
            
            <div class="card" style="background: linear-gradient(145deg, #f8f9fa, #ffffff); margin-bottom: 25px;">
                <label style="font-weight: bold;">Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³:</label>
                <input type="text" id="editNameField" style="margin-bottom: 15px;">
                
                <label style="font-weight: bold;">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
                <select id="editGradeField" style="margin-bottom: 15px;">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
                    <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                </select>
                
                <label style="font-weight: bold;">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©:</label>
                <input type="url" id="editImgField" placeholder="https://..." dir="ltr" style="margin-bottom: 15px;">
                
                <label style="font-weight: bold;">Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label>
                <input type="file" id="editImageFile" accept="image/*" class="file-input">
                <div id="editImagePreview" class="image-preview">
                    <img id="editPreviewImg" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
                </div>
                
                <button class="btn btn-main touch-feedback" id="saveBasicBtn" onclick="updateCourseBasic()" style="margin-top: 15px;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>
            
            <h4 style="margin: 20px 0 15px;"><i class="fas fa-plus-circle" style="color: var(--secondary);"></i> Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="text" id="vTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">
                <input type="text" id="vUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨" dir="ltr">
            </div>
            <input type="number" id="vOrder" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨ (1, 2, ..)" style="margin-top: 15px;">
            
            <button class="btn btn-secondary touch-feedback" style="margin-top:15px; width:100%;" onclick="addVideoToCourse()">
                <i class="fas fa-video"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            </button>
            
            <h4 style="margin: 25px 0 15px;"><i class="fas fa-list"></i> Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
            
            <div style="margin-bottom: 20px;">
                <h5 style="color: var(--primary); margin-bottom: 10px;">
                    <i class="fas fa-video"></i> Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:
                </h5>
                <div id="vListContainer"></div>
            </div>
            
            <div>
                <h5 style="color: var(--warning); margin-bottom: 10px;">
                    <i class="fas fa-file-alt"></i> Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:
                </h5>
                <div id="qListContainer"></div>
            </div>
        </div>
    </div>

    <!-- Edit Video Modal -->
    <div id="editVideoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-modal-btn touch-feedback" onclick="closeVideoModal()"><i class="fas fa-times"></i></button>
            
            <h3 style="color: var(--primary); margin-bottom: 25px;">
                <i class="fas fa-video"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            </h3>
            
            <input type="hidden" id="editVideoCourseId">
            <input type="hidden" id="editVideoId">
            
            <label style="font-weight: bold;">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:</label>
            <input type="text" id="editVideoTitle" style="margin-bottom: 20px;">
            
            <label style="font-weight: bold;">Ø±Ø§Ø¨Ø· Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨:</label>
            <input type="text" id="editVideoUrl" dir="ltr" style="margin-bottom: 20px;">
            
            <label style="font-weight: bold;">Ø§Ù„ØªØ±ØªÙŠØ¨:</label>
            <input type="number" id="editVideoOrder" style="margin-bottom: 25px;">
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-main touch-feedback" onclick="saveVideoChanges()" style="flex: 2;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸
                </button>
                <button class="btn btn-danger touch-feedback" onclick="closeVideoModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Exam Modal -->
    <div id="editExamModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-modal-btn touch-feedback" onclick="closeExamModal()"><i class="fas fa-times"></i></button>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
                </h3>
                <button class="btn btn-secondary btn-sm touch-feedback" onclick="previewExam()">
                    <i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©
                </button>
            </div>
            
            <input type="hidden" id="editExamCourseId">
            <input type="hidden" id="editExamId">
            
            <div class="card" style="background: linear-gradient(145deg, #f8f9fa, #ffffff); margin-bottom: 25px;">
                <label style="font-weight: bold;">Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</label>
                <input type="text" id="editExamName" style="margin-bottom: 15px;">
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px;">
                <h4><i class="fas fa-question-circle"></i> Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-sm touch-feedback" onclick="addEditQuestion('mcq')">
                        <i class="fas fa-plus"></i> Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
                    </button>
                    <button class="btn btn-warning btn-sm touch-feedback" onclick="addEditQuestion('tf')">
                        <i class="fas fa-plus"></i> ØµØ­/Ø®Ø·Ø£
                    </button>
                </div>
            </div>
            
            <div id="editQuestionsArea" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px; flex-wrap: wrap;">
                <button class="btn btn-main touch-feedback" onclick="saveExamChanges()" style="flex: 2; min-width: 200px;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
                <button class="btn btn-danger touch-feedback" onclick="deleteExam()" style="flex: 1; min-width: 150px;">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Exam Modal -->
    <div id="previewExamModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-modal-btn touch-feedback" onclick="closePreviewModal()"><i class="fas fa-times"></i></button>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary);">
                    <i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
                </h3>
            </div>
            
            <div id="previewExamContent" class="preview-exam" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script type="module">
        // ================ FIREBASE IMPORTS ================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ================ CONFIG ================
        const firebaseConfig = {
            apiKey: "AIzaSyA8KQAQgu4nIiomoDpoTLnBz_uAtab63sY",
            authDomain: "monaacademy-cd983.firebaseapp.com",
            databaseURL: "https://monaacademy-cd983-default-rtdb.firebaseio.com",
            projectId: "monaacademy-cd983",
            storageBucket: "monaacademy-cd983.appspot.com",
            appId: "1:410646694761:web:bea49c51d3b0ff5eb9cbf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // ================ CONSTANTS ================
        const IMGBB_API_KEY = "049eb1f0e45afcb93f3c45a1400a29ef";
        const SUPER_ADMIN_EMAIL = "mrsmonakamel6@gmail.com";
        
        // ================ GLOBAL VARIABLES ================
        let activeCID = "";
        let allStudents = {};
        let allResults = {};
        let allLogs = {};
        let allNotifications = {};
        let allCourseAccess = {};
        let allFolders = {};
        let allSubscriptionNotifications = {};
        let allReviews = {};
        let allAdmins = {};
        let charts = {};
        let dataListeners = new Map();
        let currentUser = null;
        let currentStudentData = null;
        let currentStudentUid = null;
        let currentEditingExam = null;

        // ================ PROGRESS ================
        function startProgress() {
            document.getElementById('progressIndicator')?.classList.add('loading');
        }
        
        function stopProgress() {
            document.getElementById('progressIndicator')?.classList.remove('loading');
        }

        // ================ OFFLINE ================
        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (indicator) {
                indicator.classList.toggle('show', !navigator.onLine);
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // ================ ESCAPE HTML ================
        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        // ================ TOAST ================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer') || (() => {
                const div = document.createElement('div');
                div.id = 'toastContainer';
                div.className = 'toast-container';
                document.body.appendChild(div);
                return div;
            })();
            
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${escapeHTML(message)}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        window.showToast = showToast;

        // ================ UPLOAD TO IMGBB ================
        async function uploadToImgBB(file) {
            if (!file) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
            if (!file.type.startsWith('image/')) throw new Error('Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ ØµÙˆØ±Ø©');
            if (file.size > 5 * 1024 * 1024) throw new Error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)');
            
            const formData = new FormData();
            formData.append('key', IMGBB_API_KEY);
            formData.append('image', file);
            
            const response = await fetch('https://api.imgbb.com/1/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) return data.data.url;
            throw new Error(data.error?.message || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
        }

        // ================ VALIDATE IMAGE URL ================
        function isValidImageUrl(url) {
            try {
                const urlObj = new URL(url);
                const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
                const path = urlObj.pathname.toLowerCase();
                return validExtensions.some(ext => path.endsWith(ext));
            } catch {
                return false;
            }
        }

        // ================ CLEANUP ================
        function cleanupListeners() {
            dataListeners.forEach((listener, key) => {
                if (listener?.ref && listener?.callback) {
                    off(listener.ref, 'value', listener.callback);
                }
            });
            dataListeners.clear();
        }

        // ================ SIDEBAR ================
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar?.classList.toggle('open');
            overlay?.classList.toggle('active');
        };

        window.closeSidebar = function() {
            document.getElementById('sidebar')?.classList.remove('open');
            document.getElementById('overlay')?.classList.remove('active');
        };

        // ================ SHOW SECTION ================
        window.showSection = function(sectionId, element) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            if (element) element.classList.add('active');
            
            // Close sidebar on mobile after selection
            if (window.innerWidth <= 992) {
                closeSidebar();
            }
            
            if (sectionId === 'analyticsSection') {
                setTimeout(loadAnalytics, 100);
            }
        };

        // ================ LOGOUT ================
        window.logout = function() {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        };

        // ================ AUTH ================
        onAuthStateChanged(auth, async user => {
            if (user) {
                try {
                    startProgress();
                    currentUser = user;
                    
                    const isSuperAdmin = user.email === SUPER_ADMIN_EMAIL;
                    const adminsSnap = await get(ref(db, 'admins'));
                    const admins = adminsSnap.val() || {};
                    allAdmins = admins;
                    
                    const isAdmin = isSuperAdmin || Object.values(admins).some(admin => 
                        admin.email?.toLowerCase() === user.email?.toLowerCase()
                    );
                    
                    if (isAdmin) {
                        document.getElementById('guard-loader').style.display = 'none';
                        document.getElementById('adminApp').style.display = 'flex';
                        syncData();
                        showToast('âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
                    } else {
                        showToast('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
                        setTimeout(() => logout(), 2000);
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                    showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
                } finally {
                    stopProgress();
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // ================ SYNC DATA ================
        function syncData() {
            cleanupListeners();
            startProgress();
            
            const addListener = (name, refPath, callback) => {
                const dbRef = ref(db, refPath);
                const listener = onValue(dbRef, (snapshot) => {
                    callback(snapshot.val() || {});
                });
                dataListeners.set(name, { ref: dbRef, callback: listener });
            };

            addListener('students', 'students', (data) => {
                allStudents = data;
                renderStudents(data);
                updateCounts();
                loadLeaderboard();
            });

            addListener('folders', 'folders', (data) => {
                allFolders = data;
                renderCourses(data);
                fillDropdowns(data);
            });

            addListener('results', 'quiz_results', (data) => {
                allResults = data;
                renderResults(data);
                renderPerfectScores(data, allStudents);
                updateCounts();
                loadLeaderboard();
            });

            addListener('logs', 'course_access_logs', (data) => {
                allLogs = data;
                renderAccessLogs(data);
                updateCounts();
            });

            addListener('notifications', 'course_access_notifications', (data) => {
                allNotifications = data;
                renderNotifications(data);
                updateCounts();
            });

            addListener('subscriptions', 'subscription_notifications', (data) => {
                allSubscriptionNotifications = data;
                updateCounts();
            });

            addListener('reviews', 'reviews', (data) => {
                allReviews = data;
                renderReviews(data);
                updateCounts();
            });

            addListener('admins', 'admins', (data) => {
                allAdmins = data;
                renderAdmins(data);
            });

            addListener('access', 'student_course_access', (data) => {
                allCourseAccess = data;
            });
            
            setTimeout(stopProgress, 1000);
        }

        // ================ UPDATE COUNTS ================
        function updateCounts() {
            const counts = {
                studentCount: Object.keys(allStudents).length,
                resultsCount: Object.keys(allResults).length,
                logsCount: Object.keys(allLogs).length,
                notificationsCount: Object.keys(allNotifications).length,
                reviewsCount: Object.keys(allReviews).length,
                perfectScoresCount: Object.values(allResults).filter(r => r.score === r.total && r.score > 0).length
            };
            
            Object.entries(counts).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });
        }

        // ================ RENDER STUDENTS ================
        function renderStudents(students) {
            const tbody = document.getElementById('studentList');
            if (!tbody) return;
            
            let html = '';
            if (students && Object.keys(students).length > 0) {
                Object.entries(students)
                    .sort((a, b) => (a[1].name || '').localeCompare(b[1].name || ''))
                    .forEach(([uid, s]) => {
                        const subCount = s.subscriptions ? Object.keys(s.subscriptions).length : 0;
                        html += `<tr>
                            <td><strong>${escapeHTML(s.name || '')}</strong></td>
                            <td><span class="student-id-display">${escapeHTML(s.shortId || '')}</span></td>
                            <td><span class="badge-grade">${escapeHTML(s.grade || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</span></td>
                            <td>${escapeHTML(s.whatsapp || 'â€”')}</td>
                            <td>${subCount}</td>
                            <td>${s.points || 0}</td>
                            <td><button class="btn-delete btn-icon" onclick="delData('students/${uid}')"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    });
            } else {
                html = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</td></tr>';
            }
            tbody.innerHTML = html;
        }

        window.filterStudents = function() {
            const search = document.getElementById('studentSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#studentList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };
        document.getElementById('studentSearch')?.addEventListener('keyup', filterStudents);

        // ================ RENDER RESULTS ================
        function renderResults(results) {
            const tbody = document.getElementById('resultsList');
            if (!tbody) return;
            
            let html = '';
            if (results && Object.keys(results).length > 0) {
                Object.entries(results)
                    .sort((a, b) => (b[1].time || '').localeCompare(a[1].time || ''))
                    .forEach(([id, r]) => {
                        const percentage = Math.round((r.score / r.total) * 100);
                        html += `<tr>
                            <td>${escapeHTML(r.student || '')}</td>
                            <td><span class="student-id-display">${escapeHTML(r.studentId || '')}</span></td>
                            <td>${escapeHTML(r.quiz || '')}</td>
                            <td>${r.score}/${r.total}</td>
                            <td><span class="progress-badge">${percentage}%</span></td>
                            <td>${escapeHTML(r.time || '')}</td>
                            <td><button class="btn-delete btn-icon" onclick="delData('quiz_results/${id}')"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    });
            } else {
                html = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
            }
            tbody.innerHTML = html;
        }

        window.filterResults = function() {
            const search = document.getElementById('resultSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#resultsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };
        document.getElementById('resultSearch')?.addEventListener('keyup', filterResults);

        // ================ RENDER ACCESS LOGS ================
        function renderAccessLogs(logs) {
            const tbody = document.getElementById('logsList');
            if (!tbody) return;
            
            let html = '';
            if (logs && Object.keys(logs).length > 0) {
                Object.entries(logs)
                    .sort((a, b) => (b[1].time || '').localeCompare(a[1].time || ''))
                    .forEach(([id, l]) => {
                        html += `<tr>
                            <td>${escapeHTML(l.studentName || '')}</td>
                            <td><span class="student-id-display">${escapeHTML(l.studentId || '')}</span></td>
                            <td>${escapeHTML(l.courseName || '')}</td>
                            <td>${escapeHTML(l.time || '')}</td>
                            <td><button class="btn-delete btn-icon" onclick="delData('course_access_logs/${id}')"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    });
            } else {
                html = '<tr><td colspan="5" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
            }
            tbody.innerHTML = html;
        }

        window.filterLogs = function() {
            const search = document.getElementById('logSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#logsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };
        document.getElementById('logSearch')?.addEventListener('keyup', filterLogs);

        // ================ RENDER NOTIFICATIONS ================
        function renderNotifications(notifications) {
            const tbody = document.getElementById('notificationsList');
            if (!tbody) return;
            
            let html = '';
            if (notifications && Object.keys(notifications).length > 0) {
                Object.entries(notifications)
                    .sort((a, b) => (b[1].time || '').localeCompare(a[1].time || ''))
                    .forEach(([id, n]) => {
                        html += `<tr>
                            <td>${escapeHTML(n.studentName || '')}</td>
                            <td><span class="student-id-display">${escapeHTML(n.studentId || '')}</span></td>
                            <td>${escapeHTML(n.courseName || '')}</td>
                            <td>${escapeHTML(n.time || '')}</td>
                            <td><button class="btn-delete btn-icon" onclick="delData('course_access_notifications/${id}')"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    });
            } else {
                html = '<tr><td colspan="5" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</td></tr>';
            }
            tbody.innerHTML = html;
        }

        window.filterNotifications = function() {
            const search = document.getElementById('notificationSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#notificationsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };
        document.getElementById('notificationSearch')?.addEventListener('keyup', filterNotifications);

        // ================ RENDER REVIEWS ================
        function renderReviews(reviews) {
            const tbody = document.getElementById('reviewsList');
            if (!tbody) return;
            
            let html = '';
            if (reviews && Object.keys(reviews).length > 0) {
                Object.entries(reviews).forEach(([id, r]) => {
                    html += `<tr>
                        <td>${escapeHTML(r.student || '')}</td>
                        <td>${escapeHTML(r.text || '')}</td>
                        <td>${r.rating ? 'â˜…'.repeat(r.rating) : 'â€”'}</td>
                        <td><button class="btn-delete btn-icon" onclick="delData('reviews/${id}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            } else {
                html = '<tr><td colspan="4" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ø±Ø§Ø¡</td></tr>';
            }
            tbody.innerHTML = html;
        }

        // ================ RENDER ADMINS ================
        function renderAdmins(admins) {
            const adminsList = document.getElementById('adminsList');
            if (!adminsList) return;
            
            let html = '';
            if (admins && Object.keys(admins).length > 0) {
                Object.entries(admins).forEach(([id, a]) => {
                    const isSuper = a.email === SUPER_ADMIN_EMAIL;
                    html += `<div class="list-item">
                        <div>
                            <span style="font-weight:bold;">${escapeHTML(a.name || '')} ${isSuper ? '<span class="badge-grade">Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†</span>' : ''}</span>
                            <div style="color:#666; font-size:0.85rem;">${escapeHTML(a.email || '')}</div>
                        </div>
                        <div class="item-actions">
                            ${!isSuper ? `<button class="btn-delete btn-icon" onclick="removeAdmin('${id}')"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`;
                });
            } else {
                html = '<p class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø§Ø¡</p>';
            }
            adminsList.innerHTML = html;
        }

        // ================ RENDER PERFECT SCORES ================
        function renderPerfectScores(results, students) {
            const tbody = document.getElementById('perfectScoresList');
            if (!tbody) return;
            
            let html = '', index = 0;
            if (results) {
                Object.entries(results).forEach(([id, res]) => {
                    if (res.score === res.total && res.score > 0) {
                        html += `<tr>
                            <td>${escapeHTML(res.student || '')}</td>
                            <td><span class="student-id-display">${escapeHTML(res.studentId || '')}</span></td>
                            <td>${escapeHTML(res.quiz || '')}</td>
                            <td><span class="progress-badge">${res.score}/${res.total}</span></td>
                            <td>${escapeHTML(res.time || '')}</td>
                            <td><button class="btn-delete btn-icon" onclick="delData('quiz_results/${id}')"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                    }
                });
            }
            tbody.innerHTML = html || '<tr><td colspan="6" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ©</td></tr>';
        }

        window.filterPerfectScores = function() {
            const search = document.getElementById('perfectScoreSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#perfectScoresList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };
        document.getElementById('perfectScoreSearch')?.addEventListener('keyup', filterPerfectScores);

        // ================ RENDER COURSES ================
        function renderCourses(folders) {
            const grid = document.getElementById('coursesGrid');
            if (!grid) return;
            
            let html = '';
            if (folders && Object.keys(folders).length > 0) {
                Object.entries(folders).forEach(([id, f]) => {
                    const imgSrc = f.img || 'mona.jpg';
                    const stars = 'â˜…'.repeat(Math.min(5, Math.round(f.avgRating || 0))) + 'â˜†'.repeat(5 - Math.min(5, Math.round(f.avgRating || 0)));
                    
                    html += `<div class="card" style="text-align:center;">
                        <img src="${escapeHTML(imgSrc)}" style="width:100px; height:100px; border-radius:20px; object-fit:cover; border: 4px solid var(--primary); margin: 0 auto 15px;" onerror="this.src='mona.jpg'">
                        <h4 style="margin:10px 0;">${escapeHTML(f.name)}</h4>
                        <span class="badge-grade">${escapeHTML(f.grade || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</span>
                        <div style="margin:10px 0; color: var(--gold);">
                            ${stars} (${f.reviewCount || 0})
                        </div>
                        <div class="flex gap-1" style="justify-content: center;">
                            <button class="btn btn-main btn-sm" onclick='openEditModal("${id}", ${JSON.stringify(f).replace(/</g, '\\u003c')})'>
                                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="delData('folders/${id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                });
            } else {
                html = '<div class="empty-state"><i class="fas fa-book"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª</div>';
            }
            
            // Remove skeletons
            grid.querySelectorAll('.skeleton').forEach(el => el.remove());
            grid.innerHTML = html;
        }

        // ================ ADD COURSE ================
        window.addCourse = async function() {
            const name = document.getElementById('cName')?.value.trim();
            const grade = document.getElementById('cGrade')?.value;
            const imgUrl = document.getElementById('cImgUrl')?.value.trim();
            const imgFile = document.getElementById('cImageFile')?.files[0];
            
            if (!name) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
                return;
            }
            
            if (!grade) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', 'error');
                return;
            }
            
            let imageData = 'mona.jpg';
            
            if (imgFile) {
                try {
                    showToast('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'success');
                    imageData = await uploadToImgBB(imgFile);
                } catch (error) {
                    showToast('âŒ ' + error.message, 'error');
                    return;
                }
            } else if (imgUrl) {
                if (!isValidImageUrl(imgUrl)) {
                    showToast('âŒ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ .jpg, .png, .gif, Ø¥Ù„Ø®', 'error');
                    return;
                }
                try {
                    new URL(imgUrl);
                    imageData = imgUrl;
                } catch {
                    showToast('âŒ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                    return;
                }
            }
            
            try {
                startProgress();
                await push(ref(db, 'folders'), { 
                    name, 
                    img: imageData,
                    grade,
                    avgRating: 0, 
                    reviewCount: 0 
                });
                
                document.getElementById('cName').value = '';
                document.getElementById('cImgUrl').value = '';
                document.getElementById('cGrade').value = '';
                document.getElementById('cImageFile').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            } finally {
                stopProgress();
            }
        };

        // ================ OPEN EDIT MODAL ================
        window.openEditModal = async function(id, folderData) {
            activeCID = id;
            document.getElementById('editNameField').value = folderData.name || '';
            document.getElementById('editGradeField').value = folderData.grade || '';
            document.getElementById('editImgField').value = '';
            document.getElementById('editImageFile').value = '';
            document.getElementById('editImagePreview').style.display = 'none';
            
            try {
                startProgress();
                const [folderSnap, quizzesSnap] = await Promise.all([
                    get(ref(db, `folders/${id}`)),
                    get(ref(db, `quizzes/${id}`))
                ]);
                
                const f = folderSnap.val() || {};
                let vHtml = '';
                
                if (f.videos) {
                    const videosArray = [];
                    Object.entries(f.videos).forEach(([vId, v]) => {
                        videosArray.push({ id: vId, ...v, order: v.order || 999 });
                    });
                    
                    videosArray.sort((a, b) => a.order - b.order);
                    
                    videosArray.forEach(v => {
                        vHtml += `<div class="list-item">
                            <div>
                                <span style="font-weight: bold;">${escapeHTML(v.order)}. ${escapeHTML(v.title)}</span>
                                <div style="font-size:0.8rem; color: #666;">${escapeHTML(v.url)}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-view btn-icon" onclick='playVideoAdmin("${escapeHTML(v.url)}", "${escapeHTML(v.title)}")' title="Ù…Ø´Ø§Ù‡Ø¯Ø©">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn-edit btn-icon" onclick='openEditVideoModal("${id}", "${v.id}", ${JSON.stringify(v).replace(/</g, '\\u003c')})' title="ØªØ¹Ø¯ÙŠÙ„">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete btn-icon" onclick="delData('folders/${id}/videos/${v.id}')" title="Ø­Ø°Ù">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    });
                } else {
                    vHtml = '<p class="empty-state" style="padding:20px;"><i class="fas fa-video"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</p>';
                }
                
                document.getElementById('vListContainer').innerHTML = vHtml;
                
                let qHtml = '';
                if (quizzesSnap.exists()) {
                    quizzesSnap.forEach(q => {
                        const qData = q.val();
                        const qCount = qData.questions ? Object.keys(qData.questions).length : 0;
                        qHtml += `<div class="list-item">
                            <div>
                                <span style="font-weight: bold;">${escapeHTML(qData.name)}</span>
                                <span class="badge-grade" style="margin-right: 10px;">${qCount} Ø³Ø¤Ø§Ù„</span>
                            </div>
                            <div class="item-actions">
                                <button class="btn-view btn-icon" onclick='previewExamFromList("${id}", "${q.key}", ${JSON.stringify(qData).replace(/</g, '\\u003c')})' title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-edit btn-icon" onclick='openEditExamModal("${id}", "${q.key}", ${JSON.stringify(qData).replace(/</g, '\\u003c')})' title="ØªØ¹Ø¯ÙŠÙ„">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete btn-icon" onclick="delData('quizzes/${id}/${q.key}')" title="Ø­Ø°Ù">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    });
                } else {
                    qHtml = '<p class="empty-state" style="padding:20px;"><i class="fas fa-file-signature"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>';
                }
                
                document.getElementById('qListContainer').innerHTML = qHtml;
            } catch (error) {
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            } finally {
                stopProgress();
            }
            
            document.getElementById('editModal').style.display = 'flex';
        };

        window.closeModal = function() {
            document.getElementById('editModal').style.display = 'none';
        };

        // ================ UPDATE COURSE ================
        window.updateCourseBasic = async function() {
    const name = document.getElementById('editNameField')?.value.trim();
    const grade = document.getElementById('editGradeField')?.value;
    const imgUrl = document.getElementById('editImgField')?.value.trim();
    const imgFile = document.getElementById('editImageFile')?.files[0];
    
    if (!activeCID || !name) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
        return;
    }
    
    try {
        startProgress();
        const updateData = { name };
        if (grade) updateData.grade = grade;
        
        // Ø­Ø§Ù„Ø© 1: ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ØµÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹
        if (imgFile) {
            showToast('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'success');
            
            const formData = new FormData();
            formData.append('key', '049eb1f0e45afcb93f3c45a1400a29ef');
            formData.append('image', imgFile);
            
            const response = await fetch('https://api.imgbb.com/1/upload', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                updateData.img = data.data.url;
                showToast('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'success');
            } else {
                showToast('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error');
                stopProgress();
                return;
            }
        } 
        // Ø­Ø§Ù„Ø© 2: ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©
        else if (imgUrl) {
            updateData.img = imgUrl;
        }
        
        // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        await update(ref(db, `folders/${activeCID}`), updateData);
        showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('editImgField').value = '';
        document.getElementById('editImageFile').value = '';
        document.getElementById('editImagePreview').style.display = 'none';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        const folderSnap = await get(ref(db, `folders/${activeCID}`));
        openEditModal(activeCID, folderSnap.val() || {});
        
    } catch (error) {
        console.error('Error:', error);
        showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
    } finally {
        stopProgress();
    }
};

        // ================ VIDEO FUNCTIONS ================
        window.addVideoToCourse = function() {
            const title = document.getElementById('vTitle')?.value.trim();
            const url = document.getElementById('vUrl')?.value.trim();
            const order = document.getElementById('vOrder')?.value;
            
            if (!activeCID) {
                showToast('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
                return;
            }
            if (!title || !url) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø±Ø§Ø¨Ø·', 'error');
                return;
            }
            
            push(ref(db, `folders/${activeCID}/videos`), { 
                title, 
                url, 
                order: parseInt(order) || 0 
            }).then(() => {
                showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
                document.getElementById('vTitle').value = '';
                document.getElementById('vUrl').value = '';
                document.getElementById('vOrder').value = '';
                openEditModal(activeCID, { 
                    name: document.getElementById('editNameField')?.value || '',
                    grade: document.getElementById('editGradeField')?.value || ''
                });
            }).catch(() => showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error'));
        };

        window.openEditVideoModal = function(courseId, videoId, videoData) {
            document.getElementById('editVideoCourseId').value = courseId;
            document.getElementById('editVideoId').value = videoId;
            document.getElementById('editVideoTitle').value = videoData.title || '';
            document.getElementById('editVideoUrl').value = videoData.url || '';
            document.getElementById('editVideoOrder').value = videoData.order || 0;
            document.getElementById('editVideoModal').style.display = 'flex';
        };

        window.closeVideoModal = function() {
            document.getElementById('editVideoModal').style.display = 'none';
        };

        window.saveVideoChanges = async function() {
            const courseId = document.getElementById('editVideoCourseId')?.value;
            const videoId = document.getElementById('editVideoId')?.value;
            const title = document.getElementById('editVideoTitle')?.value.trim();
            const url = document.getElementById('editVideoUrl')?.value.trim();
            const order = parseInt(document.getElementById('editVideoOrder')?.value) || 0;

            if (!title || !url) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                return;
            }

            try {
                startProgress();
                await update(ref(db, `folders/${courseId}/videos/${videoId}`), {
                    title, url, order
                });
                showToast('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                closeVideoModal();
                const folderSnap = await get(ref(db, `folders/${courseId}`));
                openEditModal(courseId, folderSnap.val() || {});
            } catch (error) {
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            } finally {
                stopProgress();
            }
        };

        window.playVideoAdmin = function(url, title) {
            try {
                const match = url.match(/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
                if (!match || !match[2] || match[2].length !== 11) {
                    showToast('âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
                    return;
                }
                const videoId = match[2];
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:5000; display:flex; align-items:center; justify-content:center;';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
                
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'width:80%; height:80%; border-radius:15px;';
                iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                iframe.allow = 'autoplay; encrypted-media';
                iframe.allowFullscreen = true;
                
                const closeBtn = document.createElement('span');
                closeBtn.style.cssText = 'position:absolute; top:20px; left:20px; color:white; font-size:3rem; cursor:pointer; min-height:44px; min-width:44px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); border-radius:50%;';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = () => overlay.remove();
                
                overlay.appendChild(iframe);
                overlay.appendChild(closeBtn);
                document.body.appendChild(overlay);
            } catch {
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        };

        // ================ QUIZ FUNCTIONS ================
        window.addNewQuestion = function(type) {
            const container = document.getElementById('questionsArea');
            if (!container) return;
            
            const q = document.createElement('div');
            q.className = 'card';
            q.style = 'background:#f8f9fa; position:relative; margin-top:10px;';
            
            q.innerHTML = `
                <i class="fas fa-trash" style="position:absolute; left:10px; top:10px; color:var(--danger); cursor:pointer; min-height:44px; min-width:44px; display:flex; align-items:center; justify-content:center;" onclick="this.parentElement.remove()"></i>
                <input type="text" class="q-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" style="width:100%; padding:10px; margin-bottom:10px;">
                ${type === 'mcq' ? `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <input type="text" class="oA" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± A">
                    <input type="text" class="oB" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± B">
                    <input type="text" class="oC" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± C">
                    <input type="text" class="oD" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± D">
                </div>
                <select class="q-correct-mcq" style="margin-top:10px; width:100%;">
                    <option value="a">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: A</option>
                    <option value="b">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: B</option>
                    <option value="c">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: C</option>
                    <option value="d">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: D</option>
                </select>` : `
                <select class="q-correct-tf" style="margin-top:10px; width:100%;">
                    <option value="a">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ØµØ­</option>
                    <option value="b">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: Ø®Ø·Ø£</option>
                </select>`}
                <input type="hidden" class="q-type-hidden" value="${type}">
            `;
            container.appendChild(q);
        };

        window.saveFinalExam = function() {
            const folderId = document.getElementById('exFolderSelect')?.value;
            const title = document.getElementById('exTitle')?.value.trim();
            
            if (!folderId) {
                showToast('Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³', 'error');
                return;
            }
            if (!title) {
                showToast('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
                return;
            }
            
            let questions = {};
            let qIndex = 0;
            
            document.querySelectorAll('#questionsArea .card').forEach(card => {
                const qText = card.querySelector('.q-text')?.value.trim();
                if (!qText) return;
                
                const qType = card.querySelector('.q-type-hidden')?.value || 'mcq';
                const oA = card.querySelector('.oA')?.value.trim();
                const oB = card.querySelector('.oB')?.value.trim();
                
                if (qType === 'mcq' && oA && oB) {
                    const correct = card.querySelector('.q-correct-mcq')?.value || 'a';
                    const oC = card.querySelector('.oC')?.value.trim() || '';
                    const oD = card.querySelector('.oD')?.value.trim() || '';
                    questions[`q${qIndex}`] = { text: qText, a: oA, b: oB, c: oC, d: oD, correct };
                } else {
                    const correct = card.querySelector('.q-correct-tf')?.value || 'a';
                    questions[`q${qIndex}`] = { text: qText, a: 'ØµØ­', b: 'Ø®Ø·Ø£', correct };
                }
                qIndex++;
            });
            
            if (Object.keys(questions).length === 0) {
                showToast('Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }
            
            push(ref(db, `quizzes/${folderId}`), { 
                name: title, 
                questions,
                createdAt: new Date().toLocaleString('ar-EG')
            }).then(() => {
                showToast('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†');
                document.getElementById('questionsArea').innerHTML = '';
                document.getElementById('exTitle').value = '';
            }).catch(() => showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error'));
        };

        function fillDropdowns(folders) {
            const select = document.getElementById('exFolderSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>';
            if (folders) {
                Object.entries(folders).forEach(([id, f]) => {
                    select.innerHTML += `<option value="${id}">${escapeHTML(f.name)} (${escapeHTML(f.grade || 'Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø­Ù„Ø©')})</option>`;
                });
            }
        }

        // ================ ADVANCED SEARCH ================
        window.performAdvancedSearch = async function() {
            const term = document.getElementById('advancedSearch')?.value.trim().toLowerCase();
            if (!term) {
                showToast('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«', 'error');
                return;
            }
            
            try {
                startProgress();
                let foundStudent = null;
                let foundUid = null;
                
                for (const [uid, s] of Object.entries(allStudents)) {
                    if ((s.name && s.name.toLowerCase().includes(term)) || 
                        (s.shortId && s.shortId.toLowerCase().includes(term))) {
                        foundStudent = s;
                        foundUid = uid;
                        break;
                    }
                }
                
                if (!foundStudent) {
                    showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨', 'error');
                    document.getElementById('searchResults').style.display = 'none';
                    return;
                }
                
                currentStudentData = foundStudent;
                currentStudentUid = foundUid;
                
                document.getElementById('studentInfo').innerHTML = `
                    <div class="card"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHTML(foundStudent.name)}</div>
                    <div class="card"><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> ${escapeHTML(foundStudent.shortId)}</div>
                    <div class="card"><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${escapeHTML(foundStudent.grade)}</div>
                    <div class="card"><strong>ÙˆØ§ØªØ³Ø§Ø¨:</strong> ${escapeHTML(foundStudent.whatsapp)}</div>
                    <div class="card"><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> ${foundStudent.points || 0}</div>
                `;
                
                let subsHtml = '';
                if (foundStudent.subscriptions) {
                    Object.values(foundStudent.subscriptions).forEach(sub => {
                        subsHtml += `<div class="list-item">${escapeHTML(sub.courseName)}</div>`;
                    });
                }
                document.getElementById('studentSubscriptions').innerHTML = subsHtml || '<p class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</p>';
                
                let videosHtml = '';
                if (foundStudent.watchedVideos) {
                    Object.values(foundStudent.watchedVideos).forEach(v => {
                        videosHtml += `<div class="list-item">${escapeHTML(v.videoTitle)} - ${escapeHTML(v.watchedAt)}</div>`;
                    });
                }
                document.getElementById('studentWatchedVideos').innerHTML = videosHtml || '<p class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</p>';
                
                let examsHtml = '';
                if (foundStudent.examResults) {
                    Object.values(foundStudent.examResults).forEach(ex => {
                        examsHtml += `<tr>
                            <td>${escapeHTML(ex.quizName)}</td>
                            <td>${ex.score}/${ex.total}</td>
                            <td>${ex.percentage}%</td>
                            <td>${escapeHTML(ex.completedAt)}</td>
                        </tr>`;
                    });
                }
                document.getElementById('studentExamResults').innerHTML = examsHtml || '<tr><td colspan="4" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                
                let accessHtml = '';
                if (allCourseAccess[foundUid]) {
                    Object.values(allCourseAccess[foundUid]).forEach(acc => {
                        accessHtml += `<tr><td>${escapeHTML(acc.courseName)}</td><td>${escapeHTML(acc.time)}</td></tr>`;
                    });
                }
                document.getElementById('studentAccessLog').innerHTML = accessHtml || '<tr><td colspan="2" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
                
                document.getElementById('searchResults').style.display = 'block';
            } catch (error) {
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            } finally {
                stopProgress();
            }
        };

        window.clearAdvancedSearch = function() {
            document.getElementById('advancedSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            currentStudentData = null;
            currentStudentUid = null;
        };

        // ================ ADMIN FUNCTIONS ================
        window.addAdmin = async function() {
            const email = document.getElementById('newAdminEmail')?.value.trim();
            const name = document.getElementById('newAdminName')?.value.trim();
            
            if (!email || !name) {
                showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ø§Ø³Ù…', 'error');
                return;
            }
            
            try {
                startProgress();
                const adminId = email.replace(/[.#$[\]]/g, '_');
                await set(ref(db, `admins/${adminId}`), { email, name });
                
                document.getElementById('newAdminEmail').value = '';
                document.getElementById('newAdminName').value = '';
                showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ù…Ù†');
            } catch (error) {
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            } finally {
                stopProgress();
            }
        };

        window.removeAdmin = async function(adminId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                try {
                    startProgress();
                    await remove(ref(db, `admins/${adminId}`));
                    showToast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } catch (error) {
                    showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
                } finally {
                    stopProgress();
                }
            }
        };

        // ================ EDIT EXAM FUNCTIONS ================
        window.openEditExamModal = async function(courseId, examId, examData) {
            currentEditingExam = { courseId, examId, examData };
            
            document.getElementById('editExamCourseId').value = courseId;
            document.getElementById('editExamId').value = examId;
            document.getElementById('editExamName').value = examData.name || '';
            
            const container = document.getElementById('editQuestionsArea');
            container.innerHTML = '';
            
            if (examData.questions) {
                Object.entries(examData.questions).forEach(([key, q], index) => {
                    addEditQuestionCard(q, index);
                });
            }
            
            document.getElementById('editExamModal').style.display = 'flex';
        };

        window.closeExamModal = function() {
            document.getElementById('editExamModal').style.display = 'none';
            document.getElementById('editQuestionsArea').innerHTML = '';
            currentEditingExam = null;
        };

        window.addEditQuestion = function(type) {
            addEditQuestionCard(type === 'mcq' ? { a: '', b: '', c: '', d: '' } : { a: 'ØµØ­', b: 'Ø®Ø·Ø£' });
        };

        function addEditQuestionCard(questionData, index) {
            const container = document.getElementById('editQuestionsArea');
            if (!container) return;
            
            const qIndex = index ?? container.children.length;
            const isMcq = questionData && Object.keys(questionData).includes('c');
            
            const card = document.createElement('div');
            card.className = 'edit-question-card';
            card.dataset.index = qIndex;
            
            card.innerHTML = `
                <div class="question-header">
                    <span class="question-number">Ø³Ø¤Ø§Ù„ ${qIndex + 1}</span>
                    <div class="question-actions">
                        <i class="fas fa-copy touch-feedback" onclick="duplicateQuestion(${qIndex})"></i>
                        <i class="fas fa-trash touch-feedback" onclick="this.closest('.edit-question-card').remove()"></i>
                    </div>
                </div>
                
                <input type="text" class="q-text reg-input" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" value="${escapeHTML(questionData?.text || '')}" style="margin-bottom: 15px;">
                
                <select class="q-type reg-input" style="margin-bottom: 15px;" onchange="changeQuestionType(this)">
                    <option value="mcq" ${isMcq ? 'selected' : ''}>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                    <option value="tf" ${!isMcq ? 'selected' : ''}>ØµØ­/Ø®Ø·Ø£</option>
                </select>
                
                <div class="mcq-options" style="display: ${isMcq ? 'grid' : 'none'};">
                    <div><label>A</label><input type="text" class="oA reg-input" value="${escapeHTML(questionData?.a || '')}"></div>
                    <div><label>B</label><input type="text" class="oB reg-input" value="${escapeHTML(questionData?.b || '')}"></div>
                    <div><label>C</label><input type="text" class="oC reg-input" value="${escapeHTML(questionData?.c || '')}"></div>
                    <div><label>D</label><input type="text" class="oD reg-input" value="${escapeHTML(questionData?.d || '')}"></div>
                </div>
                
                <div class="tf-options" style="display: ${!isMcq ? 'block' : 'none'};">
                    <select class="q-correct-tf reg-input">
                        <option value="a" ${questionData?.correct === 'a' ? 'selected' : ''}>ØµØ­</option>
                        <option value="b" ${questionData?.correct === 'b' ? 'selected' : ''}>Ø®Ø·Ø£</option>
                    </select>
                </div>
                
                <div class="mcq-correct-wrapper" style="display: ${isMcq ? 'block' : 'none'}; margin-top: 15px;">
                <select class="q-correct-mcq reg-input">
                    <option value="a" ${questionData?.correct === 'a' ? 'selected' : ''}>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: A</option>
                    <option value="b" ${questionData?.correct === 'b' ? 'selected' : ''}>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: B</option>
                    <option value="c" ${questionData?.correct === 'c' ? 'selected' : ''}>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: C</option>
                    <option value="d" ${questionData?.correct === 'd' ? 'selected' : ''}>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: D</option>
                </select>
                </div>
            `;
            
            container.appendChild(card);
        }

        window.changeQuestionType = function(select) {
            const card = select.closest('.edit-question-card');
            const mcqDiv = card.querySelector('.mcq-options');
            const tfDiv = card.querySelector('.tf-options');
            const mcqCorrectWrapper = card.querySelector('.mcq-correct-wrapper');
            
            if (select.value === 'mcq') {
                mcqDiv.style.display = 'grid';
                tfDiv.style.display = 'none';
                if (mcqCorrectWrapper) mcqCorrectWrapper.style.display = 'block';
            } else {
                mcqDiv.style.display = 'none';
                tfDiv.style.display = 'block';
                if (mcqCorrectWrapper) mcqCorrectWrapper.style.display = 'none';
            }
        };

        window.duplicateQuestion = function(index) {
            const cards = document.querySelectorAll('#editQuestionsArea .edit-question-card');
            if (index >= 0 && index < cards.length) {
                const clone = cards[index].cloneNode(true);
                document.getElementById('editQuestionsArea').appendChild(clone);
                
                document.querySelectorAll('#editQuestionsArea .edit-question-card').forEach((card, idx) => {
                    const num = card.querySelector('.question-number');
                    if (num) num.textContent = `Ø³Ø¤Ø§Ù„ ${idx + 1}`;
                    card.dataset.index = idx;
                });
            }
        };

        function collectEditQuestions() {
            let questions = {};
            let qIndex = 0;
            
            document.querySelectorAll('#editQuestionsArea .edit-question-card').forEach(card => {
                const qText = card.querySelector('.q-text')?.value.trim();
                if (!qText) return;
                
                const isMcq = card.querySelector('.q-type')?.value === 'mcq';
                
                if (isMcq) {
                    const correct = card.querySelector('.q-correct-mcq')?.value || 'a';
                    const oA = card.querySelector('.oA')?.value.trim() || '';
                    const oB = card.querySelector('.oB')?.value.trim() || '';
                    const oC = card.querySelector('.oC')?.value.trim() || '';
                    const oD = card.querySelector('.oD')?.value.trim() || '';
                    questions[`q${qIndex}`] = { text: qText, a: oA, b: oB, c: oC, d: oD, correct };
                } else {
                    const correct = card.querySelector('.q-correct-tf')?.value || 'a';
                    questions[`q${qIndex}`] = { text: qText, a: 'ØµØ­', b: 'Ø®Ø·Ø£', correct };
                }
                qIndex++;
            });
            
            return questions;
        }

        window.previewExam = function() {
            const name = document.getElementById('editExamName')?.value.trim();
            const questions = collectEditQuestions();
            
            if (Object.keys(questions).length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©', 'error');
                return;
            }
            
            let previewHtml = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: var(--primary);">${escapeHTML(name || 'Ø§Ù…ØªØ­Ø§Ù†')}</h2>
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${Object.keys(questions).length}</p>
                </div>
            `;
            
            Object.keys(questions).forEach((key, idx) => {
                const q = questions[key];
                previewHtml += `<div class="preview-question">`;
                previewHtml += `<h4>Ø³Ø¤Ø§Ù„ ${idx + 1}: ${escapeHTML(q.text)}</h4>`;
                
                if (q.c) {
                    previewHtml += `<div class="preview-options">`;
                    ['a', 'b', 'c', 'd'].forEach(opt => {
                        if (q[opt]) {
                            const isCorrect = q.correct === opt;
                            previewHtml += `
                                <div class="preview-option ${isCorrect ? 'correct' : ''}">
                                    <span>${opt.toUpperCase()}: ${escapeHTML(q[opt])}</span>
                                    ${isCorrect ? '<span class="correct-badge">âœ“ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</span>' : ''}
                                </div>
                            `;
                        }
                    });
                    previewHtml += `</div>`;
                } else {
                    previewHtml += `
                        <div class="preview-tf">
                            <div class="preview-tf-option ${q.correct === 'a' ? 'correct' : ''}">ØµØ­</div>
                            <div class="preview-tf-option ${q.correct === 'b' ? 'correct' : ''}">Ø®Ø·Ø£</div>
                        </div>
                    `;
                }
                previewHtml += `</div>`;
            });
            
            document.getElementById('previewExamContent').innerHTML = previewHtml;
            document.getElementById('previewExamModal').style.display = 'flex';
        };

        window.closePreviewModal = function() {
            document.getElementById('previewExamModal').style.display = 'none';
        };

        window.saveExamChanges = async function() {
            const courseId = document.getElementById('editExamCourseId')?.value;
            const examId = document.getElementById('editExamId')?.value;
            const name = document.getElementById('editExamName')?.value.trim();
            
            if (!name) {
                showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†', 'error');
                return;
            }
            
            const questions = collectEditQuestions();
            if (Object.keys(questions).length === 0) {
                showToast('Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }
            
            try {
                startProgress();
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… set Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† update Ù„Ø¶Ù…Ø§Ù† Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                await set(ref(db, `quizzes/${courseId}/${examId}`), {
                    name,
                    questions,
                    updatedAt: new Date().toLocaleString('ar-EG')
                });
                
                showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù„Ù„Ø·Ù„Ø§Ø¨ ÙÙˆØ±Ø§Ù‹');
                closeExamModal();
                
                if (activeCID === courseId) {
                    const folderSnap = await get(ref(db, `folders/${courseId}`));
                    openEditModal(courseId, folderSnap.val() || {});
                }
            } catch (error) {
                console.error('Save exam error:', error);
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'error');
            } finally {
                stopProgress();
            }
        };

        window.deleteExam = async function() {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŸ')) return;
            
            const courseId = document.getElementById('editExamCourseId')?.value;
            const examId = document.getElementById('editExamId')?.value;
            
            try {
                startProgress();
                await remove(ref(db, `quizzes/${courseId}/${examId}`));
                showToast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                closeExamModal();
                
                if (activeCID === courseId) {
                    const folderSnap = await get(ref(db, `folders/${courseId}`));
                    openEditModal(courseId, folderSnap.val() || {});
                }
            } catch (error) {
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            } finally {
                stopProgress();
            }
        };

        window.previewExamFromList = function(courseId, examId, examData) {
            currentEditingExam = { courseId, examId, examData };
            document.getElementById('editExamName').value = examData.name || '';
            document.getElementById('editExamCourseId').value = courseId;
            document.getElementById('editExamId').value = examId;
            
            const container = document.getElementById('editQuestionsArea');
            container.innerHTML = '';
            
            if (examData.questions) {
                Object.entries(examData.questions).forEach(([key, q], index) => {
                    addEditQuestionCard(q, index);
                });
            }
            
            previewExam();
        };

        // ================ ANALYTICS ================
        function loadAnalytics() {
            const summary = document.getElementById('analyticsSummary');
            
            const totalStudents = Object.keys(allStudents).length;
            const totalCourses = Object.keys(allFolders).length;
            const totalExams = Object.keys(allResults).length;
            const avgScore = totalExams > 0 
                ? Math.round(Object.values(allResults).reduce((acc, r) => acc + (r.percentage || 0), 0) / totalExams) 
                : 0;
            
            if (summary) {
                summary.innerHTML = `
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-users"></i></div>
                        <div><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h4><div class="number">${totalStudents}</div></div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-book"></i></div>
                        <div><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h4><div class="number">${totalCourses}</div></div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-file-alt"></i></div>
                        <div><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h4><div class="number">${totalExams}</div></div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-star"></i></div>
                        <div><h4>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h4><div class="number">${avgScore}%</div></div>
                    </div>
                `;
            }
            
            // Charts
            if (charts.topCourses) charts.topCourses.destroy();
            if (charts.examScores) charts.examScores.destroy();
            if (charts.activity) charts.activity.destroy();
            
            const ctx1 = document.getElementById('topCoursesChart')?.getContext('2d');
            if (ctx1) {
                const courseNames = Object.values(allFolders).map(f => f.name).slice(0, 5);
                const courseViews = courseNames.map(() => Math.floor(Math.random() * 50) + 10);
                
                charts.topCourses = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: courseNames,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª',
                            data: courseViews,
                            backgroundColor: '#6c5ce7'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            
            const ctx2 = document.getElementById('examScoresChart')?.getContext('2d');
            if (ctx2) {
                const scores = Object.values(allResults).map(r => r.percentage || 0);
                const less50 = scores.filter(s => s < 50).length;
                const mid = scores.filter(s => s >= 50 && s < 70).length;
                const good = scores.filter(s => s >= 70 && s < 90).length;
                const excellent = scores.filter(s => s >= 90).length;
                
                charts.examScores = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['Ø£Ù‚Ù„ Ù…Ù† 50%', '50-70%', '70-90%', '90-100%'],
                        datasets: [{
                            data: [less50, mid, good, excellent],
                            backgroundColor: ['#ff7675', '#f1c40f', '#00b894', '#6c5ce7']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            
            const ctx3 = document.getElementById('activityChart')?.getContext('2d');
            if (ctx3) {
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                const weekData = days.map(() => Math.floor(Math.random() * 20));
                
                charts.activity = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: days,
                        datasets: [{
                            label: 'Ø§Ù„Ù†Ø´Ø§Ø·',
                            data: weekData,
                            borderColor: '#6c5ce7',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        function loadLeaderboard() {
            const leaderboard = document.getElementById('adminLeaderboard');
            if (!leaderboard) return;
            
            let html = '<div class="leaderboard-row"><span class="leaderboard-rank">#</span><span>Ø§Ù„Ø·Ø§Ù„Ø¨</span><span>Ø§Ù„Ù†Ù‚Ø§Ø·</span></div>';
            
            const topStudents = Object.values(allStudents)
                .filter(s => s.points > 0)
                .sort((a, b) => (b.points || 0) - (a.points || 0))
                .slice(0, 20);
            
            if (topStudents.length > 0) {
                topStudents.forEach((s, i) => {
                    html += `<div class="leaderboard-row">
                        <span class="leaderboard-rank">#${i+1}</span>
                        <span>${escapeHTML(s.name || '')}</span>
                        <span>${s.points || 0} <i class="fas fa-star" style="color: var(--gold);"></i></span>
                    </div>`;
                });
            } else {
                html += '<div class="leaderboard-row"><span colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span></div>';
            }
            
            leaderboard.innerHTML = html;
        }

        // ================ DELETE DATA ================
        window.delData = function(path) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                startProgress();
                remove(ref(db, path))
                    .then(() => showToast('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù'))
                    .catch(err => showToast('âŒ ' + err.message, 'error'))
                    .finally(stopProgress);
            }
        };

        // ================ IMAGE PREVIEW ================
        document.addEventListener('DOMContentLoaded', function() {
            const cImageFile = document.getElementById('cImageFile');
            if (cImageFile) {
                cImageFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const preview = document.getElementById('imagePreview');
                        const previewImg = document.getElementById('previewImg');
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            const editImageFile = document.getElementById('editImageFile');
            if (editImageFile) {
                editImageFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const preview = document.getElementById('editImagePreview');
                        const previewImg = document.getElementById('editPreviewImg');
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Hide skeletons
            setTimeout(() => {
                document.querySelectorAll('.skeleton').forEach(el => el.remove());
            }, 2000);
        });

        // ================ CLEANUP ================
        window.addEventListener('beforeunload', () => {
            cleanupListeners();
        });
    </script>
    <script>
// Ø­Ù„ Ø¨Ø³ÙŠØ· Ù„Ù…Ø´ÙƒÙ„Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
document.addEventListener('DOMContentLoaded', function() {
    // ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
    const editImageFile = document.getElementById('editImageFile');
    if (editImageFile) {
        editImageFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… (8 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
                if (file.size > 8 * 1024 * 1024) {
                    alert('âŒ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 8 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                    this.value = '';
                    return;
                }
                
                // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
                const preview = document.getElementById('editImagePreview');
                const previewImg = document.getElementById('editPreviewImg');
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Ø­Ù„ Ø¨Ø¯ÙŠÙ„: Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    const editImgField = document.getElementById('editImgField');
    if (editImgField) {
        editImgField.addEventListener('click', function() {
            this.select();
        });
    }
});
</script>
</body>
</html>