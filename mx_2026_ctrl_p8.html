<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mona Academy | Pro Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent: #6c5ce7; --dark-bg: #111417; --card-bg: #ffffff;
            --text-main: #2d3436; --danger: #ff7675; --success: #00b894;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: #f0f2f5; color: var(--text-main); overflow-x: hidden; }

        /* Mobile Header */
        .mobile-header {
            display: none; background: var(--dark-bg); color: white;
            padding: 15px; position: sticky; top: 0; z-index: 1001;
            justify-content: space-between; align-items: center;
        }

        /* Sidebar */
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 280px; background: var(--dark-bg); color: white; padding: 25px; 
            position: fixed; height: 100vh; right: 0; transition: 0.4s; z-index: 1000;
            overflow-y: auto;
        }
        .main-content { margin-right: 280px; flex: 1; padding: 20px; transition: 0.4s; width: 100%; }

        .logo { font-size: 22px; font-weight: 900; text-align: center; margin-bottom: 40px; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 20px; }
        .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 15px; 
            border-radius: 12px; cursor: pointer; transition: 0.3s; margin-bottom: 10px; color: #a4b0be;
        }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: white; }

        @media (max-width: 992px) {
            .mobile-header { display: flex; }
            .sidebar { right: -280px; }
            .sidebar.open { right: 0; }
            .main-content { margin-right: 0; }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }
            .overlay.active { display: block; }
        }

        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-system { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-top: 8px; font-family: 'Cairo'; outline: none; }
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.3s; }
        .btn-main { background: var(--accent); color: white; width: 100%; }
        .btn-danger { background: #fff0f0; color: var(--danger); border: 1px solid #ff7675; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: right; padding: 12px; background: #f8f9fa; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 10px; }
        .modal-content { background: white; width: 100%; max-width: 800px; border-radius: 25px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }

        #guard-loader { position: fixed; inset: 0; background: var(--dark-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 10px; margin-bottom: 8px; border-right: 5px solid var(--accent); }
        
        .stat-badge { display: inline-block; padding: 5px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; margin-left: 5px; }
        .badge-email { background: #e3f2fd; color: #1976d2; }
        .badge-username { background: #f3e5f5; color: #7b1fa2; }
        .badge-google { background: #fff3e0; color: #f57c00; }
        
        .student-id-display { background: #f0eeff; color: var(--accent); padding: 3px 8px; border-radius: 5px; font-size: 0.75rem; border: 1px solid var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <span style="font-weight: 900;">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ù€Ù†Ù‰</span>
        <i class="fas fa-bars fa-lg" onclick="toggleSidebar()"></i>
    </div>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div id="guard-loader">
        <i class="fas fa-user-shield fa-spin fa-3x" style="color: var(--accent);"></i>
        <h3 style="margin-top: 20px;">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©...</h3>
    </div>

    <div class="wrapper" id="adminApp" style="display: none;">
        <aside class="sidebar" id="sidebar">
            <div class="logo">Mona Academy</div>
            <div class="nav-link active" onclick="showSection('coursesSection', this)"><i class="fas fa-th-large"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</div>
            <div class="nav-link" onclick="showSection('examsSection', this)"><i class="fas fa-edit"></i> Ù…ØµÙ†Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
            <div class="nav-link" onclick="showSection('studentSearchSection', this)"><i class="fas fa-search"></i> Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù… Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="nav-link" onclick="showSection('studentsSection', this)"><i class="fas fa-user-graduate"></i> Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</div>
            <div class="nav-link" onclick="showSection('resultsSection', this)"><i class="fas fa-poll-h"></i> Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="nav-link" onclick="showSection('accessLogsSection', this)"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª</div>
            <div class="nav-link" onclick="showSection('notificationsSection', this)"><i class="fas fa-bell"></i> Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</div>
            <div class="nav-link" onclick="showSection('reviewsSection', this)"><i class="fas fa-comments"></i> Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            
            <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                <a href="index.html" class="nav-link" style="color: var(--success);"><i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹</a>
                <div class="nav-link" onclick="logout()" style="color: var(--danger);"><i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬</div>
            </div>
        </aside>

        <main class="main-content">
            <section id="coursesSection" class="admin-section">
                <div class="card">
                    <h3>Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯</h3>
                    <div class="grid-system">
                        <input type="text" id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³">
                        <input type="file" id="cImg" accept="image/*">
                    </div>
                    <button class="btn btn-main" style="margin-top:15px;" onclick="addCourse()">Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ±Ø³</button>
                </div>
                <div id="coursesGrid" class="grid-system"></div>
            </section>

            <section id="examsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>Ø¨Ù†Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
                    <select id="exFolderSelect"></select>
                    <input type="text" id="exTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
                    <label style="margin-top: 10px; display: block;">Ø±Ø¨Ø· Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù€:</label>
                    <select id="exVideoRel">
                        <option value="all">Ø§Ù…ØªØ­Ø§Ù† Ø´Ø§Ù…Ù„ (ÙŠØ¸Ù‡Ø± Ù…Ø¹ ÙƒÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª)</option>
                    </select>
                    <div id="questionsArea" style="margin-top: 15px;"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" style="background:#eee;" onclick="addNewQuestion('mcq')">+ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
                        <button class="btn" style="background:#eee;" onclick="addNewQuestion('tf')">+ ØµØ­/Ø®Ø·Ø£</button>
                    </div>
                    <button class="btn btn-main" style="margin-top: 20px;" onclick="saveFinalExam()">Ù†Ø´Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
                </div>
            </section>

            <section id="studentSearchSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>ğŸ” Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù… Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <p style="color: #666; margin-bottom: 20px;">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„Ù†Ø´Ø§Ø·Ø§Øª</p>
                    <input type="text" id="advancedSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨..." style="font-size: 1.1rem;">
                    <button class="btn btn-main" style="margin-top: 15px;" onclick="performAdvancedSearch()">Ø¨Ø­Ø«</button>
                </div>
                
                <div id="searchResults" style="display: none;">
                    <div class="card">
                        <h3>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                        <div id="studentInfo" class="grid-system"></div>
                    </div>
                    
                    <div class="card">
                        <h3>ğŸ“š Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠÙ‡Ø§</h3>
                        <div id="studentCourses"></div>
                    </div>
                    
                    <div class="card">
                        <h3>ğŸ“ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                        <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                        <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                                        <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                    </tr>
                                </thead>
                                <tbody id="studentExams"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ÙƒÙˆØ±Ø³</th>
                                        <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                    </tr>
                                </thead>
                                <tbody id="studentAccessLog"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="studentsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ <span style="color: var(--accent);" id="studentCount"></span></h3>
                    <input type="text" id="studentSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." style="margin-bottom: 15px;" onkeyup="filterStudents()">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                                    <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
                                    <th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                    <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="studentList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="resultsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ <span style="color: var(--accent);" id="resultsCount"></span></h3>
                    <input type="text" id="resultSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." style="margin-bottom: 15px;" onkeyup="filterResults()">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                    <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                    <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                                    <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="resultsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="accessLogsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª <span style="color: var(--accent);" id="logsCount"></span></h3>
                    <input type="text" id="logSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ±Ø³..." style="margin-bottom: 15px;" onkeyup="filterLogs()">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„ÙƒÙˆØ±Ø³</th>
                                    <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="logsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="notificationsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª <span style="color: var(--accent);" id="notificationsCount"></span></h3>
                    <p style="color: #666; margin-bottom: 15px;">Ù‡Ø°Ù‡ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ø¯Ø®Ù„ÙˆØ§ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©</p>
                    <input type="text" id="notificationSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." style="margin-bottom: 15px;" onkeyup="filterNotifications()">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³</th>
                                    <th>ÙˆÙ‚Øª Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="notificationsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="reviewsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ <span style="color: var(--accent);" id="reviewsCount"></span></h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th>Ø§Ù„Ø±Ø£ÙŠ</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody id="reviewsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="editModalTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³</h3>
            <div class="card" style="background:#f9f9f9; margin-top:15px;">
                <label>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:</label><input type="text" id="editNameField">
                <label>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:</label><input type="file" id="editImgField">
                <button class="btn btn-main" style="margin-top:10px;" id="saveBasicBtn" onclick="updateCourseBasic()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
            <h4>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ:</h4>
            <input type="text" id="vTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">
            <input type="text" id="vUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨">
            <input type="number" id="vOrder" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨ (1, 2, ..)">
            <button class="btn btn-main" style="margin-top:10px;" onclick="addVideoToCourse()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
            
            <h4 style="margin-top:20px;">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙˆØ§Ø®ØªØ¨Ø§Ø±Ø§Øª):</h4>
            <div id="vListContainer"></div>
            <div id="qListContainer"></div>
            <button class="btn btn-danger" style="width:100%; margin-top:20px;" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KQAQgu4nIiomoDpoTLnBz_uAtab63sY",
            authDomain: "monaacademy-cd983.firebaseapp.com",
            databaseURL: "https://monaacademy-cd983-default-rtdb.firebaseio.com",
            projectId: "monaacademy-cd983",
            storageBucket: "monaacademy-cd983.appspot.com",
            appId: "1:410646694761:web:bea49c51d3b0ff5eb9cbf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let activeCID = "";
        let allStudents = {};
        let allResults = {};
        let allLogs = {};
        let allNotifications = {};
        let allCourseAccess = {};
        let allFolders = {};

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        };

        onAuthStateChanged(auth, user => {
            if (user && user.email === "mrsmonakamel6@gmail.com") {
                document.getElementById('guard-loader').style.display = 'none';
                document.getElementById('adminApp').style.display = 'flex';
                syncData();
            } else { window.location.href = "index.html"; }
        });

        function syncData() {
            onValue(ref(db, '/'), snap => {
                const data = snap.val() || {};
                allFolders = data.folders || {};
                renderCourses(allFolders);
                allStudents = data.students || {};
                renderStudents(allStudents);
                allResults = data.quiz_results || {};
                renderResults(allResults);
                allLogs = data.course_access_logs || {};
                renderAccessLogs(allLogs);
                allNotifications = data.course_access_notifications || {};
                renderNotifications(allNotifications);
                allCourseAccess = data.student_course_access || {};
                renderReviews(data.reviews);
                fillDropdowns(allFolders);
            });
        }

        window.renderCourses = (folders) => {
            let h = "";
            if(folders) Object.keys(folders).forEach(id => {
                h += `<div class="card" style="text-align:center;">
                    <img src="${folders[id].img || ''}" style="width:65px; height:65px; border-radius:12px; object-fit:cover;">
                    <h4 style="margin:10px 0;">${folders[id].name}</h4>
                    <button class="btn btn-main" onclick="openEditModal('${id}', '${folders[id].name}')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
                    <button class="btn btn-danger" style="width:100%; margin-top:5px;" onclick="delData('folders/${id}')">Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ±Ø³</button>
                </div>`;
            });
            document.getElementById('coursesGrid').innerHTML = h;
        };

        window.addCourse = () => {
            const name = document.getElementById('cName').value, file = document.getElementById('cImg').files[0];
            if(!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³");
            if(file) {
                const r = new FileReader();
                r.onload = () => {
                    push(ref(db, 'folders'), { name, img: r.result });
                    document.getElementById('cName').value = "";
                    document.getElementById('cImg').value = "";
                    alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³");
                };
                r.readAsDataURL(file);
            } else {
                push(ref(db, 'folders'), { name });
                document.getElementById('cName').value = "";
                alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³");
            }
        };

        window.openEditModal = (id, name) => {
            activeCID = id;
            document.getElementById('editNameField').value = name;
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
            onValue(ref(db, `folders/${id}`), snap => {
                const f = snap.val() || {};
                let vH = "<h5 style='margin-top:15px;'>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:</h5>";
                if(f.videos) {
                    Object.entries(f.videos).sort((a,b)=>(a[1].order||0)-(b[1].order||0)).forEach(([vId, v]) => {
                        vH += `<div class="list-item"><span>${v.order||0}. ${v.title}</span> <button onclick="delData('folders/${id}/videos/${vId}')" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button></div>`;
                    });
                } else {
                    vH += "<p style='color:#888; font-size:0.85rem;'>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¨Ø¹Ø¯</p>";
                }
                document.getElementById('vListContainer').innerHTML = vH;
            }, {onlyOnce: true});
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
            onValue(ref(db, `quizzes/${id}`), snap => {
                let qH = "<h5 style='margin-top:15px;'>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</h5>";
                if(snap.exists()) {
                    snap.forEach(q => {
                        const qData = q.val();
                        const qCount = qData.questions ? Object.keys(qData.questions).length : 0;
                        qH += `<div class="list-item"><span>${qData.name} (${qCount} Ø³Ø¤Ø§Ù„)</span> <button onclick="delData('quizzes/${id}/${q.key}')" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button></div>`;
                    });
                } else {
                    qH += "<p style='color:#888; font-size:0.85rem;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯</p>";
                }
                document.getElementById('qListContainer').innerHTML = qH;
            }, {onlyOnce: true});
            
            document.getElementById('editModal').style.display = 'flex';
        };

        window.updateCourseBasic = async () => {
            const name = document.getElementById('editNameField').value;
            const file = document.getElementById('editImgField').files[0];
            const btn = document.getElementById('saveBasicBtn');
            if(!activeCID) return;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; btn.disabled = true;

            if(file) {
                const r = new FileReader();
                r.onload = async () => {
                    await update(ref(db, `folders/${activeCID}`), { name, img: r.result });
                    alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­"); 
                    btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"; 
                    btn.disabled = false;
                    document.getElementById('editImgField').value = "";
                };
                r.readAsDataURL(file);
            } else {
                await update(ref(db, `folders/${activeCID}`), { name });
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…"); 
                btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"; 
                btn.disabled = false;
            }
        };

        window.addNewQuestion = (type) => {
            const q = document.createElement('div');
            q.className = "card"; 
            q.style = "background:#f1f1f1; position:relative; margin-top:10px;";
            q.innerHTML = `<i class="fas fa-trash" style="position:absolute; left:10px; top:10px; color:red; cursor:pointer;" onclick="this.parentElement.remove()"></i>
                <input type="text" class="q-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
                ${type==='mcq' ? `<div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
                    <input type="text" class="oA" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± A">
                    <input type="text" class="oB" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± B">
                    <input type="text" class="oC" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± C">
                    <input type="text" class="oD" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± D">
                </div>
                <select class="q-correct" style="margin-top:5px;">
                    <option value="a">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: A</option>
                    <option value="b">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: B</option>
                    <option value="c">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: C</option>
                    <option value="d">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: D</option>
                </select>` : `
                <select class="q-correct" style="margin-top:5px;">
                    <option value="a">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ØµØ­</option>
                    <option value="b">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: Ø®Ø·Ø£</option>
                </select>`}`;
            document.getElementById('questionsArea').appendChild(q);
        };

        window.saveFinalExam = () => {
            const fId = document.getElementById('exFolderSelect').value;
            const title = document.getElementById('exTitle').value;
            const videoRel = document.getElementById('exVideoRel').value;
            
            if(!fId) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙˆØ±Ø³");
            if(!title) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±");
            
            let questions = {};
            let qIndex = 0;
            
            document.querySelectorAll('#questionsArea .card').forEach(c => {
                const qText = c.querySelector('.q-text').value;
                if(!qText) return;
                
                const oA = c.querySelector('.oA');
                const oB = c.querySelector('.oB');
                const correct = c.querySelector('.q-correct').value;
                
                if(oA && oB) { // MCQ
                    questions[`q${qIndex}`] = {
                        text: qText,
                        a: oA.value || "",
                        b: oB.value || "",
                        c: c.querySelector('.oC')?.value || "",
                        d: c.querySelector('.oD')?.value || "",
                        correct: correct
                    };
                } else { // True/False
                    questions[`q${qIndex}`] = {
                        text: qText,
                        a: "ØµØ­",
                        b: "Ø®Ø·Ø£",
                        correct: correct
                    };
                }
                qIndex++;
            });
            
            if(Object.keys(questions).length === 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†");
            
            push(ref(db, `quizzes/${fId}`), { 
                name: title, 
                questions: questions,
                videoRel: videoRel
            }).then(() => { 
                alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­"); 
                document.getElementById('questionsArea').innerHTML = "";
                document.getElementById('exTitle').value = "";
            });
        };

        function renderStudents(s) {
            let h = "";
            let count = 0;
            if(s) {
                Object.keys(s).forEach(id => {
                    count++;
                    const student = s[id];
                    let regMethod = "";
                    
                    if(student.username) {
                        regMethod = '<span class="stat-badge badge-username">ÙŠÙˆØ²Ø± Ù†ÙŠÙ…</span>';
                    } else if(student.email && student.email.includes('@')) {
                        regMethod = '<span class="stat-badge badge-email">Ø¥ÙŠÙ…ÙŠÙ„</span>';
                    } else {
                        regMethod = '<span class="stat-badge badge-google">Ø¬ÙˆØ¬Ù„</span>';
                    }
                    
                    h += `<tr>
                        <td>${student.name}</td>
                        <td><span class="student-id-display">${student.shortId || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></td>
                        <td>${student.grade}</td>
                        <td>${student.whatsapp || '-'}</td>
                        <td>${student.parentPhone || '-'}</td>
                        <td>${regMethod}</td>
                        <td><button onclick="delData('students/${id}')" class="btn btn-danger" style="font-size:0.8rem; padding:6px 12px;">Ø­Ø°Ù</button></td>
                    </tr>`;
                });
            }
            document.getElementById('studentList').innerHTML = h;
            document.getElementById('studentCount').innerText = `(${count} Ø·Ø§Ù„Ø¨)`;
        }

        function renderResults(r) {
            let h = "";
            let count = 0;
            if(r) {
                Object.keys(r).forEach(id => {
                    count++;
                    const result = r[id];
                    h += `<tr>
                        <td>${result.student}</td>
                        <td><span class="student-id-display">${result.studentId || '-'}</span></td>
                        <td>${result.quiz}</td>
                        <td>${result.score}/${result.total}</td>
                        <td>${result.percentage}%</td>
                        <td>${result.time || '-'}</td>
                        <td><button onclick="delData('quiz_results/${id}')" class="btn btn-danger" style="font-size:0.8rem; padding:6px 12px;">Ø­Ø°Ù</button></td>
                    </tr>`;
                });
            }
            document.getElementById('resultsList').innerHTML = h;
            document.getElementById('resultsCount').innerText = `(${count} Ù†ØªÙŠØ¬Ø©)`;
        }

        function renderAccessLogs(logs) {
            let h = "";
            let count = 0;
            if(logs) {
                Object.keys(logs).forEach(id => {
                    count++;
                    const log = logs[id];
                    h += `<tr>
                        <td>${log.student}</td>
                        <td><span class="student-id-display">${log.studentId || '-'}</span></td>
                        <td>${log.course}</td>
                        <td>${log.time || '-'}</td>
                        <td><button onclick="delData('course_access_logs/${id}')" class="btn btn-danger" style="font-size:0.8rem; padding:6px 12px;">Ø­Ø°Ù</button></td>
                    </tr>`;
                });
            }
            document.getElementById('logsList').innerHTML = h;
            document.getElementById('logsCount').innerText = `(${count} Ø³Ø¬Ù„)`;
        }

        function renderReviews(reviews) {
            let h = "";
            let count = 0;
            if(reviews) {
                Object.keys(reviews).forEach(id => {
                    count++;
                    const review = reviews[id];
                    h += `<tr>
                        <td>${review.student}</td>
                        <td style="max-width:400px;">${review.text}</td>
                        <td><button onclick="delData('reviews/${id}')" class="btn btn-danger" style="font-size:0.8rem; padding:6px 12px;">Ø­Ø°Ù</button></td>
                    </tr>`;
                });
            }
            document.getElementById('reviewsList').innerHTML = h;
            document.getElementById('reviewsCount').innerText = `(${count} Ø±Ø£ÙŠ)`;
        }

        function renderNotifications(notifications) {
            let h = "";
            let count = 0;
            if(notifications) {
                Object.keys(notifications).forEach(id => {
                    count++;
                    const notif = notifications[id];
                    h += `<tr>
                        <td>${notif.studentName}</td>
                        <td><span class="student-id-display">${notif.studentId || '-'}</span></td>
                        <td>${notif.courseName}</td>
                        <td>${notif.time || '-'}</td>
                        <td><button onclick="delData('course_access_notifications/${id}')" class="btn btn-danger" style="font-size:0.8rem; padding:6px 12px;">Ø­Ø°Ù</button></td>
                    </tr>`;
                });
            }
            document.getElementById('notificationsList').innerHTML = h;
            document.getElementById('notificationsCount').innerText = `(${count} Ø¥Ø´Ø¹Ø§Ø±)`;
        }

        window.addVideoToCourse = () => {
            const t = document.getElementById('vTitle').value;
            const u = document.getElementById('vUrl').value;
            const o = document.getElementById('vOrder').value;
            
            if(!activeCID) return alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ±Ø³");
            if(!t || !u) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ±Ø§Ø¨Ø· Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨");
            
            push(ref(db, `folders/${activeCID}/videos`), { 
                title: t, 
                url: u, 
                order: parseInt(o) || 0 
            }).then(() => {
                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
                document.getElementById('vTitle').value = "";
                document.getElementById('vUrl').value = "";
                document.getElementById('vOrder').value = "";
                openEditModal(activeCID, document.getElementById('editNameField').value);
            });
        };

        window.showSection = (id, btn) => {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display='none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
            if(window.innerWidth < 992) toggleSidebar();
        };

        function fillDropdowns(f) {
            let o = "<option value=''>Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option>";
            if(f) Object.keys(f).forEach(id => o += `<option value="${id}">${f[id].name}</option>`);
            document.getElementById('exFolderSelect').innerHTML = o;
        }

        window.filterStudents = () => {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#studentList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.filterResults = () => {
            const search = document.getElementById('resultSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#resultsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.filterLogs = () => {
            const search = document.getElementById('logSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#logsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.filterNotifications = () => {
            const search = document.getElementById('notificationSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#notificationsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.performAdvancedSearch = () => {
            const searchTerm = document.getElementById('advancedSearch').value.trim().toLowerCase();
            if(!searchTerm) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨");
            
            let foundStudent = null;
            let foundUid = null;
            
            // Search in students
            Object.keys(allStudents).forEach(uid => {
                const student = allStudents[uid];
                if(student.name.toLowerCase().includes(searchTerm) || 
                   (student.shortId && student.shortId.toLowerCase().includes(searchTerm))) {
                    foundStudent = student;
                    foundUid = uid;
                }
            });
            
            if(!foundStudent) {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨");
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            // Display student info
            let infoHtml = `
                <div style="background:#f0eeff; padding:20px; border-radius:15px;">
                    <h4 style="color:var(--accent); margin-bottom:10px;">${foundStudent.name}</h4>
                    <p><strong>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> <span class="student-id-display">${foundStudent.shortId || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></p>
                    <p><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${foundStudent.grade || '-'}</p>
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</strong> ${foundStudent.whatsapp || '-'}</p>
                    <p><strong>Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</strong> ${foundStudent.parentPhone || '-'}</p>
                </div>
            `;
            document.getElementById('studentInfo').innerHTML = infoHtml;
            
            // Display courses
            let coursesHtml = "";
            if(allCourseAccess[foundUid]) {
                Object.keys(allCourseAccess[foundUid]).forEach(courseId => {
                    const courseData = allCourseAccess[foundUid][courseId];
                    coursesHtml += `<div class="list-item">
                        <div>
                            <strong>${courseData.courseName}</strong><br>
                            <small style="color:#999;">Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„: ${courseData.firstAccessTime}</small>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('studentCourses').innerHTML = coursesHtml || '<p style="text-align:center; color:#999;">Ù„Ù… ÙŠØ³Ø¬Ù„ ÙÙŠ Ø£ÙŠ ÙƒÙˆØ±Ø³ Ø¨Ø¹Ø¯</p>';
            
            // Display exams and results
            let examsHtml = "";
            if(allResults) {
                Object.keys(allResults).forEach(id => {
                    const result = allResults[id];
                    if(result.studentId === foundStudent.shortId) {
                        examsHtml += `<tr>
                            <td>${result.quiz}</td>
                            <td>${result.score}/${result.total}</td>
                            <td>${result.percentage}%</td>
                            <td>${result.time || '-'}</td>
                        </tr>`;
                    }
                });
            }
            document.getElementById('studentExams').innerHTML = examsHtml || '<tr><td colspan="4" style="text-align:center; color:#999;">Ù„Ù… ÙŠÙƒÙ…Ù„ Ø£ÙŠ Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¹Ø¯</td></tr>';
            
            // Display access logs
            let logsHtml = "";
            if(allLogs) {
                Object.keys(allLogs).forEach(id => {
                    const log = allLogs[id];
                    if(log.studentId === foundStudent.shortId) {
                        logsHtml += `<tr>
                            <td>${log.course}</td>
                            <td>${log.time || '-'}</td>
                        </tr>`;
                    }
                });
            }
            document.getElementById('studentAccessLog').innerHTML = logsHtml || '<tr><td colspan="2" style="text-align:center; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¯Ø®ÙˆÙ„</td></tr>';
            
            document.getElementById('searchResults').style.display = 'block';
        };

        window.delData = (path) => { 
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ")) {
                remove(ref(db, path)).then(() => alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­"));
            }
        };
        
        window.closeModal = () => document.getElementById('editModal').style.display = 'none';
        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
    </script>
</body>
</html>
