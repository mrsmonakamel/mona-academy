<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mona Academy | Pro Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent: #6c5ce7; --dark-bg: #111417; --card-bg: #ffffff;
            --text-main: #2d3436; --danger: #ff7675; --success: #00b894;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: #f0f2f5; color: var(--text-main); overflow-x: hidden; }

        /* Mobile Header */
        .mobile-header {
            display: none; background: var(--dark-bg); color: white;
            padding: 15px; position: sticky; top: 0; z-index: 1001;
            justify-content: space-between; align-items: center;
        }

        /* Sidebar */
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 280px; background: var(--dark-bg); color: white; padding: 25px; 
            position: fixed; height: 100vh; right: 0; transition: 0.4s; z-index: 1000;
        }
        .main-content { margin-right: 280px; flex: 1; padding: 20px; transition: 0.4s; width: 100%; }

        .logo { font-size: 22px; font-weight: 900; text-align: center; margin-bottom: 40px; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 20px; }
        .nav-link { 
            display: flex; align-items: center; gap: 12px; padding: 15px; 
            border-radius: 12px; cursor: pointer; transition: 0.3s; margin-bottom: 10px; color: #a4b0be;
        }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: white; }

        @media (max-width: 992px) {
            .mobile-header { display: flex; }
            .sidebar { right: -280px; }
            .sidebar.open { right: 0; }
            .main-content { margin-right: 0; }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }
            .overlay.active { display: block; }
        }

        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-system { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-top: 8px; font-family: 'Cairo'; outline: none; }
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.3s; }
        .btn-main { background: var(--accent); color: white; width: 100%; }
        .btn-danger { background: #fff0f0; color: var(--danger); border: 1px solid #ff7675; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: right; padding: 12px; background: #f8f9fa; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 10px; }
        .modal-content { background: white; width: 100%; max-width: 800px; border-radius: 25px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }

        #guard-loader { position: fixed; inset: 0; background: var(--dark-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 10px; margin-bottom: 8px; border-right: 5px solid var(--accent); }
    </style>
</head>
<body>

    <div class="mobile-header">
        <span style="font-weight: 900;">لوحة إدارة مـنى</span>
        <i class="fas fa-bars fa-lg" onclick="toggleSidebar()"></i>
    </div>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div id="guard-loader">
        <i class="fas fa-user-shield fa-spin fa-3x" style="color: var(--accent);"></i>
        <h3 style="margin-top: 20px;">التحقق من الهوية...</h3>
    </div>

    <div class="wrapper" id="adminApp" style="display: none;">
        <aside class="sidebar" id="sidebar">
            <div class="logo">Mona Academy</div>
            <div class="nav-link active" onclick="showSection('coursesSection', this)"><i class="fas fa-th-large"></i> إدارة الكورسات</div>
            <div class="nav-link" onclick="showSection('examsSection', this)"><i class="fas fa-edit"></i> مصنع الاختبارات</div>
            <div class="nav-link" onclick="showSection('studentsSection', this)"><i class="fas fa-user-graduate"></i> الطلاب المسجلين</div>
            <div class="nav-link" onclick="showSection('resultsSection', this)"><i class="fas fa-poll-h"></i> درجات الطلاب</div>
            
            <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                <a href="index.html" class="nav-link" style="color: var(--success);"><i class="fas fa-home"></i> العودة للموقع</a>
                <div class="nav-link" onclick="logout()" style="color: var(--danger);"><i class="fas fa-power-off"></i> خروج</div>
            </div>
        </aside>

        <main class="main-content">
            <section id="coursesSection" class="admin-section">
                <div class="card">
                    <h3>إضافة كورس جديد</h3>
                    <div class="grid-system">
                        <input type="text" id="cName" placeholder="اسم الكورس">
                        <input type="file" id="cImg" accept="image/*">
                    </div>
                    <button class="btn btn-main" style="margin-top:15px;" onclick="addCourse()">حفظ الكورس</button>
                </div>
                <div id="coursesGrid" class="grid-system"></div>
            </section>

            <section id="examsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>بناء اختبار جديد</h3>
                    <select id="exFolderSelect"></select>
                    <input type="text" id="exTitle" placeholder="عنوان الاختبار">
                    <div id="questionsArea" style="margin-top: 15px;"></div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" style="background:#eee;" onclick="addNewQuestion('mcq')">+ اختيارات</button>
                        <button class="btn" style="background:#eee;" onclick="addNewQuestion('tf')">+ صح/خطأ</button>
                    </div>
                    <button class="btn btn-main" style="margin-top: 20px;" onclick="saveFinalExam()">نشر الامتحان</button>
                </div>
            </section>

            <section id="studentsSection" class="admin-section" style="display: none;">
                <div class="card"><h3>قائمة الطلاب</h3><div class="table-container"><table><thead><tr><th>الاسم</th><th>المرحلة</th><th>واتساب</th><th>حذف</th></tr></thead><tbody id="studentList"></tbody></table></div></div>
            </section>

            <section id="resultsSection" class="admin-section" style="display: none;">
                <div class="card"><h3>النتائج</h3><div class="table-container"><table><thead><tr><th>الطالب</th><th>الاختبار</th><th>الدرجة</th><th>التوقيت</th><th>حذف</th></tr></thead><tbody id="resultsList"></tbody></table></div></div>
            </section>
        </main>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="editModalTitle">إدارة الكورس</h3>
            <div class="card" style="background:#f9f9f9; margin-top:15px;">
                <label>تعديل الاسم:</label><input type="text" id="editNameField">
                <label>تعديل الصورة:</label><input type="file" id="editImgField">
                <button class="btn btn-main" style="margin-top:10px;" id="saveBasicBtn" onclick="updateCourseBasic()">حفظ البيانات الجديدة</button>
            </div>
            <h4>إضافة فيديو:</h4>
            <input type="text" id="vTitle" placeholder="عنوان الفيديو">
            <input type="text" id="vUrl" placeholder="رابط اليوتيوب">
            <input type="number" id="vOrder" placeholder="الترتيب (1, 2, ..)">
            <button class="btn btn-main" style="margin-top:10px;" onclick="addVideoToCourse()">إضافة الفيديو</button>
            
            <h4 style="margin-top:20px;">المحتوى الحالي (فيديوهات واختبارات):</h4>
            <div id="vListContainer"></div>
            <div id="qListContainer"></div>
            <button class="btn btn-danger" style="width:100%; margin-top:20px;" onclick="closeModal()">إغلاق</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KQAQgu4nIiomoDpoTLnBz_uAtab63sY",
            authDomain: "monaacademy-cd983.firebaseapp.com",
            databaseURL: "https://monaacademy-cd983-default-rtdb.firebaseio.com",
            projectId: "monaacademy-cd983",
            storageBucket: "monaacademy-cd983.appspot.com",
            appId: "1:410646694761:web:bea49c51d3b0ff5eb9cbf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let activeCID = "";

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        };

        onAuthStateChanged(auth, user => {
            if (user && user.email === "mrsmonakamel6@gmail.com") {
                document.getElementById('guard-loader').style.display = 'none';
                document.getElementById('adminApp').style.display = 'flex';
                syncData();
            } else { window.location.href = "login.html"; }
        });

        function syncData() {
            onValue(ref(db, '/'), snap => {
                const data = snap.val() || {};
                renderCourses(data.folders);
                renderStudents(data.students);
                renderResults(data.results);
                fillDropdowns(data.folders);
            });
        }

        window.renderCourses = (folders) => {
            let h = "";
            if(folders) Object.keys(folders).forEach(id => {
                h += `<div class="card" style="text-align:center;">
                    <img src="${folders[id].img || ''}" style="width:65px; height:65px; border-radius:12px; object-fit:cover;">
                    <h4 style="margin:10px 0;">${folders[id].name}</h4>
                    <button class="btn btn-main" onclick="openEditModal('${id}', '${folders[id].name}')">تعديل المحتوى</button>
                    <button class="btn btn-danger" style="width:100%; margin-top:5px;" onclick="delData('folders/${id}')">حذف الكورس</button>
                </div>`;
            });
            document.getElementById('coursesGrid').innerHTML = h;
        };

        window.addCourse = () => {
            const name = document.getElementById('cName').value, file = document.getElementById('cImg').files[0];
            if(!name) return;
            if(file) {
                const r = new FileReader();
                r.onload = () => push(ref(db, 'folders'), { name, img: r.result });
                r.readAsDataURL(file);
            } else push(ref(db, 'folders'), { name });
            alert("تم إنشاء الكورس");
        };

        window.openEditModal = (id, name) => {
            activeCID = id;
            document.getElementById('editNameField').value = name;
            onValue(ref(db, `folders/${id}`), snap => {
                const f = snap.val() || {};
                let vH = "";
                if(f.videos) {
                    Object.entries(f.videos).sort((a,b)=>a[1].order-b[1].order).forEach(([vId, v]) => {
                        vH += `<div class="list-item"><span>${v.order}. ${v.title}</span> <button onclick="delData('folders/${id}/videos/${vId}')" style="color:red; border:none; background:none;">حذف</button></div>`;
                    });
                }
                document.getElementById('vListContainer').innerHTML = vH;
            });
            onValue(ref(db, `quizzes/${id}`), snap => {
                let qH = "";
                snap.forEach(q => {
                    qH += `<div class="list-item"><span>${q.val().name}</span> <button onclick="delData('quizzes/${id}/${q.key}')" style="color:red; border:none; background:none;">حذف</button></div>`;
                });
                document.getElementById('qListContainer').innerHTML = qH;
            });
            document.getElementById('editModal').style.display = 'flex';
        };

        window.updateCourseBasic = async () => {
            const name = document.getElementById('editNameField').value;
            const file = document.getElementById('editImgField').files[0];
            const btn = document.getElementById('saveBasicBtn');
            if(!activeCID) return;
            btn.innerText = "جاري الحفظ..."; btn.disabled = true;

            if(file) {
                const r = new FileReader();
                r.onload = async () => {
                    await update(ref(db, `folders/${activeCID}`), { name, img: r.result });
                    alert("تم التحديث بنجاح"); btn.innerText = "حفظ البيانات الجديدة"; btn.disabled = false;
                };
                r.readAsDataURL(file);
            } else {
                await update(ref(db, `folders/${activeCID}`), { name });
                alert("تم تحديث الاسم"); btn.innerText = "حفظ البيانات الجديدة"; btn.disabled = false;
            }
        };

        window.addNewQuestion = (type) => {
            const q = document.createElement('div');
            q.className = "card"; q.style = "background:#f1f1f1; position:relative; margin-top:10px;";
            q.innerHTML = `<i class="fas fa-trash" style="position:absolute; left:10px; top:10px; color:red; cursor:pointer;" onclick="this.parentElement.remove()"></i>
                <input type="text" class="q-text" placeholder="نص السؤال">
                ${type==='mcq' ? `<div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;"><input type="text" class="oA" placeholder="A"><input type="text" class="oB" placeholder="B"><input type="text" class="oC" placeholder="C"><input type="text" class="oD" placeholder="D"></div>` : ''}
                <select class="q-correct" style="margin-top:5px;"><option value="A">الصح A / صح</option><option value="B">الصح B / خطأ</option><option value="C">الصح C</option><option value="D">الصح D</option></select>`;
            document.getElementById('questionsArea').appendChild(q);
        };

        window.saveFinalExam = () => {
            const fId = document.getElementById('exFolderSelect').value, title = document.getElementById('exTitle').value;
            let qs = [];
            document.querySelectorAll('#questionsArea .card').forEach(c => {
                qs.push({ text: c.querySelector('.q-text').value, options: {A: c.querySelector('.oA')?.value || "صح", B: c.querySelector('.oB')?.value || "خطأ", C: c.querySelector('.oC')?.value || "-", D: c.querySelector('.oD')?.value || "-"}, correct: c.querySelector('.q-correct').value });
            });
            if(fId && title && qs.length) push(ref(db, `quizzes/${fId}`), { name: title, questions: qs }).then(() => { alert("تم النشر"); document.getElementById('questionsArea').innerHTML = ""; });
        };

        function renderStudents(s) {
            let h = "";
            if(s) Object.keys(s).forEach(id => h += `<tr><td>${s[id].name}</td><td>${s[id].grade}</td><td>${s[id].whatsapp}</td><td><button onclick="delData('students/${id}')" class="btn btn-danger">حذف</button></td></tr>`);
            document.getElementById('studentList').innerHTML = h;
        }

        function renderResults(r) {
            let h = "";
            if(r) Object.keys(r).forEach(id => h += `<tr><td>${r[id].student}</td><td>${r[id].exam}</td><td>${r[id].score}%</td><td>${r[id].date || ''}</td><td><button onclick="delData('results/${id}')" class="btn btn-danger">حذف</button></td></tr>`);
            document.getElementById('resultsList').innerHTML = h;
        }

        window.addVideoToCourse = () => {
            const t = document.getElementById('vTitle').value, u = document.getElementById('vUrl').value, o = document.getElementById('vOrder').value;
            if(activeCID && t && u) push(ref(db, `folders/${activeCID}/videos`), { title: t, url: u, order: parseInt(o) || 0 }).then(() => alert("تم إضافة الفيديو"));
        };

        window.showSection = (id, btn) => {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display='none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
            if(window.innerWidth < 992) toggleSidebar();
        };

        function fillDropdowns(f) {
            let o = "<option value=''>اختر الكورس</option>";
            if(f) Object.keys(f).forEach(id => o += `<option value="${id}">${f[id].name}</option>`);
            document.getElementById('exFolderSelect').innerHTML = o;
        }

        window.delData = (path) => { if(confirm("حذف نهائي؟")) remove(ref(db, path)); };
        window.closeModal = () => document.getElementById('editModal').style.display = 'none';
        window.logout = () => signOut(auth);
    </script>
</body>
</html>
