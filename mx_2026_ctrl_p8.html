<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mona Academy | ููุญุฉ ุงูุฅุฏุงุฑุฉ ุงููุชุทูุฑุฉ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ุชุญููู ุงูููุชุจุงุช ุจุดูู ุขูู -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ========== ุงูุฃููุงุท ุงููุญุณูุฉ ========== */
        :root {
            --accent: #6c5ce7;
            --accent-light: #8b7cf0;
            --accent-dark: #4a3bb5;
            --dark-bg: #111417;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --danger: #ff7675;
            --danger-dark: #e74c3c;
            --success: #00b894;
            --success-dark: #01987a;
            --warning: #f1c40f;
            --gold: #ffd700;
            --perfect: #ffb142;
            --border-color: #ddd;
            --hover-bg: #f1f5f9;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 15px 40px rgba(108, 92, 231, 0.15);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* ========== HEADER ูุญุณู ========== */
        .mobile-header {
            display: none;
            background: rgba(17, 20, 23, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1001;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .mobile-header span {
            font-size: 1.3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #fff, #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .mobile-header i {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 12px;
            transition: 0.3s;
            background: rgba(255,255,255,0.1);
        }
        
        .mobile-header i:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        .wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        /* ========== SIDEBAR ูุญุณู ========== */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #1a1f2b, #0f1219);
            color: white;
            padding: 30px 15px;
            position: fixed;
            height: 100vh;
            right: 0;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: -10px 0 30px rgba(0,0,0,0.3);
            border-left: 1px solid rgba(255,255,255,0.05);
        }
        
        .sidebar::-webkit-scrollbar {
            width: 5px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: #2d3436;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }
        
        .main-content {
            margin-right: 300px;
            flex: 1;
            padding: 30px;
            transition: 0.4s;
            width: 100%;
        }
        
        .logo {
            font-size: 26px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #fff, var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-bottom: 2px solid rgba(108, 92, 231, 0.3);
            padding-bottom: 20px;
            letter-spacing: 1px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 8px;
            color: #a4b0be;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: rgba(108, 92, 231, 0.2);
            transition: 0.3s;
            z-index: -1;
        }
        
        .nav-link:hover::before,
        .nav-link.active::before {
            width: 100%;
        }
        
        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            transform: translateX(-5px);
            box-shadow: 0 10px 25px rgba(108, 92, 231, 0.4);
        }
        
        .nav-link i {
            width: 25px;
            text-align: center;
        }
        
        @media (max-width: 992px) {
            .mobile-header {
                display: flex;
            }
            .sidebar {
                right: -300px;
            }
            .sidebar.open {
                right: 0;
                box-shadow: -5px 0 30px rgba(0,0,0,0.5);
            }
            .main-content {
                margin-right: 0;
            }
            .overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                backdrop-filter: blur(5px);
            }
            .overlay.active {
                display: block;
            }
        }
        
        /* ========== CARDS ูุญุณูุฉ ========== */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 60px rgba(108, 92, 231, 0.2);
        }
        
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light), #a29bfe);
        }
        
        .grid-system {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        /* ========== INPUTS ูุญุณูุฉ ========== */
        input,
        select,
        textarea {
            width: 100%;
            padding: 14px 18px;
            border-radius: 15px;
            border: 2px solid rgba(108, 92, 231, 0.1);
            margin-top: 8px;
            font-family: 'Cairo';
            outline: none;
            background: rgba(255,255,255,0.9);
            color: var(--text-main);
            transition: 0.3s;
            font-size: 0.95rem;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.15);
            background: white;
        }
        
        /* ========== BUTTONS ูุญุณูุฉ ========== */
        .btn {
            padding: 14px 28px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Cairo';
            transition: 0.3s;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::after {
            width: 300px;
            height: 300px;
        }
        
        .btn-main {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
        }
        
        .btn-main:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(108, 92, 231, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), var(--danger-dark));
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(255, 118, 117, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 184, 148, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f39c12);
            color: #2d3436;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(241, 196, 15, 0.3);
        }
        
        .btn-pdf {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
        }
        
        .btn-pdf:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(211, 47, 47, 0.3);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        
        /* ========== TABLES ูุญุณูุฉ ========== */
        .table-container {
            overflow-x: auto;
            border-radius: 20px;
            border: 1px solid rgba(108, 92, 231, 0.1);
            margin-top: 20px;
            background: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th {
            text-align: right;
            padding: 18px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--dark-bg);
            border-bottom: 3px solid var(--accent);
        }
        
        td {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(108, 92, 231, 0.1);
            transition: 0.2s;
        }
        
        tr {
            transition: 0.3s;
        }
        
        tr:hover td {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.05), rgba(108, 92, 231, 0.02));
        }
        
        /* ========== MODAL ูุญุณู ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            width: 100%;
            max-width: 1000px;
            border-radius: 40px;
            padding: 35px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 40px 80px rgba(0,0,0,0.3);
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .close-modal-btn {
            position: absolute;
            left: 25px;
            top: 25px;
            background: var(--danger);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            border: none;
            font-size: 1.2rem;
        }
        
        .close-modal-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--danger-dark);
        }
        
        /* ========== LOADER ูุญุณู ========== */
        #guard-loader {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        #guard-loader i {
            animation: spin 1.5s linear infinite, pulse 2s ease-in-out infinite;
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* ========== BADGES ูุญุณูุฉ ========== */
        .student-id-display {
            background: linear-gradient(135deg, #f0eeff, #e5e2ff);
            color: var(--accent);
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
            border: 2px solid var(--accent);
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(108,92,231,0.2);
        }
        
        .progress-badge {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .badge-super {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.8rem;
        }
        
        .badge-exam {
            background: linear-gradient(135deg, var(--warning), #f39c12);
            color: #2d3436;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        .badge-grade {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            display: inline-block;
            margin-right: 5px;
        }
        
        /* ========== LIST ITEMS ูุญุณูุฉ ========== */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-radius: 20px;
            margin-bottom: 10px;
            border-right: 6px solid var(--accent);
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }
        
        .list-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 10px 25px rgba(108,92,231,0.1);
        }
        
        .list-item .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .list-item .item-actions button {
            padding: 8px 15px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        
        .list-item .item-actions .btn-view {
            background: var(--accent);
            color: white;
        }
        
        .list-item .item-actions .btn-edit {
            background: var(--warning);
            color: #2d3436;
        }
        
        .list-item .item-actions .btn-delete {
            background: var(--danger);
            color: white;
        }
        
        .list-item .item-actions button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* ========== STATS CARDS ูุญุณูุฉ ========== */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .analytics-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
        }
        
        .analytics-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 60px rgba(108, 92, 231, 0.2);
        }
        
        .analytics-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.2rem;
            box-shadow: 0 10px 20px rgba(108,92,231,0.3);
        }
        
        .analytics-info h4 {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .analytics-info .number {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* ========== LEADERBOARD ========== */
        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 25px;
            border-bottom: 1px solid rgba(108,92,231,0.1);
            transition: 0.3s;
            font-weight: 600;
        }
        
        .leaderboard-row:hover {
            background: linear-gradient(135deg, rgba(108,92,231,0.05), rgba(108,92,231,0.02));
            transform: translateX(-5px);
        }
        
        .leaderboard-row:first-child {
            background: linear-gradient(135deg, var(--gold), #f39c12);
            color: #2d3436;
            border-radius: 15px 15px 0 0;
            font-weight: 900;
        }
        
        .leaderboard-rank {
            font-weight: 900;
            color: var(--accent);
            margin-left: 15px;
        }
        
        /* ========== TOAST NOTIFICATIONS ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
        }
        
        .toast-message {
            background: white;
            color: var(--text-main);
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s, fadeOut 0.3s 2.7s;
            border-right: 4px solid var(--success);
            backdrop-filter: blur(10px);
        }
        
        .toast-message.error {
            border-right-color: var(--danger);
        }
        
        .toast-message.warning {
            border-right-color: var(--warning);
        }
        
        .toast-message i {
            font-size: 1.2rem;
        }
        
        .toast-message.success i {
            color: var(--success);
        }
        
        .toast-message.error i {
            color: var(--danger);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        /* ========== EXAM EDIT STYLES ========== */
        .edit-question-card {
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(108,92,231,0.1);
            position: relative;
            transition: 0.3s;
        }
        
        .edit-question-card:hover {
            border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(108,92,231,0.1);
        }
        
        .edit-question-card .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed rgba(108,92,231,0.2);
        }
        
        .edit-question-card .question-number {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .edit-question-card .question-actions {
            display: flex;
            gap: 10px;
        }
        
        .edit-question-card .question-actions i {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: 0.3s;
            font-size: 1rem;
        }
        
        .edit-question-card .question-actions .fa-copy {
            background: rgba(108,92,231,0.1);
            color: var(--accent);
        }
        
        .edit-question-card .question-actions .fa-trash {
            background: rgba(255,118,117,0.1);
            color: var(--danger);
        }
        
        .edit-question-card .question-actions i:hover {
            transform: scale(1.2);
        }
        
        .edit-question-card .question-actions .fa-copy:hover {
            background: var(--accent);
            color: white;
        }
        
        .edit-question-card .question-actions .fa-trash:hover {
            background: var(--danger);
            color: white;
        }
        
        .question-type-selector {
            margin-bottom: 15px;
        }
        
        .mcq-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .mcq-options > div {
            background: rgba(108,92,231,0.03);
            padding: 15px;
            border-radius: 15px;
        }
        
        .mcq-options label {
            display: block;
            margin-bottom: 5px;
            color: var(--accent);
            font-weight: bold;
        }
        
        /* ========== PREVIEW EXAM STYLES ========== */
        .preview-exam {
            background: white;
            border-radius: 30px;
            padding: 30px;
            direction: rtl;
        }
        
        .preview-exam h2 {
            color: var(--accent);
            margin-bottom: 30px;
            text-align: center;
            font-weight: 900;
        }
        
        .preview-question {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border-right: 6px solid var(--accent);
        }
        
        .preview-question h4 {
            color: var(--dark-bg);
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .preview-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .preview-option {
            padding: 15px 20px;
            background: white;
            border-radius: 15px;
            border: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.3s;
        }
        
        .preview-option.correct {
            background: #d4edda;
            border-color: var(--success);
        }
        
        .preview-option .correct-badge {
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            margin-right: auto;
        }
        
        .preview-tf {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .preview-tf-option {
            flex: 1;
            padding: 20px;
            text-align: center;
            border-radius: 15px;
            background: white;
            border: 2px solid #eee;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .preview-tf-option.correct {
            background: #d4edda;
            border-color: var(--success);
        }
        
        /* ========== ANIMATIONS ========== */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        /* ========== IMAGE UPLOAD ========== */
        .image-preview {
            display: none;
            margin: 15px 0;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 15px;
            border: 4px solid var(--accent);
            box-shadow: 0 5px 15px rgba(108,92,231,0.3);
        }
        
        .file-input {
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 2px dashed var(--accent);
            cursor: pointer;
            margin: 10px 0;
        }
        
        .file-input:hover {
            background: #f0eeff;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                padding: 20px;
            }
            .mcq-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-header">
        <span>ููุญุฉ ุฅุฏุงุฑุฉ ูููู</span>
        <div style="display: flex; gap: 10px;">
            <i class="fas fa-bars fa-lg" onclick="toggleSidebar()"></i>
        </div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div id="guard-loader">
        <i class="fas fa-user-shield"></i>
        <h3 style="margin-top: 20px; font-size: 1.5rem;">ุงูุชุญูู ูู ุงููููุฉ...</h3>
        <p style="opacity: 0.8;">ุฌุงุฑู ุงูุชุญููู</p>
    </div>

    <div class="wrapper" id="adminApp" style="display: none;">
        <aside class="sidebar" id="sidebar">
            <div class="logo">Mona Academy</div>
            <div class="nav-link active" onclick="showSection('coursesSection', this)">
                <i class="fas fa-th-large"></i> ุฅุฏุงุฑุฉ ุงูููุฑุณุงุช
            </div>
            <div class="nav-link" onclick="showSection('examsSection', this)">
                <i class="fas fa-edit"></i> ูุตูุน ุงูุงุฎุชุจุงุฑุงุช
            </div>
            <div class="nav-link" onclick="showSection('studentSearchSection', this)">
                <i class="fas fa-search"></i> ุจุญุซ ูุชูุฏู ุนู ุงูุทูุงุจ
            </div>
            <div class="nav-link" onclick="showSection('studentsSection', this)">
                <i class="fas fa-user-graduate"></i> ุงูุทูุงุจ ุงููุณุฌููู
            </div>
            <div class="nav-link" onclick="showSection('resultsSection', this)">
                <i class="fas fa-poll-h"></i> ุฏุฑุฌุงุช ุงูุทูุงุจ
            </div>
            <div class="nav-link" onclick="showSection('accessLogsSection', this)">
                <i class="fas fa-history"></i> ุณุฌู ุงูุฏุฎูู ููููุฑุณุงุช
            </div>
            <div class="nav-link" onclick="showSection('notificationsSection', this)">
                <i class="fas fa-bell"></i> ุฅุดุนุงุฑุงุช ุฏุฎูู ุงูููุฑุณุงุช
            </div>
            <div class="nav-link" onclick="showSection('subscriptionNotificationsSection', this)">
                <i class="fas fa-user-plus"></i> ุฅุดุนุงุฑุงุช ุงูุงุดุชุฑุงูุงุช
            </div>
            <div class="nav-link" onclick="showSection('reviewsSection', this)">
                <i class="fas fa-comments"></i> ุขุฑุงุก ุงูุทูุงุจ
            </div>
            <div class="nav-link" onclick="showSection('adminsSection', this)">
                <i class="fas fa-user-shield"></i> ุฅุฏุงุฑุฉ ุงูุฃุฏููุฒ
            </div>
            <div class="nav-link" onclick="showSection('perfectScoresSection', this)">
                <i class="fas fa-trophy"></i> ุงูุฏุฑุฌุงุช ุงูููุงุฆูุฉ
            </div>
            <div class="nav-link" onclick="showSection('analyticsSection', this)">
                <i class="fas fa-chart-line"></i> ุงูุชุญูููุงุช
            </div>
            <div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <a href="index.html" class="nav-link" style="color: var(--success);">
                    <i class="fas fa-home"></i> ุงูุนูุฏุฉ ูููููุน
                </a>
                <div class="nav-link" onclick="logout()" style="color: var(--danger);">
                    <i class="fas fa-power-off"></i> ุฎุฑูุฌ
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- ========== ุฅุฏุงุฑุฉ ุงูููุฑุณุงุช (ูุญุฏุซ ูุน ุฅุถุงูุฉ ุญูู ุงููุฑุญูุฉ) ========== -->
            <section id="coursesSection" class="admin-section">
                <div class="card">
                    <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <i class="fas fa-plus-circle" style="color: var(--accent);"></i>
                        ุฅุถุงูุฉ ููุฑุณ ุฌุฏูุฏ
                    </h3>
                    <div class="grid-system">
                        <input type="text" id="cName" placeholder="ุงุณู ุงูููุฑุณ">
                        <input type="url" id="cImgUrl" placeholder="https://... (ุฑุงุจุท ุงูุตูุฑุฉ)" dir="ltr">
                    </div>
                    
                    <!-- ุญูู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ:</label>
                        <select id="cGrade" class="reg-input">
                            <option value="">-- ุงุฎุชุฑ ุงููุฑุญูุฉ --</option>
                            <option value="ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู">ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู</option>
                            <option value="ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู">ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู</option>
                            <option value="ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู">ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู</option>
                            <option value="ุงูุฃูู ุงูุฅุนุฏุงุฏู">ุงูุฃูู ุงูุฅุนุฏุงุฏู</option>
                            <option value="ุงูุซุงูู ุงูุฅุนุฏุงุฏู">ุงูุซุงูู ุงูุฅุนุฏุงุฏู</option>
                            <option value="ุงูุซุงูุซ ุงูุฅุนุฏุงุฏู">ุงูุซุงูุซ ุงูุฅุนุฏุงุฏู</option>
                            <option value="ุงูุฃูู ุงูุซุงููู">ุงูุฃูู ุงูุซุงููู</option>
                            <option value="ุงูุซุงูู ุงูุซุงููู">ุงูุซุงูู ุงูุซุงููู</option>
                            <option value="ุงูุซุงูุซ ุงูุซุงููู">ุงูุซุงูุซ ุงูุซุงููู</option>
                        </select>
                    </div>
                    
                    <!-- ุญูู ุฑูุน ุงูุตูุฑ ูู ุงูุฌูุงุฒ -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">ุฃู ุงุฑูุน ุตูุฑุฉ ูู ุฌูุงุฒู:</label>
                        <input type="file" id="cImageFile" accept="image/*" class="file-input" style="width: 100%;">
                        <div id="imagePreview" class="image-preview">
                            <img id="previewImg" src="" alt="ูุนุงููุฉ ุงูุตูุฑุฉ">
                        </div>
                    </div>
                    
                    <button class="btn btn-main" style="margin-top:20px;" onclick="addCourse()">
                        <i class="fas fa-save"></i> ุญูุธ ุงูููุฑุณ
                    </button>
                </div>
                <div id="coursesGrid" class="grid-system"></div>
            </section>

            <!-- ========== ูุตูุน ุงูุงุฎุชุจุงุฑุงุช ========== -->
            <section id="examsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-pen"></i>
                        ุจูุงุก ุงุฎุชุจุงุฑ ุฌุฏูุฏ
                    </h3>
                    <select id="exFolderSelect"></select>
                    <input type="text" id="exTitle" placeholder="ุนููุงู ุงูุงุฎุชุจุงุฑ">
                    <label style="margin-top: 15px; display: block; font-weight: bold;">ุฑุจุท ุงูุงูุชุญุงู ุจู:</label>
                    <select id="exVideoRel">
                        <option value="all">ุงูุชุญุงู ุดุงูู (ูุธูุฑ ูุน ูู ุงูููุฏูููุงุช)</option>
                    </select>
                    <div id="questionsArea" style="margin-top: 20px;"></div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="addNewQuestion('mcq')" style="flex:1;">
                            <i class="fas fa-list"></i> + ุงุฎุชูุงุฑุงุช
                        </button>
                        <button class="btn btn-warning" onclick="addNewQuestion('tf')" style="flex:1;">
                            <i class="fas fa-check-circle"></i> + ุตุญ/ุฎุทุฃ
                        </button>
                    </div>
                    <button class="btn btn-main" style="margin-top: 25px;" onclick="saveFinalExam()">
                        <i class="fas fa-cloud-upload-alt"></i> ูุดุฑ ุงูุงูุชุญุงู
                    </button>
                </div>
            </section>

            <!-- ========== ุจุญุซ ูุชูุฏู ุนู ุงูุทูุงุจ ========== -->
            <section id="studentSearchSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-search" style="margin-left: 10px;"></i> ุจุญุซ ูุชูุฏู ุนู ุงูุทูุงุจ</h3>
                    <p style="color: #666; margin-bottom: 20px;">ุงุจุญุซ ุจุงูุงุณู ุฃู ููุฏ ุงูุทุงูุจ ููุญุตูู ุนูู ุฌููุน ุงููุนูููุงุช ูุงููุดุงุทุงุช</p>
                    <input type="text" id="advancedSearch" placeholder="ุงูุชุจ ุงุณู ุงูุทุงูุจ ุฃู ููุฏ ุงูุทุงูุจ..." style="font-size: 1.1rem;">
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-main" style="flex: 2;" onclick="performAdvancedSearch()">
                            <i class="fas fa-search"></i> ุจุญุซ
                        </button>
                        <button class="btn btn-danger" style="flex: 1;" onclick="clearAdvancedSearch()">
                            <i class="fas fa-times"></i> ุฅูุบุงุก
                        </button>
                    </div>
                </div>
                <div id="searchResults" style="display: none;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                            <h3><i class="fas fa-user-graduate"></i> ูุนูููุงุช ุงูุทุงูุจ</h3>
                            <button class="btn btn-pdf btn-sm" onclick="exportStudentPDF()">
                                <i class="fas fa-file-pdf"></i> ุชุตุฏูุฑ PDF
                            </button>
                        </div>
                        <div id="studentInfo" class="grid-system"></div>
                    </div>
                    <div class="card"><h3><i class="fas fa-book"></i> ุงูุงุดุชุฑุงูุงุช ูู ุงูููุฑุณุงุช</h3><div id="studentSubscriptions"></div></div>
                    <div class="card"><h3><i class="fas fa-video"></i> ุงูููุฏูููุงุช ุงููุดุงูุฏุฉ</h3><div id="studentWatchedVideos"></div></div>
                    <div class="card">
                        <h3><i class="fas fa-poll"></i> ูุชุงุฆุฌ ุงูุงูุชุญุงูุงุช (ูู ุณุฌู ุงูุทุงูุจ)</h3>
                        <div class="table-container"><table><thead><tr><th>ุงูุงุฎุชุจุงุฑ</th><th>ุงูุฏุฑุฌุฉ</th><th>ุงููุณุจุฉ</th><th>ุงูุชูููุช</th></tr></thead><tbody id="studentExamResults"></tbody></table></div>
                    </div>
                    <div class="card"><h3><i class="fas fa-door-open"></i> ุงูููุฑุณุงุช ุงููุณุฌู ูููุง (ุฏุฎูู)</h3><div id="studentCourses"></div></div>
                    <div class="card">
                        <h3><i class="fas fa-file-alt"></i> ุงูุงูุชุญุงูุงุช ูุงูุฏุฑุฌุงุช (ูู ุงูุณุฌู ุงูุนุงู)</h3>
                        <div class="table-container"><table><thead><tr><th>ุงูุงุฎุชุจุงุฑ</th><th>ุงูุฏุฑุฌุฉ</th><th>ุงููุณุจุฉ</th><th>ุงูุชูููุช</th></tr></thead><tbody id="studentExams"></tbody></table></div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-clock"></i> ุณุฌู ุงูุฏุฎูู ููููุฑุณุงุช</h3>
                        <div class="table-container"><table><thead><tr><th>ุงูููุฑุณ</th><th>ููุช ุงูุฏุฎูู</th></tr></thead><tbody id="studentAccessLog"></tbody></table></div>
                    </div>
                </div>
            </section>

            <!-- ========== ุงูุทูุงุจ ุงููุณุฌููู ========== -->
            <section id="studentsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-users"></i> ูุงุฆูุฉ ุงูุทูุงุจ <span style="color: var(--accent);" id="studentCount"></span></h3>
                    <input type="text" id="studentSearch" placeholder="๐ ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ ุฃู ุงูุฅูููู..." style="margin-bottom: 15px;" onkeyup="filterStudents()">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ุงูุงุณู</th><th>ููุฏ ุงูุทุงูุจ</th><th>ุงููุฑุญูุฉ</th><th>ูุงุชุณุงุจ</th><th>ููู ุงูุฃูุฑ</th><th>ุทุฑููุฉ ุงูุชุณุฌูู</th><th>ุงูุงุดุชุฑุงูุงุช</th><th>ุงูููุงุท</th><th>ุญุฐู</th></tr></thead>
                            <tbody id="studentList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== ุฏุฑุฌุงุช ุงูุทูุงุจ ========== -->
            <section id="resultsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-chart-bar"></i> ุงููุชุงุฆุฌ <span style="color: var(--accent);" id="resultsCount"></span></h3>
                    <input type="text" id="resultSearch" placeholder="๐ ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ..." style="margin-bottom: 15px;" onkeyup="filterResults()">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ุงูุทุงูุจ</th><th>ููุฏ ุงูุทุงูุจ</th><th>ุงูุงุฎุชุจุงุฑ</th><th>ุงูุฏุฑุฌุฉ</th><th>ุงููุณุจุฉ</th><th>ุงูุชูููุช</th><th>ุญุฐู</th></tr></thead>
                            <tbody id="resultsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== ุณุฌู ุงูุฏุฎูู ููููุฑุณุงุช ========== -->
            <section id="accessLogsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-history"></i> ุณุฌู ุงูุฏุฎูู ููููุฑุณุงุช <span style="color: var(--accent);" id="logsCount"></span></h3>
                    <input type="text" id="logSearch" placeholder="๐ ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ ุฃู ุงูููุฑุณ..." style="margin-bottom: 15px;" onkeyup="filterLogs()">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ุงูุทุงูุจ</th><th>ููุฏ ุงูุทุงูุจ</th><th>ุงูููุฑุณ</th><th>ุงูุชูููุช</th><th>ุญุฐู</th></tr></thead>
                            <tbody id="logsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== ุฅุดุนุงุฑุงุช ุฏุฎูู ุงูููุฑุณุงุช ========== -->
            <section id="notificationsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-bell"></i> ุฅุดุนุงุฑุงุช ุฏุฎูู ุงูุทูุงุจ ููููุฑุณุงุช <span style="color: var(--accent);" id="notificationsCount"></span></h3>
                    <p style="color: #666; margin-bottom: 15px;">ูุฐู ูุงุฆูุฉ ุจุงูุทูุงุจ ุงูุฐูู ุฏุฎููุง ุงูููุฑุณุงุช ูุฃูู ูุฑุฉ</p>
                    <input type="text" id="notificationSearch" placeholder="๐ ุงุจุญุซ..." style="margin-bottom: 15px;" onkeyup="filterNotifications()">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ุงุณู ุงูุทุงูุจ</th><th>ููุฏ ุงูุทุงูุจ</th><th>ุงุณู ุงูููุฑุณ</th><th>ููุช ุฃูู ุฏุฎูู</th><th>ุญุฐู</th></tr></thead>
                            <tbody id="notificationsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== ุฅุดุนุงุฑุงุช ุงูุงุดุชุฑุงูุงุช ========== -->
            <section id="subscriptionNotificationsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-user-plus"></i> ุฅุดุนุงุฑุงุช ุงุดุชุฑุงูุงุช ุงูุทูุงุจ ูู ุงูููุฑุณุงุช <span style="color: var(--accent);" id="subscriptionNotificationsCount"></span></h3>
                    <p style="color: #666; margin-bottom: 15px;">ูุฐู ูุงุฆูุฉ ุจุงูุทูุงุจ ุงูุฐูู ุงุดุชุฑููุง ูู ุงูููุฑุณุงุช</p>
                    <input type="text" id="subscriptionNotificationSearch" placeholder="๐ ุงุจุญุซ..." style="margin-bottom: 15px;" onkeyup="filterSubscriptionNotifications()">
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ุงุณู ุงูุทุงูุจ</th><th>ููุฏ ุงูุทุงูุจ</th><th>ุงุณู ุงูููุฑุณ</th><th>ุชุงุฑูุฎ ุงูุงุดุชุฑุงู</th><th>ุญุฐู</th></tr></thead>
                            <tbody id="subscriptionNotificationsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== ุขุฑุงุก ุงูุทูุงุจ ========== -->
            <section id="reviewsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-comments"></i> ุขุฑุงุก ุงูุทูุงุจ <span style="color: var(--accent);" id="reviewsCount"></span></h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ุงูุทุงูุจ</th><th>ุงูุฑุฃู</th><th>ุงูุชูููู</th><th>ุญุฐู</th></tr></thead>
                            <tbody id="reviewsList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== ุฅุฏุงุฑุฉ ุงูุฃุฏููุฒ ========== -->
            <section id="adminsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-user-shield"></i> ุฅุถุงูุฉ ุฃุฏูู ุฌุฏูุฏ</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="email" id="newAdminEmail" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุฃุฏูู" style="flex: 2;">
                        <input type="text" id="newAdminName" placeholder="ุงุณู ุงูุฃุฏูู" style="flex: 1;">
                        <button class="btn btn-success" style="flex: 0.5;" onclick="addAdmin()">
                            <i class="fas fa-user-plus"></i> ุฅุถุงูุฉ
                        </button>
                    </div>
                    <p style="color: #666; font-size: 0.85rem; margin-top: 5px;">ุณูุชููู ุงูุฃุฏูู ูู ุงูุฏุฎูู ุฅูู ููุญุฉ ุงูุชุญูู ุจุงุณุชุฎุฏุงู ุญุณุงุจู ูู ุฌูุฌู</p>
                </div>
                <div class="card">
                    <h3><i class="fas fa-list"></i> ูุงุฆูุฉ ุงูุฃุฏููุฒ ุงูุญุงูููู</h3>
                    <div id="adminsList" style="margin-top: 15px;"></div>
                </div>
            </section>

            <!-- ========== ุงูุฏุฑุฌุงุช ุงูููุงุฆูุฉ ========== -->
            <section id="perfectScoresSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-trophy" style="color: var(--gold);"></i> ุทูุงุจ ุงูุฏุฑุฌุฉ ุงูููุงุฆูุฉ <span style="color: var(--accent);" id="perfectScoresCount"></span></h3>
                    <p style="color: #666; margin-bottom: 15px;">ูุฐู ูุงุฆูุฉ ุจุฌููุน ุงูุทูุงุจ ุงูุฐูู ุญุตููุง ุนูู ุงูุฏุฑุฌุฉ ุงููุงููุฉ ูู ุงูุงูุชุญุงูุงุช. ููููู ุญุฐู ุฃู ูุชูุฌุฉ ูุฅุนุงุฏุฉ ูุชุญ ุงูุงูุชุญุงู ููุทุงูุจ.</p>
                    <input type="text" id="perfectScoreSearch" placeholder="๐ ุงุจุญุซ ุจุงุณู ุงูุทุงูุจ ุฃู ุงูููุฏ ุฃู ุงูุงูุชุญุงู..." style="margin-bottom: 15px;" onkeyup="filterPerfectScores()">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ุงุณู ุงูุทุงูุจ</th>
                                    <th>ููุฏ ุงูุทุงูุจ</th>
                                    <th>ุงูุงูุชุญุงู</th>
                                    <th>ุงูุตู ุงูุฏุฑุงุณู</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงูุฏุฑุฌุฉ</th>
                                    <th>ุญุฐู</th>
                                </tr>
                            </thead>
                            <tbody id="perfectScoresList"></tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 15px; border-right: 5px solid var(--gold);">
                        <i class="fas fa-info-circle" style="color: var(--gold); margin-left: 8px;"></i>
                        <strong>ุชูุจูู:</strong> ุญุฐู ูุชูุฌุฉ ุงูุทุงูุจ ุณูุณูุญ ูู ุจุฅุนุงุฏุฉ ุงูุงูุชุญุงู ูุฑุฉ ุฃุฎุฑูุ ูุณูุชู ุฅุฒุงูุชูุง ูู ูุงุฆูุฉ ุงูุฏุฑุฌุงุช ุงูููุงุฆูุฉ ูู ุงููููุน ุงูุฑุฆูุณู.
                    </div>
                </div>
            </section>

            <!-- ========== ุงูุชุญูููุงุช ูุงูุฅุญุตุงุฆูุงุช ========== -->
            <section id="analyticsSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3><i class="fas fa-chart-line"></i> ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูููุตุฉ</h3>
                    <div class="analytics-grid" id="analyticsSummary"></div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-video"></i> ุฃูุซุฑ ุงูููุฑุณุงุช ูุดุงูุฏุฉ</h3>
                    <div class="chart-container">
                        <canvas id="topCoursesChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-chart-pie"></i> ุชูุฒูุน ุฏุฑุฌุงุช ุงูุงูุชุญุงูุงุช</h3>
                    <div class="chart-container">
                        <canvas id="examScoresChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-calendar-alt"></i> ูุดุงุท ุงูุทูุงุจ (ุขุฎุฑ 7 ุฃูุงู)</h3>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-crown" style="color: var(--gold);"></i> ููุญุฉ ุงููุชุตุฏุฑูู</h3>
                    <div id="adminLeaderboard" class="leaderboard-table" style="margin-top: 0;"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- ========== ููุฏุงู ุชุนุฏูู ุงูููุฑุณ (ูุน ุฅุถุงูุฉ ุญูู ุงููุฑุญูุฉ) ========== -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <h3 style="color: var(--accent); margin-bottom: 25px;">
                <i class="fas fa-edit"></i> ุฅุฏุงุฑุฉ ุงูููุฑุณ
            </h3>
            
            <div class="card" style="background: linear-gradient(145deg, #f8f9fa, #ffffff); margin-bottom: 25px;">
                <label style="font-weight: bold;">ุชุนุฏูู ุงูุงุณู:</label>
                <input type="text" id="editNameField" style="margin-bottom: 15px;">
                
                <label style="font-weight: bold;">ุชุนุฏูู ุงูุตูุฑุฉ (ุฑุงุจุท):</label>
                <input type="url" id="editImgField" placeholder="https://... (ุฑุงุจุท ุงูุตูุฑุฉ ุงูุฌุฏูุฏุฉ)" dir="ltr" style="margin-bottom: 15px;">
                
                <!-- ุญูู ุชุนุฏูู ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ -->
                <label style="font-weight: bold; margin-top: 15px;">ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ:</label>
                <select id="editGradeField" class="reg-input" style="margin-bottom: 15px;">
                    <option value="">-- ุงุฎุชุฑ ุงููุฑุญูุฉ --</option>
                    <option value="ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู">ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู</option>
                    <option value="ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู">ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู</option>
                    <option value="ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู">ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู</option>
                    <option value="ุงูุฃูู ุงูุฅุนุฏุงุฏู">ุงูุฃูู ุงูุฅุนุฏุงุฏู</option>
                    <option value="ุงูุซุงูู ุงูุฅุนุฏุงุฏู">ุงูุซุงูู ุงูุฅุนุฏุงุฏู</option>
                    <option value="ุงูุซุงูุซ ุงูุฅุนุฏุงุฏู">ุงูุซุงูุซ ุงูุฅุนุฏุงุฏู</option>
                    <option value="ุงูุฃูู ุงูุซุงููู">ุงูุฃูู ุงูุซุงููู</option>
                    <option value="ุงูุซุงูู ุงูุซุงููู">ุงูุซุงูู ุงูุซุงููู</option>
                    <option value="ุงูุซุงูุซ ุงูุซุงููู">ุงูุซุงูุซ ุงูุซุงููู</option>
                </select>
                
                <!-- ุญูู ุฑูุน ุตูุฑุฉ ุฌุฏูุฏุฉ ูู ุงูุฌูุงุฒ -->
                <div style="margin-top: 15px;">
                    <label style="font-weight: bold;">ุฃู ุงุฑูุน ุตูุฑุฉ ุฌุฏูุฏุฉ:</label>
                    <input type="file" id="editImageFile" accept="image/*" class="file-input" style="width: 100%; margin-top: 10px;">
                    <div id="editImagePreview" class="image-preview">
                        <img id="editPreviewImg" src="" alt="ูุนุงููุฉ ุงูุตูุฑุฉ">
                    </div>
                </div>
                
                <button class="btn btn-main" id="saveBasicBtn" onclick="updateCourseBasic()" style="margin-top: 15px;">
                    <i class="fas fa-save"></i> ุญูุธ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
                </button>
            </div>
            
            <h4 style="margin: 20px 0 15px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-plus-circle" style="color: var(--success);"></i>
                ุฅุถุงูุฉ ููุฏูู ุฌุฏูุฏ
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="text" id="vTitle" placeholder="ุนููุงู ุงูููุฏูู">
                <input type="text" id="vUrl" placeholder="ุฑุงุจุท ุงูููุชููุจ" dir="ltr">
            </div>
            <input type="number" id="vOrder" placeholder="ุงูุชุฑุชูุจ (1, 2, ..)" style="margin-top: 15px;">
            <button class="btn btn-success" style="margin-top:15px; width:100%;" onclick="addVideoToCourse()">
                <i class="fas fa-video"></i> ุฅุถุงูุฉ ุงูููุฏูู
            </button>
            
            <h4 style="margin: 25px 0 15px;"><i class="fas fa-list"></i> ุงููุญุชูู ุงูุญุงูู</h4>
            
            <div style="margin-bottom: 20px;">
                <h5 style="color: var(--accent); margin-bottom: 10px;">
                    <i class="fas fa-video"></i> ุงูููุฏูููุงุช:
                </h5>
                <div id="vListContainer"></div>
            </div>
            
            <div>
                <h5 style="color: var(--warning); margin-bottom: 10px;">
                    <i class="fas fa-file-alt"></i> ุงูุงุฎุชุจุงุฑุงุช:
                </h5>
                <div id="qListContainer"></div>
            </div>
        </div>
    </div>

    <!-- ========== ููุฏุงู ุชุนุฏูู ุงูููุฏูู ========== -->
    <div id="editVideoModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-modal-btn" onclick="closeVideoModal()"><i class="fas fa-times"></i></button>
            <h3 style="color: var(--accent); margin-bottom: 25px;">
                <i class="fas fa-video"></i> ุชุนุฏูู ุงูููุฏูู
            </h3>
            
            <input type="hidden" id="editVideoCourseId">
            <input type="hidden" id="editVideoId">
            
            <label style="font-weight: bold;">ุนููุงู ุงูููุฏูู:</label>
            <input type="text" id="editVideoTitle" placeholder="ุฃุฏุฎู ุงูุนููุงู ุงูุฌุฏูุฏ" style="margin-bottom: 20px;">
            
            <label style="font-weight: bold;">ุฑุงุจุท ุงูููุชููุจ:</label>
            <input type="text" id="editVideoUrl" placeholder="https://youtube.com/..." dir="ltr" style="margin-bottom: 20px;">
            
            <label style="font-weight: bold;">ุงูุชุฑุชูุจ:</label>
            <input type="number" id="editVideoOrder" placeholder="ุฑูู ุงูุชุฑุชูุจ" style="margin-bottom: 25px;">
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-main" onclick="saveVideoChanges()" style="flex: 2;">
                    <i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช
                </button>
                <button class="btn btn-danger" onclick="closeVideoModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> ุฅูุบุงุก
                </button>
            </div>
        </div>
    </div>

    <!-- ========== ููุฏุงู ุชุนุฏูู ุงูุงูุชุญุงู ========== -->
    <div id="editExamModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-modal-btn" onclick="closeExamModal()"><i class="fas fa-times"></i></button>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="color: var(--accent);">
                    <i class="fas fa-edit"></i> ุชุนุฏูู ุงูุงูุชุญุงู
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success btn-sm" onclick="previewExam()">
                        <i class="fas fa-eye"></i> ูุนุงููุฉ ุงูุงูุชุญุงู
                    </button>
                </div>
            </div>
            
            <input type="hidden" id="editExamCourseId">
            <input type="hidden" id="editExamId">
            
            <div class="card" style="background: linear-gradient(145deg, #f8f9fa, #ffffff); margin-bottom: 25px;">
                <label style="font-weight: bold;">ุงุณู ุงูุงูุชุญุงู:</label>
                <input type="text" id="editExamName" class="reg-input" placeholder="ุฃุฏุฎู ุงุณู ุงูุงูุชุญุงู" style="margin-bottom: 15px;">
                
                <label style="font-weight: bold;">ุฑุจุท ุงูุงูุชุญุงู ุจู:</label>
                <select id="editExamVideoRel" class="reg-input" style="margin-bottom: 15px;">
                    <option value="all">ุงูุชุญุงู ุดุงูู (ูุธูุฑ ูุน ูู ุงูููุฏูููุงุช)</option>
                </select>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                <h4><i class="fas fa-question-circle"></i> ุงูุฃุณุฆูุฉ</h4>
                <div>
                    <button class="btn btn-success btn-sm" onclick="addEditQuestion('mcq')">
                        <i class="fas fa-plus"></i> ุณุคุงู ุงุฎุชูุงุฑุงุช
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="addEditQuestion('tf')" style="margin-right: 10px;">
                        <i class="fas fa-plus"></i> ุณุคุงู ุตุญ/ุฎุทุฃ
                    </button>
                </div>
            </div>
            
            <div id="editQuestionsArea" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-main" onclick="saveExamChanges()" style="flex: 2;">
                    <i class="fas fa-save"></i> ุญูุธ ุงูุชุบููุฑุงุช
                </button>
                <button class="btn btn-danger" onclick="deleteExam()" style="flex: 1;">
                    <i class="fas fa-trash"></i> ุญุฐู ุงูุงูุชุญุงู
                </button>
            </div>
        </div>
    </div>

    <!-- ========== ููุฏุงู ูุนุงููุฉ ุงูุงูุชุญุงู ========== -->
    <div id="previewExamModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-modal-btn" onclick="closePreviewModal()"><i class="fas fa-times"></i></button>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--accent);">
                    <i class="fas fa-eye"></i> ูุนุงููุฉ ุงูุงูุชุญุงู
                </h3>
            </div>
            
            <div id="previewExamContent" class="preview-exam" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- ========== TOAST CONTAINER ========== -->
    <div id="toastContainer" class="toast-container"></div>

    <script type="module">
        // ================ FIREBASE IMPORTS ================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ================ CONFIG ================
        const firebaseConfig = {
            apiKey: "AIzaSyA8KQAQgu4nIiomoDpoTLnBz_uAtab63sY",
            authDomain: "monaacademy-cd983.firebaseapp.com",
            databaseURL: "https://monaacademy-cd983-default-rtdb.firebaseio.com",
            projectId: "monaacademy-cd983",
            storageBucket: "monaacademy-cd983.appspot.com",
            appId: "1:410646694761:web:bea49c51d3b0ff5eb9cbf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // ================ GLOBAL VARIABLES ================
        let activeCID = "";
        let allStudents = {};
        let allResults = {};
        let allLogs = {};
        let allNotifications = {};
        let allCourseAccess = {};
        let allFolders = {};
        let allSubscriptionNotifications = {};
        let allReviews = {};
        let allPerfectScores = [];
        let chartsInitialized = false;
        let topCoursesChart, examScoresChart, activityChart;
        let dataListeners = [];

        const SUPER_ADMIN_EMAIL = "mrsmonakamel6@gmail.com";
        let allAdmins = {};

        let currentStudentData = null;
        let currentStudentUid = null;
        let currentEditingExam = null;

        // ================ ุฏุงูุฉ escapeHTML (ููุญูุงูุฉ ูู XSS) ================
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            if (typeof str !== 'string') str = String(str);
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ================ ุฏุงูุฉ convertImageToBase64 ================
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // ================ TOAST NOTIFICATION ================
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        'fa-exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${escapeHTML(message)}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ================ CLEANUP LISTENERS ================
        function cleanupListeners() {
            dataListeners.forEach(unsubscribe => unsubscribe());
            dataListeners = [];
        }

        // ================ SIDEBAR ================
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar) sidebar.classList.toggle('open');
            if (overlay) overlay.classList.toggle('active');
        };

        // ================ AUTH STATE ================
        onAuthStateChanged(auth, async user => {
            if (user) {
                try {
                    const isSuperAdmin = user.email === SUPER_ADMIN_EMAIL;
                    const adminsSnap = await get(ref(db, 'admins'));
                    const admins = adminsSnap.val() || {};
                    allAdmins = admins;
                    
                    const isAdmin = isSuperAdmin || Object.values(admins).some(admin => 
                        admin.email && admin.email.toLowerCase() === user.email.toLowerCase()
                    );
                    
                    if (isAdmin) {
                        document.getElementById('guard-loader').style.display = 'none';
                        document.getElementById('adminApp').style.display = 'flex';
                        syncData();
                        showToast('โ ูุฑุญุจุงู ุจู ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ', 'success');
                    } else {
                        showToast('โ ููุณ ูุฏูู ุตูุงุญูุฉ ุงูุฏุฎูู', 'error');
                        setTimeout(() => signOut(auth).then(() => {
                            window.location.href = "index.html";
                        }), 2000);
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                    showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญูู ูู ุงููููุฉ', 'error');
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // ================ SYNC DATA ูุญุณูุฉ ================
        function syncData() {
            cleanupListeners();
            
            const listeners = [
                onValue(ref(db, 'folders'), snap => {
                    allFolders = snap.val() || {};
                    renderCourses(allFolders);
                    fillDropdowns(allFolders);
                }),
                onValue(ref(db, 'students'), snap => {
                    allStudents = snap.val() || {};
                    renderStudents(allStudents);
                    updateCounts();
                    loadLeaderboard();
                }),
                onValue(ref(db, 'quiz_results'), snap => {
                    allResults = snap.val() || {};
                    renderResults(allResults);
                    renderPerfectScores(allResults, allStudents);
                    updateCounts();
                }),
                onValue(ref(db, 'course_access_logs'), snap => {
                    allLogs = snap.val() || {};
                    renderAccessLogs(allLogs);
                    updateCounts();
                }),
                onValue(ref(db, 'course_access_notifications'), snap => {
                    allNotifications = snap.val() || {};
                    renderNotifications(allNotifications);
                    updateCounts();
                }),
                onValue(ref(db, 'subscription_notifications'), snap => {
                    allSubscriptionNotifications = snap.val() || {};
                    renderSubscriptionNotifications(allSubscriptionNotifications);
                    updateCounts();
                }),
                onValue(ref(db, 'reviews'), snap => {
                    allReviews = snap.val() || {};
                    renderReviews(allReviews);
                    updateCounts();
                }),
                onValue(ref(db, 'admins'), snap => {
                    allAdmins = snap.val() || {};
                    renderAdmins(allAdmins);
                }),
                onValue(ref(db, 'student_course_access'), snap => {
                    allCourseAccess = snap.val() || {};
                })
            ];
            
            dataListeners = listeners;
        }

        // ================ UPDATE COUNTS ================
        function updateCounts() {
            const studentCount = document.getElementById('studentCount');
            const resultsCount = document.getElementById('resultsCount');
            const logsCount = document.getElementById('logsCount');
            const notificationsCount = document.getElementById('notificationsCount');
            const subscriptionNotificationsCount = document.getElementById('subscriptionNotificationsCount');
            const reviewsCount = document.getElementById('reviewsCount');
            
            if (studentCount) studentCount.innerText = `(${Object.keys(allStudents).length})`;
            if (resultsCount) resultsCount.innerText = `(${Object.keys(allResults).length})`;
            if (logsCount) logsCount.innerText = `(${Object.keys(allLogs).length})`;
            if (notificationsCount) notificationsCount.innerText = `(${Object.keys(allNotifications).length})`;
            if (subscriptionNotificationsCount) subscriptionNotificationsCount.innerText = `(${Object.keys(allSubscriptionNotifications).length})`;
            if (reviewsCount) reviewsCount.innerText = `(${Object.keys(allReviews).length})`;
        }

        // ================ SHOW SECTION ================
        window.showSection = function(sectionId, element) {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            const section = document.getElementById(sectionId);
            if (section) section.style.display = 'block';
            
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            if (element) element.classList.add('active');
            
            if (sectionId === 'analyticsSection') loadAnalytics();
        };

        // ================ COURSES MANAGEMENT (ูุญุฏุซ ูุน ุฅุถุงูุฉ ุงููุฑุญูุฉ) ================
        function renderCourses(folders) {
            let h = "";
            if (folders) {
                Object.keys(folders).forEach(id => {
                    const f = folders[id];
                    const imgSrc = f.img && f.img.startsWith('data:image') ? f.img : (f.img || 'mona.jpg');
                    
                    h += `<div class="card" style="text-align:center;">
                        <img src="${escapeHTML(imgSrc)}" style="width:100px; height:100px; border-radius:20px; object-fit:cover; border: 4px solid var(--accent); margin-bottom: 15px;" onerror="this.src='mona.jpg'">
                        <h4 style="margin:15px 0 10px; font-size:1.3rem;">${escapeHTML(f.name)}</h4>
                        <span class="badge-grade">${escapeHTML(f.grade || 'ุบูุฑ ูุญุฏุฏ')}</span>
                        <div style="margin-bottom:20px; color: var(--gold); font-size:1.2rem;">
                            ${'โ'.repeat(Math.min(5, Math.round(f.avgRating || 0)))} (${escapeHTML(f.reviewCount || 0)})
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-main" style="flex: 1;" onclick='openEditModal("${id}", ${JSON.stringify(f).replace(/</g, '\\u003c')})'>
                                <i class="fas fa-edit"></i> ุชุนุฏูู
                            </button>
                            <button class="btn btn-danger" style="flex: 0.5;" onclick="delData('folders/${id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                });
            }
            const coursesGrid = document.getElementById('coursesGrid');
            if (coursesGrid) {
                coursesGrid.innerHTML = h || "<p style='text-align:center;'>ูุง ุชูุฌุฏ ููุฑุณุงุช ุจุนุฏ</p>";
            }
        }

        // ================ ุฅุถุงูุฉ ููุฑุณ ุฌุฏูุฏ ูุน ุตูุฑุฉ ูู ุงูุฌูุงุฒ ูุงููุฑุญูุฉ ================
        window.addCourse = async function() {
            const name = document.getElementById('cName')?.value.trim();
            const imgUrl = document.getElementById('cImgUrl')?.value.trim();
            const grade = document.getElementById('cGrade')?.value;
            const imgFile = document.getElementById('cImageFile')?.files[0];
            
            if (!name) {
                showToast("ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูููุฑุณ", 'error');
                return;
            }
            
            if (!grade) {
                showToast("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ", 'error');
                return;
            }
            
            let imageData = imgUrl || 'mona.jpg';
            
            // ุฅุฐุง ุชู ุงุฎุชูุงุฑ ุตูุฑุฉ ูู ุงูุฌูุงุฒ
            if (imgFile) {
                try {
                    imageData = await convertImageToBase64(imgFile);
                } catch (error) {
                    console.error('Error converting image:', error);
                    showToast("โ ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ", 'error');
                    return;
                }
            } else if (imgUrl) {
                try {
                    new URL(imgUrl);
                } catch {
                    showToast("โ ุฑุงุจุท ุงูุตูุฑุฉ ุบูุฑ ุตุญูุญ", 'error');
                    return;
                }
            }
            
            try {
                await push(ref(db, 'folders'), { 
                    name, 
                    img: imageData,
                    grade: grade,
                    avgRating: 0, 
                    reviewCount: 0 
                });
                
                document.getElementById('cName').value = "";
                document.getElementById('cImgUrl').value = "";
                document.getElementById('cGrade').value = "";
                document.getElementById('cImageFile').value = "";
                document.getElementById('imagePreview').style.display = 'none';
                showToast("โ ุชู ุฅูุดุงุก ุงูููุฑุณ ุจูุฌุงุญ", 'success');
            } catch (error) {
                console.error('Error adding course:', error);
                showToast("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูููุฑุณ", 'error');
            }
        };

        // ================ ูุนุงููุฉ ุงูุตูุฑุฉ ูุจู ุงูุฑูุน ================
        document.addEventListener('DOMContentLoaded', function() {
            const cImageFile = document.getElementById('cImageFile');
            if (cImageFile) {
                cImageFile.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const preview = document.getElementById('imagePreview');
                        const previewImg = document.getElementById('previewImg');
                        previewImg.src = await convertImageToBase64(file);
                        preview.style.display = 'block';
                    }
                });
            }
            
            const editImageFile = document.getElementById('editImageFile');
            if (editImageFile) {
                editImageFile.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const preview = document.getElementById('editImagePreview');
                        const previewImg = document.getElementById('editPreviewImg');
                        previewImg.src = await convertImageToBase64(file);
                        preview.style.display = 'block';
                    }
                });
            }
        });

        // ================ ูุชุญ ููุฏุงู ุงูุชุนุฏูู (ูุญุฏุซ ูุน ุฅุถุงูุฉ ุงููุฑุญูุฉ) ================
        window.openEditModal = async function(id, folderData) {
            activeCID = id;
            const editNameField = document.getElementById('editNameField');
            const editImgField = document.getElementById('editImgField');
            const editGradeField = document.getElementById('editGradeField');
            
            if (editNameField) editNameField.value = folderData.name || '';
            if (editImgField) editImgField.value = "";
            if (editGradeField) editGradeField.value = folderData.grade || '';
            
            // ุฅุฎูุงุก ูุนุงููุฉ ุงูุตูุฑุฉ
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editImageFile').value = '';
            
            try {
                const [folderSnap, quizzesSnap] = await Promise.all([
                    get(ref(db, `folders/${id}`)),
                    get(ref(db, `quizzes/${id}`))
                ]);
                
                const f = folderSnap.val() || {};
                let vH = "<h5 style='margin-top:15px;'>ุงูููุฏูููุงุช:</h5>";
                
                if (f.videos) {
                    // ุชุฑุชูุจ ุงูููุฏูููุงุช ุญุณุจ ุฑูู ุงูุชุฑุชูุจ
                    const videosArray = [];
                    Object.entries(f.videos).forEach(([vId, v]) => {
                        videosArray.push({
                            id: vId,
                            ...v,
                            order: v.order || 999
                        });
                    });
                    
                    videosArray.sort((a, b) => a.order - b.order);
                    
                    videosArray.forEach(v => {
                        vH += `<div class="list-item">
                            <div>
                                <span style="font-weight: bold;">${escapeHTML(v.order || 0)}. ${escapeHTML(v.title)}</span>
                                <div style="font-size:0.8rem; color: #666; margin-top:5px;">${escapeHTML(v.url)}</div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-view" onclick='playVideoAdmin("${escapeHTML(v.url)}", "${escapeHTML(v.title)}")' title="ูุดุงูุฏุฉ">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn-edit" onclick='openEditVideoModal("${id}", "${v.id}", ${JSON.stringify(v).replace(/</g, '\\u003c')})' title="ุชุนุฏูู">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete" onclick="delData('folders/${id}/videos/${v.id}')" title="ุญุฐู">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    });
                } else {
                    vH += "<p style='color:#888; font-size:0.85rem;'>ูุง ุชูุฌุฏ ููุฏูููุงุช ุจุนุฏ</p>";
                }
                
                const vListContainer = document.getElementById('vListContainer');
                if (vListContainer) vListContainer.innerHTML = vH;
                
                let qH = "<h5 style='margin-top:15px;'>ุงูุงุฎุชุจุงุฑุงุช:</h5>";
                if (quizzesSnap.exists()) {
                    quizzesSnap.forEach(q => {
                        const qData = q.val();
                        const qCount = qData.questions ? Object.keys(qData.questions).length : 0;
                        qH += `<div class="list-item">
                            <div>
                                <span style="font-weight: bold;">${escapeHTML(qData.name)}</span>
                                <span class="badge-exam" style="margin-right: 10px;">${escapeHTML(qCount)} ุณุคุงู</span>
                            </div>
                            <div class="item-actions">
                                <button class="btn-view" onclick='previewExamFromList("${id}", "${q.key}", ${JSON.stringify(qData).replace(/</g, '\\u003c')})' title="ูุนุงููุฉ">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-edit" onclick='openEditExamModal("${id}", "${q.key}", ${JSON.stringify(qData).replace(/</g, '\\u003c')})' title="ุชุนุฏูู">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-delete" onclick="delData('quizzes/${id}/${q.key}')" title="ุญุฐู">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    });
                } else {
                    qH += "<p style='color:#888; font-size:0.85rem;'>ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุจุนุฏ</p>";
                }
                
                const qListContainer = document.getElementById('qListContainer');
                if (qListContainer) qListContainer.innerHTML = qH;
            } catch (error) {
                console.error('Error loading modal data:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช', 'error');
            }
            
            const editModal = document.getElementById('editModal');
            if (editModal) editModal.style.display = 'flex';
        };

        // ================ ุชุญุฏูุซ ุจูุงูุงุช ุงูููุฑุณ (ูุญุฏุซ ูุน ุฅุถุงูุฉ ุงููุฑุญูุฉ) ================
        window.updateCourseBasic = async function() {
            const name = document.getElementById('editNameField')?.value.trim();
            const grade = document.getElementById('editGradeField')?.value;
            const imgUrl = document.getElementById('editImgField')?.value.trim();
            const imgFile = document.getElementById('editImageFile')?.files[0];
            const btn = document.getElementById('saveBasicBtn');
            
            if (!activeCID) {
                showToast("ุฎุทุฃ: ูู ูุชู ุชุญุฏูุฏ ุงูููุฑุณ", 'error');
                return;
            }
            if (!name) {
                showToast("ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูููุฑุณ", 'error');
                return;
            }
            
            if (btn) {
                btn.innerText = "ุฌุงุฑู ุงูุญูุธ..."; 
                btn.disabled = true;
            }
            
            try {
                const updateData = { name };
                
                // ุฅุถุงูุฉ ุงููุฑุญูุฉ ุฅุฐุง ุชู ุงุฎุชูุงุฑูุง
                if (grade) {
                    updateData.grade = grade;
                }
                
                // ูุนุงูุฌุฉ ุงูุตูุฑุฉ
                if (imgFile) {
                    updateData.img = await convertImageToBase64(imgFile);
                } else if (imgUrl) {
                    try {
                        new URL(imgUrl);
                        updateData.img = imgUrl;
                    } catch {
                        showToast("โ ุฑุงุจุท ุงูุตูุฑุฉ ุบูุฑ ุตุญูุญ", 'error');
                        if (btn) {
                            btn.innerText = "ุญูุธ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ"; 
                            btn.disabled = false;
                        }
                        return;
                    }
                }
                
                await update(ref(db, `folders/${activeCID}`), updateData);
                showToast("โ ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ", 'success');
                
                document.getElementById('editImgField').value = "";
                document.getElementById('editImageFile').value = "";
                document.getElementById('editImagePreview').style.display = 'none';
            } catch (error) {
                console.error('Error updating course:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญุฏูุซ', 'error');
            } finally {
                if (btn) {
                    btn.innerText = "ุญูุธ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ"; 
                    btn.disabled = false;
                }
            }
        };

        // ================ ุชุดุบูู ุงูููุฏูู ================
        window.playVideoAdmin = function(url, title) {
            try {
                const match = url.match(/^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
                if (!match || !match[2] || match[2].length !== 11) {
                    showToast("โ ุฑุงุจุท ุงูููุฏูู ุบูุฑ ุตุงูุญ", 'error');
                    return;
                }
                const videoId = match[2];
                const overlay = document.createElement('div');
                overlay.className = 'video-player-overlay';
                overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:5000; display:flex; align-items:center; justify-content:center;';
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'width:80%; height:80%; border-radius:15px;';
                iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                iframe.allow = 'autoplay; encrypted-media';
                iframe.allowFullscreen = true;
                const closeBtn = document.createElement('span');
                closeBtn.style.cssText = 'position:absolute; top:20px; left:20px; color:white; font-size:3rem; cursor:pointer;';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = () => overlay.remove();
                overlay.appendChild(iframe);
                overlay.appendChild(closeBtn);
                document.body.appendChild(overlay);
            } catch (error) {
                console.error('Error playing video:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุชุดุบูู ุงูููุฏูู', 'error');
            }
        };

        // ================ ูุนุงููุฉ ุงูุงูุชุญุงู ูู ุงููุงุฆูุฉ ================
        window.previewExamFromList = function(courseId, examId, examData) {
            try {
                currentEditingExam = { courseId, examId, examData };
                const editExamName = document.getElementById('editExamName');
                if (editExamName) editExamName.value = examData.name || '';
                renderEditQuestions(examData.questions || {});
                previewExam();
            } catch (error) {
                console.error('Error previewing exam:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ูุนุงููุฉ ุงูุงูุชุญุงู', 'error');
            }
        };

        // ================ ุฅุถุงูุฉ ููุฏูู ููููุฑุณ ================
        window.addVideoToCourse = function() {
            const t = document.getElementById('vTitle')?.value.trim();
            const u = document.getElementById('vUrl')?.value.trim();
            const o = document.getElementById('vOrder')?.value;
            
            if (!activeCID) {
                showToast("ุฎุทุฃ: ูู ูุชู ุชุญุฏูุฏ ุงูููุฑุณ", 'error');
                return;
            }
            if (!t || !u) {
                showToast("ูุฑุฌู ุฅุฏุฎุงู ุนููุงู ุงูููุฏูู ูุฑุงุจุท ุงูููุชููุจ", 'error');
                return;
            }
            
            if (!u.includes('youtube.com') && !u.includes('youtu.be')) {
                showToast("โ ุงูุฑุงุจุท ุบูุฑ ุตุงูุญ. ูุฌุจ ุฃู ูููู ุฑุงุจุท ููุชููุจ", 'error');
                return;
            }
            
            push(ref(db, `folders/${activeCID}/videos`), { 
                title: t, 
                url: u, 
                order: parseInt(o) || 0 
            }).then(() => {
                showToast("โ ุชู ุฅุถุงูุฉ ุงูููุฏูู", 'success');
                document.getElementById('vTitle').value = "";
                document.getElementById('vUrl').value = "";
                document.getElementById('vOrder').value = "";
                const editNameField = document.getElementById('editNameField');
                const editGradeField = document.getElementById('editGradeField');
                openEditModal(activeCID, { 
                    name: editNameField ? editNameField.value : '',
                    grade: editGradeField ? editGradeField.value : ''
                });
            }).catch(error => {
                console.error('Error adding video:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูููุฏูู', 'error');
            });
        };

        // ================ ุชุนุฏูู ุงูููุฏูู ================
        window.openEditVideoModal = function(courseId, videoId, videoData) {
            document.getElementById('editVideoCourseId').value = courseId;
            document.getElementById('editVideoId').value = videoId;
            document.getElementById('editVideoTitle').value = videoData.title || '';
            document.getElementById('editVideoUrl').value = videoData.url || '';
            document.getElementById('editVideoOrder').value = videoData.order || 0;
            
            document.getElementById('editVideoModal').style.display = 'flex';
        };

        window.closeVideoModal = function() {
            document.getElementById('editVideoModal').style.display = 'none';
        };

        window.saveVideoChanges = async function() {
            const courseId = document.getElementById('editVideoCourseId')?.value;
            const videoId = document.getElementById('editVideoId')?.value;
            const title = document.getElementById('editVideoTitle')?.value.trim();
            const url = document.getElementById('editVideoUrl')?.value.trim();
            const order = parseInt(document.getElementById('editVideoOrder')?.value) || 0;

            if (!title || !url) {
                showToast('โ ูุฑุฌู ุฅุฏุฎุงู ุนููุงู ุงูููุฏูู ูุงูุฑุงุจุท', 'error');
                return;
            }

            if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                showToast('โ ุงูุฑุงุจุท ุบูุฑ ุตุงูุญ. ูุฌุจ ุฃู ูููู ุฑุงุจุท ููุชููุจ', 'error');
                return;
            }

            try {
                await update(ref(db, `folders/${courseId}/videos/${videoId}`), {
                    title: title,
                    url: url,
                    order: order
                });
                
                showToast('โ ุชู ุชุนุฏูู ุงูููุฏูู ุจูุฌุงุญ', 'success');
                closeVideoModal();
                const folderSnap = await get(ref(db, `folders/${courseId}`));
                openEditModal(courseId, folderSnap.val() || {});
            } catch (error) {
                console.error(error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุนุฏูู', 'error');
            }
        };

        // ================ ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ ูู ูุตูุน ุงูุงุฎุชุจุงุฑุงุช ================
        window.addNewQuestion = function(type) {
            const questionsArea = document.getElementById('questionsArea');
            if (!questionsArea) return;
            
            const q = document.createElement('div');
            q.className = "card"; 
            q.style = "background:#f8f9fa; position:relative; margin-top:10px;";
            q.innerHTML = `<i class="fas fa-trash" style="position:absolute; left:10px; top:10px; color:red; cursor:pointer;" onclick="this.parentElement.remove()"></i>
                <input type="text" class="q-text" placeholder="ูุต ุงูุณุคุงู" maxlength="500" style="width:100%; padding:10px; margin-bottom:10px;">
                ${type==='mcq' ? `<div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
                    <input type="text" class="oA" placeholder="ุงูุงุฎุชูุงุฑ A" maxlength="200">
                    <input type="text" class="oB" placeholder="ุงูุงุฎุชูุงุฑ B" maxlength="200">
                    <input type="text" class="oC" placeholder="ุงูุงุฎุชูุงุฑ C" maxlength="200">
                    <input type="text" class="oD" placeholder="ุงูุงุฎุชูุงุฑ D" maxlength="200">
                </div>
                <select class="q-correct" style="margin-top:5px; width:100%; padding:8px;">
                    <option value="a">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: A</option>
                    <option value="b">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: B</option>
                    <option value="c">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: C</option>
                    <option value="d">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: D</option>
                </select>` : `
                <select class="q-correct" style="margin-top:5px; width:100%; padding:8px;">
                    <option value="a">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ุตุญ</option>
                    <option value="b">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ุฎุทุฃ</option>
                </select>`}`;
            questionsArea.appendChild(q);
        };

        // ================ ุญูุธ ุงูุงูุชุญุงู ุงูููุงุฆู ================
        window.saveFinalExam = function() {
            const fId = document.getElementById('exFolderSelect')?.value;
            const title = document.getElementById('exTitle')?.value.trim();
            const videoRel = document.getElementById('exVideoRel')?.value;
            
            if (!fId) {
                showToast("ูุฑุฌู ุงุฎุชูุงุฑ ุงูููุฑุณ", 'error');
                return;
            }
            if (!title) {
                showToast("ูุฑุฌู ุฅุฏุฎุงู ุนููุงู ุงูุงุฎุชุจุงุฑ", 'error');
                return;
            }
            if (title.length < 3) {
                showToast("ุนููุงู ุงูุงุฎุชุจุงุฑ ูุตูุฑ ุฌุฏุงู", 'error');
                return;
            }
            
            let questions = {};
            let qIndex = 0;
            
            const questionCards = document.querySelectorAll('#questionsArea .card');
            questionCards.forEach(c => {
                const qText = c.querySelector('.q-text')?.value.trim();
                if (!qText) return;
                
                const oA = c.querySelector('.oA');
                const oB = c.querySelector('.oB');
                const correct = c.querySelector('.q-correct')?.value;
                
                if (oA && oB) {
                    const a = (oA.value || "").trim();
                    const b = (oB.value || "").trim();
                    const cVal = (c.querySelector('.oC')?.value || "").trim();
                    const dVal = (c.querySelector('.oD')?.value || "").trim();
                    
                    if (!a || !b) return;
                    
                    questions[`q${qIndex}`] = {
                        text: qText,
                        a: a,
                        b: b,
                        c: cVal,
                        d: dVal,
                        correct: correct
                    };
                } else {
                    questions[`q${qIndex}`] = {
                        text: qText,
                        a: "ุตุญ",
                        b: "ุฎุทุฃ",
                        correct: correct
                    };
                }
                qIndex++;
            });
            
            if (Object.keys(questions).length === 0) {
                showToast("ูุฑุฌู ุฅุถุงูุฉ ุฃุณุฆูุฉ ููุงูุชุญุงู", 'error');
                return;
            }
            
            push(ref(db, `quizzes/${fId}`), { 
                name: title, 
                questions: questions,
                videoRel: videoRel,
                createdAt: new Date().toISOString()
            }).then(() => { 
                showToast("โ ุชู ูุดุฑ ุงูุงูุชุญุงู ุจูุฌุงุญ", 'success');
                document.getElementById('questionsArea').innerHTML = "";
                document.getElementById('exTitle').value = "";
            }).catch(error => {
                console.error('Error saving exam:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงูุงูุชุญุงู', 'error');
            });
        };

        // ================ ุชุนุจุฆุฉ ุงูููุงุฆู ุงูููุณุฏูุฉ ================
        function fillDropdowns(folders) {
            const folderSelect = document.getElementById('exFolderSelect');
            if (!folderSelect) return;
            
            folderSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูููุฑุณ</option>';
            if (folders) {
                Object.keys(folders).forEach(id => {
                    folderSelect.innerHTML += `<option value="${id}">${escapeHTML(folders[id].name)} (${escapeHTML(folders[id].grade || 'ุจุฏูู ูุฑุญูุฉ')})</option>`;
                });
            }
        }

        // ================ ุนุฑุถ ุงูุทูุงุจ ================
        function renderStudents(students) {
            let html = "";
            if (students) {
                Object.entries(students).forEach(([uid, s]) => {
                    const subCount = s.subscriptions ? Object.keys(s.subscriptions).length : 0;
                    const regMethod = s.email ? 'ุฅูููู' : s.username ? 'ููุฒุฑ ููู' : 'ุฌูุฌู';
                    html += `<tr>
                        <td>${escapeHTML(s.name || '')}</td>
                        <td><span class="student-id-display">${escapeHTML(s.shortId || '')}</span></td>
                        <td>${escapeHTML(s.grade || '')}</td>
                        <td>${escapeHTML(s.whatsapp || '')}</td>
                        <td>${escapeHTML(s.parentPhone || '')}</td>
                        <td>${escapeHTML(regMethod)}</td>
                        <td>${escapeHTML(subCount)}</td>
                        <td>${escapeHTML(s.points || 0)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="delData('students/${uid}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            }
            const studentList = document.getElementById('studentList');
            if (studentList) {
                studentList.innerHTML = html || '<tr><td colspan="9" style="text-align:center;">ูุง ููุฌุฏ ุทูุงุจ</td></tr>';
            }
        }

        window.filterStudents = function() {
            const search = document.getElementById('studentSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#studentList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // ================ ุนุฑุถ ุงููุชุงุฆุฌ ================
        function renderResults(results) {
            let html = "";
            if (results) {
                Object.entries(results).forEach(([key, r]) => {
                    html += `<tr>
                        <td>${escapeHTML(r.student || '')}</td>
                        <td><span class="student-id-display">${escapeHTML(r.studentId || '')}</span></td>
                        <td>${escapeHTML(r.quiz || '')}</td>
                        <td>${escapeHTML(r.score)}/${escapeHTML(r.total)}</td>
                        <td><span class="progress-badge">${escapeHTML(r.percentage)}%</span></td>
                        <td>${escapeHTML(r.time || '')}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="delData('quiz_results/${key}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            }
            const resultsList = document.getElementById('resultsList');
            if (resultsList) {
                resultsList.innerHTML = html || '<tr><td colspan="7" style="text-align:center;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</td></tr>';
            }
        }

        window.filterResults = function() {
            const search = document.getElementById('resultSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#resultsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // ================ ุนุฑุถ ุณุฌูุงุช ุงูุฏุฎูู ================
        function renderAccessLogs(logs) {
            let html = "";
            if (logs) {
                Object.entries(logs).forEach(([key, l]) => {
                    html += `<tr>
                        <td>${escapeHTML(l.studentName || '')}</td>
                        <td><span class="student-id-display">${escapeHTML(l.studentId || '')}</span></td>
                        <td>${escapeHTML(l.courseName || '')}</td>
                        <td>${escapeHTML(l.time || '')}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="delData('course_access_logs/${key}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            }
            const logsList = document.getElementById('logsList');
            if (logsList) {
                logsList.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">ูุง ุชูุฌุฏ ุณุฌูุงุช</td></tr>';
            }
        }

        window.filterLogs = function() {
            const search = document.getElementById('logSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#logsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // ================ ุนุฑุถ ุงูุฅุดุนุงุฑุงุช ================
        function renderNotifications(notifications) {
            let html = "";
            if (notifications) {
                Object.entries(notifications).forEach(([key, n]) => {
                    html += `<tr>
                        <td>${escapeHTML(n.studentName || '')}</td>
                        <td><span class="student-id-display">${escapeHTML(n.studentId || '')}</span></td>
                        <td>${escapeHTML(n.courseName || '')}</td>
                        <td>${escapeHTML(n.time || '')}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="delData('course_access_notifications/${key}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            }
            const notificationsList = document.getElementById('notificationsList');
            if (notificationsList) {
                notificationsList.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช</td></tr>';
            }
        }

        window.filterNotifications = function() {
            const search = document.getElementById('notificationSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#notificationsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // ================ ุนุฑุถ ุฅุดุนุงุฑุงุช ุงูุงุดุชุฑุงูุงุช ================
        function renderSubscriptionNotifications(notifications) {
            let html = "";
            if (notifications) {
                Object.entries(notifications).forEach(([key, n]) => {
                    html += `<tr>
                        <td>${escapeHTML(n.studentName || '')}</td>
                        <td><span class="student-id-display">${escapeHTML(n.studentId || '')}</span></td>
                        <td>${escapeHTML(n.courseName || '')}</td>
                        <td>${escapeHTML(n.subscribedAt || n.timestamp || '')}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="delData('subscription_notifications/${key}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            }
            const subscriptionNotificationsList = document.getElementById('subscriptionNotificationsList');
            if (subscriptionNotificationsList) {
                subscriptionNotificationsList.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุงุดุชุฑุงู</td></tr>';
            }
        }

        window.filterSubscriptionNotifications = function() {
            const search = document.getElementById('subscriptionNotificationSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#subscriptionNotificationsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // ================ ุนุฑุถ ุงูุขุฑุงุก ================
        function renderReviews(reviews) {
            let html = "";
            if (reviews) {
                Object.entries(reviews).forEach(([id, r]) => {
                    html += `<tr>
                        <td>${escapeHTML(r.student || '')}</td>
                        <td>${escapeHTML(r.text || '')}</td>
                        <td>${escapeHTML(r.rating ? 'โ'.repeat(r.rating) : '')}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="delData('reviews/${id}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                });
            }
            const reviewsList = document.getElementById('reviewsList');
            if (reviewsList) {
                reviewsList.innerHTML = html || '<tr><td colspan="4" style="text-align:center;">ูุง ุชูุฌุฏ ุขุฑุงุก</td></tr>';
            }
        }

        // ================ ุนุฑุถ ุงูุฃุฏููุฒ ================
        function renderAdmins(admins) {
            let html = "";
            if (admins) {
                Object.entries(admins).forEach(([id, a]) => {
                    const isSuper = a.email === SUPER_ADMIN_EMAIL;
                    html += `<div class="list-item">
                        <div>
                            <span style="font-weight:bold;">${escapeHTML(a.name || '')} ${isSuper ? '<span class="badge-super">ุณูุจุฑ ุฃุฏูู</span>' : ''}</span>
                            <div style="color:#666; font-size:0.85rem;">${escapeHTML(a.email || '')}</div>
                        </div>
                        <div class="item-actions">
                            ${!isSuper ? `<button class="btn-delete" onclick="removeAdmin('${id}')"><i class="fas fa-trash"></i> ุญุฐู</button>` : ''}
                        </div>
                    </div>`;
                });
            }
            const adminsList = document.getElementById('adminsList');
            if (adminsList) {
                adminsList.innerHTML = html || '<p style="color:#888;">ูุง ููุฌุฏ ุฃุฏููุฒ ุจุนุฏ</p>';
            }
        }

        // ================ ุฅุถุงูุฉ ุฃุฏูู ================
        window.addAdmin = async function() {
            const email = document.getElementById('newAdminEmail')?.value.trim();
            const name = document.getElementById('newAdminName')?.value.trim();
            
            if (!email || !name) {
                showToast('โ ูุฑุฌู ุฅุฏุฎุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุงูุงุณู', 'error');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุงูุญ', 'error');
                return;
            }
            
            try {
                const adminId = email.replace(/[.#$[\]]/g, '_');
                await set(ref(db, `admins/${adminId}`), { email, name });
                
                document.getElementById('newAdminEmail').value = '';
                document.getElementById('newAdminName').value = '';
                showToast('โ ุชู ุฅุถุงูุฉ ุงูุฃุฏูู ุจูุฌุงุญ', 'success');
            } catch (error) {
                console.error('Error adding admin:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุฃุฏูู', 'error');
            }
        };

        window.removeAdmin = async function(adminId) {
            if (adminId === SUPER_ADMIN_EMAIL.replace(/[.#$[\]]/g, '_')) {
                showToast('โ ูุง ูููู ุญุฐู ุงูุณูุจุฑ ุฃุฏูู', 'error');
                return;
            }
            
            if (confirm('โ ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฃุฏููุ')) {
                try {
                    await remove(ref(db, `admins/${adminId}`));
                    showToast('โ ุชู ุญุฐู ุงูุฃุฏูู', 'success');
                } catch (error) {
                    console.error('Error removing admin:', error);
                    showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงูุฃุฏูู', 'error');
                }
            }
        };

        // ================ ุนุฑุถ ุงูุฏุฑุฌุงุช ุงูููุงุฆูุฉ ================
        function renderPerfectScores(results, students) {
            const perfectScores = [];
            
            if (results && students) {
                Object.entries(results).forEach(([key, res]) => {
                    if (res.score === res.total && res.score > 0) {
                        const student = Object.values(students).find(s => s.shortId === res.studentId);
                        perfectScores.push({
                            key: key,
                            studentName: res.student || 'ุทุงูุจ',
                            studentId: res.studentId || '',
                            examName: res.quiz || 'ุงูุชุญุงู',
                            grade: student?.grade || 'ุบูุฑ ูุญุฏุฏ',
                            score: res.score,
                            total: res.total,
                            time: res.time || ''
                        });
                    }
                });
            }
            
            allPerfectScores = perfectScores;
            
            let html = "";
            perfectScores.forEach(ps => {
                html += `<tr>
                    <td>${escapeHTML(ps.studentName)}</td>
                    <td><span class="student-id-display">${escapeHTML(ps.studentId)}</span></td>
                    <td>${escapeHTML(ps.examName)}</td>
                    <td>${escapeHTML(ps.grade)}</td>
                    <td>${escapeHTML(ps.time)}</td>
                    <td><span class="progress-badge">${ps.score}/${ps.total}</span></td>
                    <td><button class="btn btn-danger btn-sm" onclick="deletePerfectScore('${ps.key}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            
            const perfectScoresList = document.getElementById('perfectScoresList');
            if (perfectScoresList) {
                perfectScoresList.innerHTML = html || '<tr><td colspan="7" style="text-align:center;">ูุง ุชูุฌุฏ ุฏุฑุฌุงุช ููุงุฆูุฉ</td></tr>';
            }
            
            const perfectScoresCount = document.getElementById('perfectScoresCount');
            if (perfectScoresCount) {
                perfectScoresCount.innerText = `(${perfectScores.length})`;
            }
        }

        window.filterPerfectScores = function() {
            const search = document.getElementById('perfectScoreSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#perfectScoresList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.deletePerfectScore = async function(resultKey) {
            if (confirm('โ๏ธ ูู ุฃูุช ูุชุฃูุฏุ ุญุฐู ุงููุชูุฌุฉ ุณูุณูุญ ููุทุงูุจ ุจุฅุนุงุฏุฉ ุงูุงูุชุญุงู.')) {
                try {
                    await remove(ref(db, `quiz_results/${resultKey}`));
                    showToast('โ ุชู ุญุฐู ุงููุชูุฌุฉ', 'success');
                } catch (error) {
                    console.error('Error deleting score:', error);
                    showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงููุชูุฌุฉ', 'error');
                }
            }
        };

        // ================ ุงูุจุญุซ ุงููุชูุฏู ================
        window.performAdvancedSearch = async function() {
            const searchTerm = document.getElementById('advancedSearch')?.value.trim().toLowerCase();
            if (!searchTerm) {
                showToast('โ ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุจุญุซ', 'error');
                return;
            }
            
            try {
                let foundStudent = null;
                let foundUid = null;
                
                for (const [uid, student] of Object.entries(allStudents)) {
                    if ((student.name && student.name.toLowerCase().includes(searchTerm)) || 
                        (student.shortId && student.shortId.toLowerCase().includes(searchTerm))) {
                        foundStudent = student;
                        foundUid = uid;
                        break;
                    }
                }
                
                if (!foundStudent) {
                    showToast('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุทุงูุจ', 'error');
                    document.getElementById('searchResults').style.display = 'none';
                    return;
                }
                
                currentStudentData = foundStudent;
                currentStudentUid = foundUid;
                
                document.getElementById('studentInfo').innerHTML = `
                    <div class="card"><strong>ุงูุงุณู:</strong> ${escapeHTML(foundStudent.name)}</div>
                    <div class="card"><strong>ุงูููุฏ:</strong> ${escapeHTML(foundStudent.shortId)}</div>
                    <div class="card"><strong>ุงููุฑุญูุฉ:</strong> ${escapeHTML(foundStudent.grade)}</div>
                    <div class="card"><strong>ูุงุชุณุงุจ:</strong> ${escapeHTML(foundStudent.whatsapp)}</div>
                    <div class="card"><strong>ุงูููุงุท:</strong> ${foundStudent.points || 0}</div>
                `;
                
                let subsHtml = '';
                if (foundStudent.subscriptions) {
                    Object.values(foundStudent.subscriptions).forEach(sub => {
                        subsHtml += `<div class="list-item">${escapeHTML(sub.courseName)} - ุชูุฏู: ${sub.progress || 0}%</div>`;
                    });
                }
                document.getElementById('studentSubscriptions').innerHTML = subsHtml || '<p>ูุง ููุฌุฏ ุงุดุชุฑุงูุงุช</p>';
                
                let videosHtml = '';
                if (foundStudent.watchedVideos) {
                    Object.values(foundStudent.watchedVideos).forEach(v => {
                        videosHtml += `<div class="list-item">${escapeHTML(v.videoTitle)} - ${escapeHTML(v.watchedAt)}</div>`;
                    });
                }
                document.getElementById('studentWatchedVideos').innerHTML = videosHtml || '<p>ูุง ุชูุฌุฏ ููุฏูููุงุช ูุดุงูุฏุฉ</p>';
                
                let examsHtml = '';
                if (foundStudent.examResults) {
                    Object.values(foundStudent.examResults).forEach(ex => {
                        examsHtml += `<tr>
                            <td>${escapeHTML(ex.quizName)}</td>
                            <td>${ex.score}/${ex.total}</td>
                            <td>${ex.percentage}%</td>
                            <td>${escapeHTML(ex.completedAt)}</td>
                        </tr>`;
                    });
                }
                document.getElementById('studentExamResults').innerHTML = examsHtml || '<tr><td colspan="4">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</td></tr>';
                
                let accessHtml = '';
                if (allCourseAccess[foundUid]) {
                    Object.values(allCourseAccess[foundUid]).forEach(acc => {
                        accessHtml += `<tr><td>${escapeHTML(acc.courseName)}</td><td>${escapeHTML(acc.time)}</td></tr>`;
                    });
                }
                document.getElementById('studentAccessLog').innerHTML = accessHtml || '<tr><td colspan="2">ูุง ุชูุฌุฏ ุณุฌูุงุช ุฏุฎูู</td></tr>';
                
                document.getElementById('searchResults').style.display = 'block';
            } catch (error) {
                console.error('Search error:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุงูุจุญุซ', 'error');
            }
        };

        window.clearAdvancedSearch = function() {
            document.getElementById('advancedSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            currentStudentData = null;
            currentStudentUid = null;
        };

        window.exportStudentPDF = function() {
            if (!currentStudentData) {
                showToast('โ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุทุงูุจ', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont('cairo', 'normal');
                doc.setFontSize(20);
                doc.text(`ุชูุฑูุฑ ุงูุทุงูุจ: ${currentStudentData.name}`, 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`ููุฏ ุงูุทุงูุจ: ${currentStudentData.shortId}`, 20, 40);
                doc.text(`ุงููุฑุญูุฉ: ${currentStudentData.grade}`, 20, 50);
                doc.text(`ูุงุชุณุงุจ: ${currentStudentData.whatsapp}`, 20, 60);
                doc.text(`ุงูููุงุท: ${currentStudentData.points || 0}`, 20, 70);
                
                doc.save(`student_${currentStudentData.shortId}.pdf`);
                showToast('โ ุชู ุชุตุฏูุฑ PDF ุจูุฌุงุญ', 'success');
            } catch (error) {
                console.error('PDF error:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุชุตุฏูุฑ PDF', 'error');
            }
        };

        // ================ ุญุฐู ุงูุจูุงูุงุช ================
        window.delData = function(path) { 
            if (confirm("โ ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐู ุงูููุงุฆูุ")) {
                remove(ref(db, path)).then(() => {
                    showToast("โ ุชู ุงูุญุฐู ุจูุฌุงุญ", 'success');
                }).catch(error => {
                    console.error('Delete error:', error);
                    showToast("โ ุญุฏุซ ุฎุทุฃ: " + error.message, 'error');
                });
            }
        };

        // ================ ุฅุบูุงู ุงูููุฏุงู ================
        window.closeModal = function() {
            document.getElementById('editModal').style.display = 'none';
            activeCID = "";
        };

        // ================ ุชุณุฌูู ุงูุฎุฑูุฌ ================
        window.logout = function() {
            signOut(auth).then(() => {
                cleanupListeners();
                showToast('๐ ุชู ุชุณุฌูู ุงูุฎุฑูุฌ', 'success');
                setTimeout(() => window.location.href = "index.html", 1000);
            }).catch(error => {
                console.error('Logout error:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุชุณุฌูู ุงูุฎุฑูุฌ', 'error');
            });
        };

        // ================ ุฏูุงู ุชุนุฏูู ุงูุงูุชุญุงู ================
        window.openEditExamModal = function(courseId, examId, examData) {
            try {
                currentEditingExam = { courseId, examId, examData };
                
                document.getElementById('editExamCourseId').value = courseId;
                document.getElementById('editExamId').value = examId;
                document.getElementById('editExamName').value = examData.name || '';
                
                renderEditQuestions(examData.questions || {});
                
                document.getElementById('editExamModal').style.display = 'flex';
            } catch (error) {
                console.error('Error opening exam modal:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ูุชุญ ุชุนุฏูู ุงูุงูุชุญุงู', 'error');
            }
        };

        window.closeExamModal = function() {
            document.getElementById('editExamModal').style.display = 'none';
            document.getElementById('editQuestionsArea').innerHTML = '';
            currentEditingExam = null;
        };

        function renderEditQuestions(questions) {
            const container = document.getElementById('editQuestionsArea');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(questions).forEach((key, index) => {
                addEditQuestionCard(questions[key], index);
            });
        }

        function addEditQuestionCard(questionData = null, index = null) {
            const container = document.getElementById('editQuestionsArea');
            if (!container) return;
            
            const qIndex = index !== null ? index : container.children.length;
            
            const card = document.createElement('div');
            card.className = 'edit-question-card';
            card.dataset.index = qIndex;
            
            const isMcq = questionData ? Object.keys(questionData).includes('c') : true;
            
            card.innerHTML = `
                <div class="question-header">
                    <span class="question-number">ุณุคุงู ${qIndex + 1}</span>
                    <div class="question-actions">
                        <i class="fas fa-copy" onclick="duplicateQuestion(${qIndex})" title="ูุณุฎ ุงูุณุคุงู"></i>
                        <i class="fas fa-trash" onclick="removeEditQuestion(this)" title="ุญุฐู ุงูุณุคุงู"></i>
                    </div>
                </div>
                
                <input type="text" class="q-text reg-input" placeholder="ูุต ุงูุณุคุงู" maxlength="500"
                       value="${escapeHTML(questionData?.text || '')}" style="margin-bottom: 15px;">
                
                <div class="question-type-selector" style="margin-bottom: 15px;">
                    <select class="q-type reg-input" onchange="changeQuestionType(this)">
                        <option value="mcq" ${isMcq ? 'selected' : ''}>ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ</option>
                        <option value="tf" ${!isMcq ? 'selected' : ''}>ุตุญ/ุฎุทุฃ</option>
                    </select>
                </div>
                
                <div class="mcq-options" style="display: ${isMcq ? 'grid' : 'none'};">
                    <div>
                        <label>A</label>
                        <input type="text" class="oA reg-input" placeholder="ุงูุงุฎุชูุงุฑ A" maxlength="200"
                               value="${escapeHTML(questionData?.a || '')}">
                    </div>
                    <div>
                        <label>B</label>
                        <input type="text" class="oB reg-input" placeholder="ุงูุงุฎุชูุงุฑ B" maxlength="200"
                               value="${escapeHTML(questionData?.b || '')}">
                    </div>
                    <div>
                        <label>C</label>
                        <input type="text" class="oC reg-input" placeholder="ุงูุงุฎุชูุงุฑ C" maxlength="200"
                               value="${escapeHTML(questionData?.c || '')}">
                    </div>
                    <div>
                        <label>D</label>
                        <input type="text" class="oD reg-input" placeholder="ุงูุงุฎุชูุงุฑ D" maxlength="200"
                               value="${escapeHTML(questionData?.d || '')}">
                    </div>
                </div>
                
                <div class="tf-options" style="display: ${!isMcq ? 'block' : 'none'};">
                    <select class="q-correct reg-input">
                        <option value="a" ${questionData?.correct === 'a' ? 'selected' : ''}>ุตุญ</option>
                        <option value="b" ${questionData?.correct === 'b' ? 'selected' : ''}>ุฎุทุฃ</option>
                    </select>
                </div>
                
                ${isMcq ? `
                <select class="q-correct reg-input" style="margin-top: 15px;">
                    <option value="a" ${questionData?.correct === 'a' ? 'selected' : ''}>ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: A</option>
                    <option value="b" ${questionData?.correct === 'b' ? 'selected' : ''}>ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: B</option>
                    <option value="c" ${questionData?.correct === 'c' ? 'selected' : ''}>ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: C</option>
                    <option value="d" ${questionData?.correct === 'd' ? 'selected' : ''}>ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: D</option>
                </select>
                ` : ''}
            `;
            
            container.appendChild(card);
        }

        window.addEditQuestion = function(type) {
            addEditQuestionCard(type === 'mcq' ? { a: '', b: '', c: '', d: '' } : { a: 'ุตุญ', b: 'ุฎุทุฃ' });
        };

        window.changeQuestionType = function(select) {
            const card = select.closest('.edit-question-card');
            if (!card) return;
            
            const mcqDiv = card.querySelector('.mcq-options');
            const tfDiv = card.querySelector('.tf-options');
            
            if (select.value === 'mcq') {
                mcqDiv.style.display = 'grid';
                tfDiv.style.display = 'none';
            } else {
                mcqDiv.style.display = 'none';
                tfDiv.style.display = 'block';
            }
        };

        window.removeEditQuestion = function(icon) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุคุงูุ')) {
                const card = icon.closest('.edit-question-card');
                if (card) card.remove();
                
                document.querySelectorAll('.edit-question-card').forEach((card, idx) => {
                    const questionNumber = card.querySelector('.question-number');
                    if (questionNumber) {
                        questionNumber.textContent = `ุณุคุงู ${idx + 1}`;
                    }
                    card.dataset.index = idx;
                });
            }
        };

        window.duplicateQuestion = function(index) {
            const cards = document.querySelectorAll('.edit-question-card');
            if (index >= 0 && index < cards.length) {
                const originalCard = cards[index];
                const clone = originalCard.cloneNode(true);
                
                const container = document.getElementById('editQuestionsArea');
                if (container) container.appendChild(clone);
                
                document.querySelectorAll('.edit-question-card').forEach((card, idx) => {
                    const questionNumber = card.querySelector('.question-number');
                    if (questionNumber) {
                        questionNumber.textContent = `ุณุคุงู ${idx + 1}`;
                    }
                    card.dataset.index = idx;
                });
            }
        };

        function collectEditQuestions() {
            let questions = {};
            let qIndex = 0;
            
            document.querySelectorAll('#editQuestionsArea .edit-question-card').forEach(card => {
                const qText = card.querySelector('.q-text')?.value.trim();
                if (!qText) return;
                
                const qType = card.querySelector('.q-type')?.value;
                const correct = card.querySelector('.q-correct')?.value;
                
                if (qType === 'mcq') {
                    const oA = card.querySelector('.oA')?.value.trim() || '';
                    const oB = card.querySelector('.oB')?.value.trim() || '';
                    const oC = card.querySelector('.oC')?.value.trim() || '';
                    const oD = card.querySelector('.oD')?.value.trim() || '';
                    
                    if (!oA || !oB) return;
                    
                    questions[`q${qIndex}`] = {
                        text: qText,
                        a: oA,
                        b: oB,
                        c: oC,
                        d: oD,
                        correct: correct
                    };
                } else {
                    questions[`q${qIndex}`] = {
                        text: qText,
                        a: "ุตุญ",
                        b: "ุฎุทุฃ",
                        correct: correct
                    };
                }
                qIndex++;
            });
            
            return questions;
        }

        window.previewExam = function() {
            try {
                const examName = document.getElementById('editExamName')?.value.trim();
                const questions = collectEditQuestions();
                
                if (Object.keys(questions).length === 0) {
                    showToast('โ ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูููุนุงููุฉ', 'error');
                    return;
                }
                
                let previewHtml = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: var(--accent);">${escapeHTML(examName || 'ุงูุชุญุงู ุจุฏูู ุนููุงู')}</h2>
                        <p style="color: #666;">ุนุฏุฏ ุงูุฃุณุฆูุฉ: ${Object.keys(questions).length}</p>
                    </div>
                `;
                
                Object.keys(questions).forEach((key, idx) => {
                    const q = questions[key];
                    previewHtml += `<div class="preview-question">`;
                    previewHtml += `<h4>ุณุคุงู ${idx + 1}: ${escapeHTML(q.text)}</h4>`;
                    
                    if (q.c) { // MCQ
                        previewHtml += `<div class="preview-options">`;
                        ['a', 'b', 'c', 'd'].forEach(opt => {
                            if (q[opt]) {
                                const isCorrect = q.correct === opt;
                                previewHtml += `
                                    <div class="preview-option ${isCorrect ? 'correct' : ''}">
                                        <span>${opt.toUpperCase()}: ${escapeHTML(q[opt])}</span>
                                        ${isCorrect ? '<span class="correct-badge">โ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</span>' : ''}
                                    </div>
                                `;
                            }
                        });
                        previewHtml += `</div>`;
                    } else { // True/False
                        previewHtml += `
                            <div class="preview-tf">
                                <div class="preview-tf-option ${q.correct === 'a' ? 'correct' : ''}">
                                    ุตุญ ${q.correct === 'a' ? 'โ' : ''}
                                </div>
                                <div class="preview-tf-option ${q.correct === 'b' ? 'correct' : ''}">
                                    ุฎุทุฃ ${q.correct === 'b' ? 'โ' : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    previewHtml += `</div>`;
                });
                
                document.getElementById('previewExamContent').innerHTML = previewHtml;
                document.getElementById('previewExamModal').style.display = 'flex';
            } catch (error) {
                console.error('Preview error:', error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ูู ุงููุนุงููุฉ', 'error');
            }
        };

        window.closePreviewModal = function() {
            document.getElementById('previewExamModal').style.display = 'none';
        };

        window.saveExamChanges = async function() {
            const courseId = document.getElementById('editExamCourseId')?.value;
            const examId = document.getElementById('editExamId')?.value;
            const name = document.getElementById('editExamName')?.value.trim();
            const videoRel = document.getElementById('editExamVideoRel')?.value;
            
            if (!name) {
                showToast('โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุงูุชุญุงู', 'error');
                return;
            }
            
            const questions = collectEditQuestions();
            
            if (Object.keys(questions).length === 0) {
                showToast('โ ูุฌุจ ุฅุถุงูุฉ ุณุคุงู ูุงุญุฏ ุนูู ุงูุฃูู', 'error');
                return;
            }
            
            try {
                await update(ref(db, `quizzes/${courseId}/${examId}`), {
                    name: name,
                    questions: questions,
                    videoRel: videoRel,
                    updatedAt: new Date().toISOString()
                });
                
                showToast('โ ุชู ุญูุธ ุงูุชุบููุฑุงุช ุจูุฌุงุญ', 'success');
                closeExamModal();
                
                if (activeCID === courseId) {
                    const folderSnap = await get(ref(db, `folders/${courseId}`));
                    openEditModal(courseId, folderSnap.val() || {});
                }
            } catch (error) {
                console.error(error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ', 'error');
            }
        };

        window.deleteExam = async function() {
            if (!confirm('โ๏ธ ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุงูุชุญุงูุ\nุณูุชู ุญุฐู ุฌููุน ูุชุงุฆุฌ ุงูุทูุงุจ ุงููุฑุชุจุทุฉ ุจู.')) {
                return;
            }
            
            const courseId = document.getElementById('editExamCourseId')?.value;
            const examId = document.getElementById('editExamId')?.value;
            
            try {
                await remove(ref(db, `quizzes/${courseId}/${examId}`));
                showToast('โ ุชู ุญุฐู ุงูุงูุชุญุงู ุจูุฌุงุญ', 'success');
                closeExamModal();
                
                if (activeCID === courseId) {
                    const folderSnap = await get(ref(db, `folders/${courseId}`));
                    openEditModal(courseId, folderSnap.val() || {});
                }
            } catch (error) {
                console.error(error);
                showToast('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู', 'error');
            }
        };

        // ================ ุงูุชุญูููุงุช ================
        function loadAnalytics() {
            const summary = document.getElementById('analyticsSummary');
            
            const totalStudents = Object.keys(allStudents).length;
            const totalCourses = Object.keys(allFolders).length;
            const totalExams = Object.keys(allResults).length;
            const avgScore = totalExams > 0 
                ? Math.round(Object.values(allResults).reduce((acc, r) => acc + (r.percentage || 0), 0) / totalExams) 
                : 0;
            
            if (summary) {
                summary.innerHTML = `
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-users"></i></div>
                        <div class="analytics-info"><h4>ุฅุฌูุงูู ุงูุทูุงุจ</h4><div class="number">${totalStudents}</div></div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-book"></i></div>
                        <div class="analytics-info"><h4>ุฅุฌูุงูู ุงูููุฑุณุงุช</h4><div class="number">${totalCourses}</div></div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="analytics-info"><h4>ุฅุฌูุงูู ุงูุงูุชุญุงูุงุช</h4><div class="number">${totalExams}</div></div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-icon"><i class="fas fa-star"></i></div>
                        <div class="analytics-info"><h4>ูุชูุณุท ุงูุฏุฑุฌุงุช</h4><div class="number">${avgScore}%</div></div>
                    </div>
                `;
            }
            
            if (!chartsInitialized) {
                initCharts();
                chartsInitialized = true;
            }
        }

        function initCharts() {
            try {
                const ctx1 = document.getElementById('topCoursesChart')?.getContext('2d');
                if (ctx1) {
                    if (topCoursesChart) topCoursesChart.destroy();
                    
                    const courseViews = Object.values(allFolders).map(f => 
                        Object.values(allCourseAccess).filter(acc => 
                            Object.values(acc).some(a => a.courseName === f.name)
                        ).length
                    );
                    const courseNames = Object.values(allFolders).map(f => f.name).slice(0, 5);
                    
                    topCoursesChart = new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: courseNames,
                            datasets: [{
                                label: 'ุนุฏุฏ ุงููุดุงูุฏุงุช',
                                data: courseViews.slice(0, 5),
                                backgroundColor: '#6c5ce7'
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                
                const ctx2 = document.getElementById('examScoresChart')?.getContext('2d');
                if (ctx2) {
                    if (examScoresChart) examScoresChart.destroy();
                    
                    const scores = Object.values(allResults).map(r => r.percentage || 0);
                    const less50 = scores.filter(s => s < 50).length;
                    const mid = scores.filter(s => s >= 50 && s < 70).length;
                    const good = scores.filter(s => s >= 70 && s < 90).length;
                    const excellent = scores.filter(s => s >= 90).length;
                    
                    examScoresChart = new Chart(ctx2, {
                        type: 'pie',
                        data: {
                            labels: ['ุฃูู ูู 50%', '50-70%', '70-90%', '90-100%'],
                            datasets: [{
                                data: [less50, mid, good, excellent],
                                backgroundColor: ['#ff7675', '#f1c40f', '#00b894', '#6c5ce7']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                
                const ctx3 = document.getElementById('activityChart')?.getContext('2d');
                if (ctx3) {
                    if (activityChart) activityChart.destroy();
                    
                    const days = ['ุงูุฃุญุฏ', 'ุงูุงุซููู', 'ุงูุซูุงุซุงุก', 'ุงูุฃุฑุจุนุงุก', 'ุงูุฎููุณ', 'ุงูุฌูุนุฉ', 'ุงูุณุจุช'];
                    const today = new Date();
                    const weekData = days.map((_, i) => {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        return Object.values(allLogs).filter(l => l.time && l.time.includes(dateStr)).length;
                    }).reverse();
                    
                    activityChart = new Chart(ctx3, {
                        type: 'line',
                        data: {
                            labels: days,
                            datasets: [{
                                label: 'ุนุฏุฏ ุงูุฒูุงุฑุงุช',
                                data: weekData,
                                borderColor: '#6c5ce7',
                                backgroundColor: 'rgba(108, 92, 231, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            } catch (error) {
                console.error('Chart initialization error:', error);
            }
        }

        function loadLeaderboard() {
            const leaderboard = document.getElementById('adminLeaderboard');
            if (!leaderboard) return;
            
            let html = '<div class="leaderboard-row"><span class="leaderboard-rank">#</span><span>ุงูุทุงูุจ</span><span>ุงูููุงุท</span></div>';
            
            const topStudents = Object.values(allStudents)
                .filter(s => s.points > 0)
                .sort((a, b) => (b.points || 0) - (a.points || 0))
                .slice(0, 20);
            
            topStudents.forEach((s, i) => {
                html += `<div class="leaderboard-row">
                    <span class="leaderboard-rank">#${i+1}</span>
                    <span>${escapeHTML(s.name || '')}</span>
                    <span>${s.points || 0} <i class="fas fa-star" style="color: var(--gold);"></i></span>
                </div>`;
            });
            
            leaderboard.innerHTML = html || '<p style="text-align:center;">ูุง ุชูุฌุฏ ุจูุงูุงุช</p>';
        }

        // ================ CLEANUP ON PAGE UNLOAD ================
        window.addEventListener('beforeunload', () => {
            cleanupListeners();
        });
    </script>
</body>
</html>