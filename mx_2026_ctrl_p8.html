<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ms. Mona | Pro Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent: #6c5ce7;
            --accent-light: #a29bfe;
            --dark: #2d3436;
            --success: #00b894;
            --danger: #ff7675;
            --bg: #f8f9fd;
            --white: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--dark); overflow-x: hidden; }

        /* Layout */
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--dark); color: white; padding: 30px 20px; flex-shrink: 0; }
        .main-content { flex: 1; padding: 30px; }

        .logo { font-size: 1.5rem; font-weight: 900; margin-bottom: 40px; text-align: center; color: var(--accent-light); border-bottom: 1px solid #444; padding-bottom: 20px; }

        .nav-link { 
            display: flex; align-items: center; gap: 15px; padding: 15px; 
            border-radius: 12px; cursor: pointer; transition: 0.3s; margin-bottom: 8px;
            color: #dfe6e9; text-decoration: none;
        }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: white; }

        /* Cards */
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 25px; border: 1px solid #f1f1f1; }
        
        /* Inputs */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
        input, select, textarea { 
            width: 100%; padding: 12px 15px; border-radius: 12px; border: 2px solid #eee; 
            font-family: 'Cairo'; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); background: #fcfcff; }

        .btn { 
            padding: 12px 25px; border: none; border-radius: 12px; cursor: pointer; 
            font-weight: 700; font-family: 'Cairo'; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-main { background: var(--accent); color: white; justify-content: center; }
        .btn-danger { background: #fff5f5; color: var(--danger); }
        .btn-outline { border: 2px solid var(--accent); color: var(--accent); background: transparent; }

        /* Sub-Tabs Styling */
        .sub-nav { display: flex; gap: 10px; margin-bottom: 20px; background: #f1f2f6; padding: 8px; border-radius: 15px; }
        .sub-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; transition: 0.3s; }
        .sub-btn.active { background: var(--white); color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Tables */
        .custom-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .custom-table th { text-align: right; padding: 12px; color: #b2bec3; font-size: 0.85rem; border-bottom: 2px solid #f1f1f1; }
        .custom-table td { padding: 15px; border-bottom: 1px solid #f9f9f9; vertical-align: middle; }
        .icon-box { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; }

        #loader { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        @media (max-width: 900px) { .sidebar { width: 80px; } .sidebar span { display: none; } .logo { font-size: 1rem; } }
    </style>
</head>
<body>

    <div id="loader">
        <i class="fas fa-shield-halved fa-spin fa-3x" style="color:var(--accent)"></i>
        <h3 style="margin-top:20px;">جاري التحقق من صلاحيات الإدارة...</h3>
    </div>

    <div class="wrapper" id="adminDashboard" style="display: none;">
        <aside class="sidebar">
            <div class="logo">Mona Academy</div>
            <div class="nav-link active" onclick="showSection('contentSection', this)"><i class="fas fa-folder-open"></i> <span>إدارة المحتوى</span></div>
            <div class="nav-link" onclick="showSection('examSection', this)"><i class="fas fa-pen-nib"></i> <span>مصنع الامتحانات</span></div>
            <div class="nav-link" onclick="showSection('studentSection', this)"><i class="fas fa-user-graduate"></i> <span>شؤون الطلاب</span></div>
            <div class="nav-link" onclick="showSection('reviewSection', this)"><i class="fas fa-star"></i> <span>آراء الطلاب</span></div>
            
            <div style="margin-top: 50px; border-top: 1px solid #444; padding-top: 20px;">
                <a href="index.html" class="nav-link" style="color: var(--success);"><i class="fas fa-home"></i> <span>العودة للموقع</span></a>
                
                <div class="nav-link" onclick="adminLogout()" style="color: var(--danger);"><i class="fas fa-power-off"></i> <span>خروج</span></div>
            </div>
        </aside>

        <main class="main-content">
            <section id="contentSection" class="admin-section">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;">
                    <div class="card">
                        <h3 id="fHeading">إنشاء مجلد كورس</h3>
                        <input type="hidden" id="editFId">
                        <div class="form-group" style="margin-top:15px;">
                            <label>اسم الكورس</label>
                            <input type="text" id="fName" placeholder="مثلاً: الصف السادس الابتدائي">
                        </div>
                        <div class="form-group">
                            <label>أيقونة الكورس (رفع من الجهاز)</label>
                            <input type="file" id="fFile" accept="image/*">
                        </div>
                        <button class="btn btn-main" style="width:100%" onclick="saveFolder()" id="fBtn">حفظ المجلد</button>
                        <button class="btn btn-outline" style="width:100%; margin-top:10px; display:none;" id="cancelF" onclick="resetFForm()">إلغاء التعديل</button>
                    </div>

                    <div class="card">
                        <h3>المجلدات الحالية</h3>
                        <table class="custom-table">
                            <tbody id="fList"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top:25px;">
                    <h3>إضافة فيديو جديد</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-top:15px;">
                        <select id="vFolderSelect"></select>
                        <input type="text" id="vTitle" placeholder="عنوان الفيديو">
                        <input type="text" id="vUrl" placeholder="رابط اليوتيوب">
                    </div>
                    <button class="btn btn-main" style="margin-top:15px" onclick="addVideo()">نشر الفيديو</button>
                </div>
            </section>

            <section id="examSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>بناء اختبار إلكتروني</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin:20px 0;">
                        <select id="eFolderSelect" onchange="loadVForExam()"></select>
                        <select id="eVideoSelect"><option value="all">امتحان شامل للمجلد</option></select>
                    </div>
                    <input type="text" id="eTitle" placeholder="عنوان الامتحان" style="margin-bottom:20px;">
                    <div id="qArea"></div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn btn-outline" onclick="addQ('mcq')">+ اختياري</button>
                        <button class="btn btn-outline" onclick="addQ('tf')">+ صح/خطأ</button>
                    </div>
                    <button class="btn btn-main" style="width:100%; margin-top:30px; height:55px;" onclick="publishEx()">نشر الامتحان فوراً</button>
                </div>
            </section>

            <section id="studentSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>شؤون الطلاب</h3>
                    <div class="sub-nav">
                        <button class="sub-btn active" onclick="switchSubTab('sTab1', this)">الطلاب المسجلين</button>
                        <button class="sub-btn" onclick="switchSubTab('sTab2', this)">نتائج الامتحانات</button>
                    </div>

                    <div id="sTab1" class="s-content">
                        <table class="custom-table">
                            <thead><tr><th>الطالب</th><th>الصف</th><th>واتساب</th><th>حذف</th></tr></thead>
                            <tbody id="sList"></tbody>
                        </table>
                    </div>

                    <div id="sTab2" class="s-content" style="display:none;">
                        <table class="custom-table">
                            <thead><tr><th>الطالب</th><th>الامتحان</th><th>الدرجة</th><th>إجراء</th></tr></thead>
                            <tbody id="rList"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="reviewSection" class="admin-section" style="display: none;">
                <div class="card">
                    <h3>آراء الطلاب</h3>
                    <div id="revGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px;"></div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, remove, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KQAQgu4nIiomoDpoTLnBz_uAtab63sY",
            authDomain: "monaacademy-cd983.firebaseapp.com",
            databaseURL: "https://monaacademy-cd983-default-rtdb.firebaseio.com",
            projectId: "monaacademy-cd983",
            storageBucket: "monaacademy-cd983.appspot.com",
            appId: "1:410646694761:web:bea49c51d3b0ff5eb9cbf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const ADMIN_EMAIL = "mrsmonakamel6@gmail.com";

        onAuthStateChanged(auth, user => {
            if (user && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'flex';
                initSync();
            } else { window.location.href = "index.html"; }
        });

        function initSync() {
            onValue(ref(db, 'folders'), snap => {
                let h = "", opts = '<option value="">اختر المجلد</option>';
                snap.forEach(f => {
                    const d = f.val();
                    opts += `<option value="${f.key}">${d.name}</option>`;
                    h += `<tr><td><img src="${d.img||''}" class="icon-box"></td><td><b>${d.name}</b></td>
                    <td style="text-align:left;"><button onclick="editF('${f.key}','${d.name}')" class="btn btn-outline" style="padding:5px 10px">تعديل</button>
                    <button onclick="del('folders/${f.key}')" class="btn btn-danger" style="padding:5px 10px"><i class="fas fa-trash"></i></button></td></tr>`;
                });
                document.getElementById('fList').innerHTML = h;
                document.getElementById('vFolderSelect').innerHTML = opts;
                document.getElementById('eFolderSelect').innerHTML = opts;
            });

            onValue(ref(db, 'students'), snap => {
                let h = "";
                snap.forEach(s => h += `<tr><td>${s.val().name}</td><td>${s.val().grade}</td><td>${s.val().whatsapp}</td><td><button onclick="del('students/${s.key}')" class="btn btn-danger">حذف</button></td></tr>`);
                document.getElementById('sList').innerHTML = h;
            });

            onValue(ref(db, 'results'), snap => {
                let h = "";
                snap.forEach(r => h += `<tr><td>${r.val().student}</td><td>${r.val().exam}</td><td style="color:var(--accent);font-weight:bold">${r.val().score}%</td><td><button onclick="del('results/${r.key}')" class="btn btn-danger">حذف</button></td></tr>`);
                document.getElementById('rList').innerHTML = h;
            });

            onValue(ref(db, 'reviews'), snap => {
                let h = "";
                snap.forEach(r => h += `<div class="card" style="border-right:5px solid var(--accent)"><b>${r.val().student}</b><p style="margin:10px 0">${r.val().text}</p><button onclick="del('reviews/${r.key}')" class="btn btn-danger" style="width:100%">حذف</button></div>`);
                document.getElementById('revGrid').innerHTML = h;
            });
        }

        window.saveFolder = async () => {
            const id = document.getElementById('editFId').value, name = document.getElementById('fName').value, file = document.getElementById('fFile').files[0];
            if(!name) return;
            let data = { name };
            const btn = document.getElementById('fBtn'); btn.disabled = true;

            if(file) {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    data.img = reader.result;
                    id ? await update(ref(db, `folders/${id}`), data) : await push(ref(db, 'folders'), data);
                    resetFForm();
                };
                reader.readAsDataURL(file);
            } else {
                id ? await update(ref(db, `folders/${id}`), data) : alert("يرجى اختيار أيقونة للمجلد");
                resetFForm();
            }
        };

        window.editF = (id, name) => {
            document.getElementById('editFId').value = id;
            document.getElementById('fName').value = name;
            document.getElementById('fHeading').innerText = "تعديل المجلد";
            document.getElementById('fBtn').innerText = "تحديث البيانات";
            document.getElementById('cancelF').style.display = "block";
        };

        window.resetFForm = () => {
            document.getElementById('editFId').value = ""; document.getElementById('fName').value = "";
            document.getElementById('fFile').value = ""; document.getElementById('fHeading').innerText = "إنشاء مجلد كورس";
            document.getElementById('fBtn').innerText = "حفظ المجلد"; document.getElementById('cancelF').style.display = "none";
            document.getElementById('fBtn').disabled = false;
        };

        window.loadVForExam = async () => {
            const fId = document.getElementById('eFolderSelect').value, vSel = document.getElementById('eVideoSelect');
            vSel.innerHTML = '<option value="all">امتحان شامل للمجلد</option>';
            const snap = await get(ref(db, `folders/${fId}/videos`));
            snap.forEach(v => vSel.innerHTML += `<option value="${v.key}">${v.val().title}</option>`);
        };

        window.addVideo = () => {
            const fId = document.getElementById('vFolderSelect').value, t = document.getElementById('vTitle').value, u = document.getElementById('vUrl').value;
            if(fId && t && u) push(ref(db, `folders/${fId}/videos`), {title: t, url: u}).then(() => alert("تم النشر"));
        };

        window.addQ = (type) => {
            const d = document.createElement('div'); d.className = "card"; d.style = "background:#f8f9ff; position:relative;";
            d.innerHTML = `<i class="fas fa-trash" style="position:absolute;left:15px;top:15px;color:var(--danger);cursor:pointer" onclick="this.parentElement.remove()"></i>
            <input type="text" class="q-txt" placeholder="السؤال">
            ${type==='mcq'?'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px"><input type="text" class="oA" placeholder="A"><input type="text" class="oB" placeholder="B"><input type="text" class="oC" placeholder="C"><input type="text" class="oD" placeholder="D"></div>':''}
            <select class="q-cor" style="margin-top:10px"><option value="A">الصح: A / صح</option><option value="B">الصح: B / خطأ</option><option value="C">الصح: C</option><option value="D">الصح: D</option></select>`;
            document.getElementById('qArea').appendChild(d);
        };

        window.publishEx = () => {
            const fId = document.getElementById('eFolderSelect').value, n = document.getElementById('eTitle').value, vRel = document.getElementById('eVideoSelect').value;
            let qs = [];
            document.querySelectorAll('#qArea .card').forEach(c => {
                qs.push({ text: c.querySelector('.q-txt').value, options: { A: c.querySelector('.oA')?.value || "صح", B: c.querySelector('.oB')?.value || "خطأ", C: c.querySelector('.oC')?.value || "-", D: c.querySelector('.oD')?.value || "-" }, correct: c.querySelector('.q-cor').value });
            });
            if(fId && n && qs.length) push(ref(db, `quizzes/${fId}`), { name: n, videoRel: vRel, questions: qs }).then(() => { alert("تم النشر"); document.getElementById('qArea').innerHTML = ""; });
        };

        window.showSection = (id, btn) => {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
        };

        window.switchSubTab = (id, btn) => {
            document.querySelectorAll('.s-content').forEach(c => c.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        window.adminLogout = () => signOut(auth);
        window.del = (path) => { if(confirm("حذف نهائي؟")) remove(ref(db, path)); };
    </script>
</body>
</html>
