<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ms. Mona | Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°ÙƒÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #6c5ce7; --primary-dark: #5849be; --success: #00b894; --danger: #ff7675; --bg: #f0f2f5; --white: #ffffff; --shadow: 0 10px 30px rgba(0,0,0,0.08); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); color: #2d3436; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
        header { display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 20px 30px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 12px 20px; border: none; border-radius: 12px; background: var(--white); cursor: pointer; font-weight: 700; font-family: 'Cairo'; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .card { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        @media (max-width: 850px) { .grid { grid-template-columns: 1fr; } }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #edf2f7; font-family: 'Cairo'; margin-top: 5px; outline: none; }
        .btn { padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-family: 'Cairo'; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; margin-top: 15px; }
        .btn-edit { background: #fff9db; color: #f08c00; padding: 5px 10px; font-size: 0.8rem; }
        .btn-danger { background: #fff5f5; color: #fa5252; padding: 5px 10px; font-size: 0.8rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #f1f4f8; }
        .row-icon { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; }
        #loadingOverlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i>
        <p style="margin-top:15px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</p>
    </div>

    <div class="container" id="adminDashboard">
        <header>
            <h2>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ms. Mona ğŸ’</h2>
            <button onclick="adminLogout()" class="btn btn-danger" style="font-size: 1rem;">Ø®Ø±ÙˆØ¬</button>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('coursesTab', this)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
            <button class="tab-btn" onclick="showTab('examsTab', this)">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
            <button class="tab-btn" onclick="showTab('studentsTab', this)">Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        </nav>

        <div id="coursesTab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3 id="formTitle">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯</h3>
                    <input type="hidden" id="editCourseId">
                    <div style="margin-top:15px;">
                        <label>Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³:</label>
                        <input type="text" id="courseName">
                    </div>
                    <div style="margin-top:15px;">
                        <label>Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒÙˆØ±Ø³ (Ø§ØªØ±ÙƒÙŠÙ‡Ø§ ÙØ§Ø±ØºØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©):</label>
                        <input type="file" id="courseFile" accept="image/*">
                    </div>
                    <button class="btn btn-primary" onclick="handleCourseSave()" id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button class="btn" id="cancelEditBtn" style="display:none; margin-top:10px; width:100%;" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                </div>

                <div class="card">
                    <h3>Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                    <table>
                        <thead><tr><th>Ø£ÙŠÙ‚ÙˆÙ†Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                        <tbody id="foldersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3>Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ÙƒÙˆØ±Ø³</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; margin-top:10px;">
                    <select id="targetCourseSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³</option></select>
                    <input type="text" id="videoTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">
                    <input type="text" id="videoLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨">
                </div>
                <button class="btn btn-primary" onclick="addVideo()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù…Ø¬Ù„Ø¯</button>
            </div>
        </div>

        <div id="examsTab" class="tab-content" style="display:none;">
            <div class="card">
                <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; margin-top:15px;">
                    <select id="examCourseSelect" onchange="loadVideosForExam()"></select>
                    <select id="videoRelSelect"><option value="all">Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù„ÙƒÙˆØ±Ø³</option></select>
                </div>
                <input type="text" id="quizName" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±" style="margin-top:15px;">
                <div id="questionsArea" style="margin-top:20px;"></div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn" onclick="addQuestionUI('mcq')" style="background:#eee;">+ Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ</button>
                    <button class="btn" onclick="addQuestionUI('tf')" style="background:#eee;">+ Ø³Ø¤Ø§Ù„ ØµØ­/Ø®Ø·Ø£</button>
                </div>
                <button class="btn btn-primary" onclick="saveQuiz()" style="height:55px; font-size:1.1rem;">Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            </div>
        </div>

        <div id="studentsTab" class="tab-content" style="display:none;">
            <div class="card"><h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3><table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>ÙˆØ§ØªØ³Ø§Ø¨</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="studentsTableBody"></tbody></table></div>
            <div class="card"><h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h3><table><thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="resultsTableBody"></tbody></table></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, push, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KQAQgu4nIiomoDpoTLnBz_uAtab63sY",
            authDomain: "monaacademy-cd983.firebaseapp.com",
            databaseURL: "https://monaacademy-cd983-default-rtdb.firebaseio.com",
            projectId: "monaacademy-cd983",
            storageBucket: "monaacademy-cd983.appspot.com",
            appId: "1:410646694761:web:bea49c51d3b0ff5eb9cbf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const ADMIN_EMAIL = "mrsmonakamel6@gmail.com";

        onAuthStateChanged(auth, user => {
            if (user && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadMainData();
            } else { window.location.href = "index.html"; }
        });

        function loadMainData() {
            onValue(ref(db, 'folders'), snap => {
                let h = "", opts = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³ --</option>';
                snap.forEach(f => {
                    const d = f.val();
                    opts += `<option value="${f.key}">${d.name}</option>`;
                    h += `<tr>
                        <td><img src="${d.img || ''}" class="row-icon"></td>
                        <td><b>${d.name}</b></td>
                        <td>
                            <button onclick="prepareEdit('${f.key}', '${d.name}')" class="btn btn-edit">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="del('folders/${f.key}')" class="btn btn-danger">Ø­Ø°Ù</button>
                        </td>
                    </tr>`;
                });
                document.getElementById('foldersTableBody').innerHTML = h;
                document.getElementById('targetCourseSelect').innerHTML = opts;
                document.getElementById('examCourseSelect').innerHTML = opts;
            });

            onValue(ref(db, 'students'), snap => {
                let h = "";
                snap.forEach(s => h += `<tr><td>${s.val().name}</td><td>${s.val().grade}</td><td>${s.val().whatsapp}</td><td><button onclick="del('students/${s.key}')" class="btn btn-danger">Ø­Ø°Ù</button></td></tr>`);
                document.getElementById('studentsTableBody').innerHTML = h;
            });

            onValue(ref(db, 'results'), snap => {
                let h = "";
                snap.forEach(r => h += `<tr><td>${r.val().student}</td><td>${r.val().exam}</td><td>${r.val().score}%</td><td><button onclick="del('results/${r.key}')" class="btn btn-danger">Ø­Ø°Ù</button></td></tr>`);
                document.getElementById('resultsTableBody').innerHTML = h;
            });
        }

        window.prepareEdit = (id, name) => {
            document.getElementById('editCourseId').value = id;
            document.getElementById('courseName').value = name;
            document.getElementById('formTitle').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³: " + name;
            document.getElementById('saveBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('cancelEditBtn').style.display = "block";
        };

        window.resetForm = () => {
            document.getElementById('editCourseId').value = "";
            document.getElementById('courseName').value = "";
            document.getElementById('courseFile').value = "";
            document.getElementById('formTitle').innerText = "Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('saveBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('cancelEditBtn').style.display = "none";
        };

        window.handleCourseSave = async () => {
            const id = document.getElementById('editCourseId').value;
            const name = document.getElementById('courseName').value;
            const fileInput = document.getElementById('courseFile');
            if (!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³");

            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

            let updateData = { name: name };

            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    updateData.img = reader.result;
                    await finishSave(id, updateData);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                await finishSave(id, updateData);
            }
        };

        async function finishSave(id, data) {
            if (id) {
                await update(ref(db, `folders/${id}`), data);
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ±Ø³");
            } else {
                if(!data.img) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯"); document.getElementById('saveBtn').disabled = false; return; }
                await push(ref(db, 'folders'), data);
                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ±Ø³");
            }
            resetForm();
            document.getElementById('saveBtn').disabled = false;
        }

        window.loadVideosForExam = async () => {
            const fId = document.getElementById('examCourseSelect').value;
            const vSel = document.getElementById('videoRelSelect');
            vSel.innerHTML = '<option value="all">Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù„ÙƒÙˆØ±Ø³</option>';
            if(!fId) return;
            const snap = await get(ref(db, `folders/${fId}/videos`));
            if(snap.exists()){
                snap.forEach(v => { vSel.innerHTML += `<option value="${v.key}">${v.val().title}</option>`; });
            }
        };

        window.addVideo = () => {
            const fId = document.getElementById('targetCourseSelect').value, t = document.getElementById('videoTitle').value, u = document.getElementById('videoLink').value;
            if(fId && t && u) push(ref(db, `folders/${fId}/videos`), {title: t, url: u}).then(() => alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"));
        };

        window.addQuestionUI = (type) => {
            const div = document.createElement('div');
            div.style = "background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:10px; position:relative; border:1px solid #ddd;";
            div.innerHTML = `<button onclick="this.parentElement.remove()" style="position:absolute; left:10px; top:10px; border:none; color:red; cursor:pointer;">X</button>
            <input type="text" class="q-txt" placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„">
            ${type==='mcq' ? `<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:5px;"><input type="text" class="oA" placeholder="A"><input type="text" class="oB" placeholder="B"><input type="text" class="oC" placeholder="C"><input type="text" class="oD" placeholder="D"></div>` : ''}
            <select class="q-cor" style="margin-top:5px;"><option value="A">${type==='mcq'?'Ø§Ù„ØµØ­ A':'ØµØ­ (True)'}</option><option value="B">${type==='mcq'?'Ø§Ù„ØµØ­ B':'Ø®Ø·Ø£ (False)'}</option>${type==='mcq'?'<option value="C">Ø§Ù„ØµØ­ C</option><option value="D">Ø§Ù„ØµØ­ D</option>':''}</select>`;
            document.getElementById('questionsArea').appendChild(div);
        };

        window.saveQuiz = () => {
            const fId = document.getElementById('examCourseSelect').value, n = document.getElementById('quizName').value, v = document.getElementById('videoRelSelect').value;
            const qDivs = document.querySelectorAll('.q-txt');
            if(!fId || !n || qDivs.length === 0) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±");
            let qs = [];
            document.querySelectorAll('#questionsArea > div').forEach(d => {
                qs.push({ text: d.querySelector('.q-txt').value, options: { A: d.querySelector('.oA')?.value || "ØµØ­", B: d.querySelector('.oB')?.value || "Ø®Ø·Ø£", C: d.querySelector('.oC')?.value || "-", D: d.querySelector('.oD')?.value || "-" }, correct: d.querySelector('.q-cor').value });
            });
            push(ref(db, `quizzes/${fId}`), {name: n, videoRel: v, questions: qs}).then(() => { alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±"); document.getElementById('questionsArea').innerHTML = ""; document.getElementById('quizName').value=""; });
        };

        window.showTab = (id, btn) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display='none');
            document.getElementById(id).style.display='block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };
        window.adminLogout = () => signOut(auth).then(() => window.location.href = "index.html");
        window.del = (path) => { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) remove(ref(db, path)); };
    </script>
</body>
</html>
