<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ms. Mona | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main: #6c5ce7; --dark: #4834d4; --bg: #f4f4f9; --danger: #ff7675; --success: #2ecc71; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ */
        #adminDashboard { display: none; max-width: 900px; margin: 0 auto; }
        
        .card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h2 { color: var(--dark); font-size: 1.3rem; margin-bottom: 15px; border-right: 5px solid var(--main); padding-right: 10px; text-align: right; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-family: 'Cairo'; }
        button { background: var(--main); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: var(--dark); }
        
        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-menu button { background: #fff; color: var(--main); border: 1px solid var(--main); min-width: 110px; margin: 0; }
        .tab-menu button.active { background: var(--main); color: white; }
        
        .list-item { background: #f9f9f9; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border: 1px solid #eee; }
        .delete-btn { background: var(--danger); width: auto; padding: 5px 15px; font-size: 0.8rem; margin: 0; }
        .edit-btn { background: var(--success); width: auto; padding: 5px 15px; font-size: 0.8rem; margin: 0; margin-left: 5px; }
        img.prev { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; margin-left: 10px; vertical-align: middle; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f0eeff; color: var(--main); }

        #ansGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
        .ans-item { display: flex; flex-direction: column; align-items: center; background: #f8f9fa; padding: 5px; border-radius: 8px; }
        
        #loadingOverlay { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fas fa-user-shield fa-spin fa-3x" style="color:var(--main)"></i>
        <p id="loadingText" style="margin-top:15px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...</p>
    </div>

    <div id="adminDashboard">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ms. Mona ğŸ’</h1>
            <button onclick="window.location.href='index.html'" style="width:auto; background:#636e72; padding:5px 15px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹</button>
        </div>

        <div class="tab-menu">
            <button onclick="showTab('coursesTab', this)" class="active">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</button>
            <button onclick="showTab('examsTab', this)">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
            <button onclick="showTab('resultsTab', this)">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            <button onclick="showTab('reviewsTab', this)">Ø§Ù„Ø¢Ø±Ø§Ø¡</button>
        </div>

        <div id="coursesTab" class="tab-content">
            <div class="card">
                <h2>1. Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯</h2>
                <input type="text" id="courseName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³ (Ù…Ø«Ø§Ù„: Unit 1)">
                <label style="font-size: 0.9rem; font-weight: bold;">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ±Ø³:</label>
                <input type="file" id="courseImgFile" accept="image/*">
                <button onclick="createNewCourse()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³</button>
            </div>
            <div class="card">
                <h2>2. Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                <div id="coursesListAdmin"></div>
            </div>
            <div class="card">
                <h2>3. Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ÙƒÙˆØ±Ø³</h2>
                <select id="targetCourseSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³...</option></select>
                <input type="text" id="videoTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
                <input type="text" id="videoLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨">
                <button onclick="addVideoToCourse()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
            </div>
        </div>

        <div id="examsTab" class="tab-content" style="display:none;">
            <div class="card">
                <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† PDF</h2>
                <select id="quizFolderSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³...</option></select>
                <input type="text" id="quizName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†">
                <input type="file" id="pdfFile" accept=".pdf">
                <input type="number" id="qTotal" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©" oninput="generateAnsGrid()">
                <div id="ansGrid"></div>
                <button onclick="saveFullQuiz()" style="background:var(--dark);">âœ… Ù†Ø´Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
            </div>
        </div>

        <div id="resultsTab" class="tab-content" style="display:none;">
            <div class="card">
                <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                <table>
                    <thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                    <tbody id="resultsList"></tbody>
                </table>
            </div>
        </div>

        <div id="reviewsTab" class="tab-content" style="display:none;">
            <div class="card">
                <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¢Ø±Ø§Ø¡</h2>
                <div id="reviewsListAdmin"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KQAQgu4nIiomoDpoTLnBz_uAtab63sY",
            databaseURL: "https://monaacademy-cd983-default-rtdb.firebaseio.com",
            projectId: "monaacademy-cd983",
            storageBucket: "monaacademy-cd983.appspot.com",
            appId: "1:410646694761:web:bea49c51d3b0ff5eb9cbf8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const loading = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // --- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© (Ø§Ù„Ø·Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ) ---
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === "mrsmonakamel6@gmail.com") {
                // Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„
                loading.style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadData();
            } else {
                // ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ - Ø·Ø±Ø¯
                alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© ÙÙ‚Ø·. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.");
                window.location.href = "index.html";
            }
        });

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        function loadData() {
            // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
            onValue(ref(db, 'folders'), (snap) => {
                const sQ = document.getElementById('quizFolderSelect'), 
                      sT = document.getElementById('targetCourseSelect'), 
                      list = document.getElementById('coursesListAdmin');
                sQ.innerHTML = sT.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆØ±Ø³...</option>'; 
                list.innerHTML = "";
                snap.forEach(c => {
                    const d = c.val();
                    sQ.innerHTML += `<option value="${c.key}">${d.name}</option>`;
                    sT.innerHTML += `<option value="${c.key}">${d.name}</option>`;
                    list.innerHTML += `
                    <div class="list-item">
                        <div><img src="${d.img || 'mona.jpg'}" class="prev" onerror="this.src='mona.jpg'">${d.name}</div>
                        <div>
                            <button class="edit-btn" style="background:#f1c40f;" onclick="editCourseName('${c.key}', '${d.name}')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="delete-btn" onclick="del('folders/${c.key}')">Ø­Ø°Ù</button>
                        </div>
                    </div>`;
                });
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            onValue(ref(db, 'results'), (snap) => {
                const list = document.getElementById('resultsList'); list.innerHTML = "";
                snap.forEach(c => {
                    const d = c.val();
                    list.innerHTML += `<tr><td>${d.student}</td><td>${d.exam}</td><td>${d.score}%</td><td>${d.date}</td></tr>`;
                });
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ø±Ø§Ø¡
            onValue(ref(db, 'reviews'), (snap) => {
                const list = document.getElementById('reviewsListAdmin'); list.innerHTML = "";
                snap.forEach(c => {
                    list.innerHTML += `<div class="list-item"><div><strong>${c.val().student}:</strong> ${c.val().text}</div><button class="delete-btn" onclick="del('reviews/${c.key}')">Ø­Ø°Ù</button></div>`;
                });
            });
        }

        window.createNewCourse = async () => {
            const name = document.getElementById('courseName').value.trim();
            const imgFile = document.getElementById('courseImgFile').files[0];
            if(!name || !imgFile) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³ ÙˆØ§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©");
            
            loading.style.display = 'flex';
            loadingText.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³...";
            try {
                const imgBase64 = await toBase64(imgFile);
                await push(ref(db, 'folders'), { name: name, img: imgBase64 });
                alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­");
                document.getElementById('courseName').value = "";
                document.getElementById('courseImgFile').value = "";
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
            finally { loading.style.display = 'none'; }
        };

        window.editCourseName = async (id, oldName) => {
            const newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙƒÙˆØ±Ø³:", oldName);
            const changeImg = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ±Ø³ Ø£ÙŠØ¶Ø§Ù‹ØŸ");
            let updateData = {};
            if(newName && newName.trim() !== "") updateData.name = newName.trim();

            if(changeImg) {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = async () => {
                    loading.style.display = 'flex';
                    const newImg = await toBase64(fileInput.files[0]);
                    updateData.img = newImg;
                    await update(ref(db, `folders/${id}`), updateData);
                    loading.style.display = 'none';
                    alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­");
                };
                fileInput.click();
            } else if (updateData.name) {
                await update(ref(db, `folders/${id}`), updateData);
                alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­");
            }
        };

        window.generateAnsGrid = () => {
            const num = document.getElementById('qTotal').value;
            const grid = document.getElementById('ansGrid'); grid.innerHTML = "";
            for(let i=1; i<=num; i++) grid.innerHTML += `
                <div class="ans-item">
                    <span>${i}</span>
                    <select class="pdf-val">
                        <option value="A">A</option><option value="B">B</option>
                        <option value="C">C</option><option value="D">D</option>
                    </select>
                </div>`;
        };

        window.saveFullQuiz = async () => {
            const fId = document.getElementById('quizFolderSelect').value, name = document.getElementById('quizName').value, pdfFile = document.getElementById('pdfFile').files[0];
            if(!fId || !name || !pdfFile) return alert("Ø§ÙƒÙ…Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            loading.style.display = 'flex';
            loadingText.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ù…Ù„Ù PDF...";
            try {
                const r = sRef(storage, `exams/${Date.now()}_${pdfFile.name}`);
                await uploadBytes(r, pdfFile);
                const url = await getDownloadURL(r);
                await push(ref(db, `quizzes/${fId}`), { 
                    name, 
                    pdfUrl: url, 
                    type: "pdf", 
                    questions: document.getElementById('qTotal').value,
                    answers: Array.from(document.querySelectorAll('.pdf-val')).map(s => s.value) 
                });
                alert("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
                location.reload();
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹"); }
            finally { loading.style.display = 'none'; }
        };

        window.addVideoToCourse = () => {
            const id = document.getElementById('targetCourseSelect').value, title = document.getElementById('videoTitle').value, link = document.getElementById('videoLink').value;
            if(id && title && link) push(ref(db, `folders/${id}/videos`), { title, link }).then(() => { 
                alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"); 
                document.getElementById('videoTitle').value = ""; 
                document.getElementById('videoLink').value = ""; 
            });
        };

        window.showTab = (id, btn) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.tab-menu button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };
        
        window.del = (p) => confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ") && remove(ref(db, p));
    </script>
</body>
</html>
